<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <script src="./train-data.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸­å›½é“è·¯12306 - å®˜æ–¹è´­ç¥¨å¹³å°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft Yahei", sans-serif;
    }

    /* å…¨å±€æ ·å¼ - è°ƒæ•´é¡µé¢é—´è·å’ŒèƒŒæ™¯ */
    body {
      background-color: #f5f5f5;
      padding: 20px 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }

    /* é¡¶éƒ¨å¯¼èˆªæ  - ä¼˜åŒ–å¸ƒå±€å’Œé€‚é… */
    .header {
      background-color: #fff;
      border-bottom: 2px solid #d92121; /* å¢åŠ çº¢è‰²ä¸‹è¾¹æ¡†ï¼Œè´´è¿‘å®˜æ–¹é£æ ¼ */
      margin-bottom: 30px;
    }
    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
    }
    .logo {
      font-size: 28px;
      color: #d92121;
      font-weight: bold;
    }
    .nav {
      display: flex;
      gap: 30px;
    }
    .nav-item {
      text-decoration: none;
      color: #333;
      font-size: 16px;
      padding: 5px 0;
      cursor: pointer;
      position: relative;
    }
    .nav-item.active {
      color: #d92121;
    }
    .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: #d92121;
    }
    .user-info {
      color: #666;
      font-size: 14px;
    }

    /* é¡µé¢å®¹å™¨ - è°ƒæ•´å¡ç‰‡æ ·å¼å’Œä½ç½® */
    .page-container {
      min-height: 500px;
    }
    .page {
      display: none;
      background-color: #fff;
      border-radius: 4px; /* å®˜æ–¹å¡ç‰‡åœ†è§’æ›´å° */
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .page.active {
      display: block;
    }
    .page-title {
      font-size: 20px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    /* 1. è½¦ç¥¨é¢„è®¢é¡µé¢ - æ ¸å¿ƒå¸ƒå±€ä¼˜åŒ– */
    .search-form {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px 15px; /* è°ƒæ•´è¡Œåˆ—é—´è· */
      margin-bottom: 20px;
    }
    .form-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .form-item label {
      font-size: 14px;
      color: #666;
    }
    .form-item input, .form-item select {
      height: 40px;
      padding: 0 10px;
      border: 1px solid #ccc;
      border-radius: 2px; /* å®˜æ–¹è¾“å…¥æ¡†åœ†è§’æ›´å° */
      font-size: 16px;
    }
    .form-item input:focus, .form-item select:focus {
      outline: none;
      border-color: #d92121;
    }
    .search-btn {
      grid-column: 1 / -1;
      height: 45px;
      background-color: #d92121;
      color: #fff;
      border: none;
      border-radius: 2px;
      font-size: 18px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .search-btn:hover {
      background-color: #b91c1c;
    }
    .train-list {
      margin-top: 20px;
      border: 1px solid #eee; /* ç»™åˆ—è¡¨åŠ è¾¹æ¡†ï¼Œæ›´æ¸…æ™° */
      border-radius: 4px;
    }
    .list-header {
      display: grid;
      grid-template-columns: 1fr 2fr 2fr 1fr 1fr 1fr 1fr;
      background-color: #f8f8f8;
      padding: 10px;
      font-weight: bold;
      color: #333;
      border-bottom: 1px solid #eee;
    }
    .train-item {
      display: grid;
      grid-template-columns: 1fr 2fr 2fr 1fr 1fr 1fr 1fr;
      padding: 15px 10px;
      border-bottom: 1px solid #eee;
      align-items: center;
    }
    .train-item:hover {
      background-color: #fafafa;
    }
    /* å°†æœ€åä¸€åˆ—ï¼ˆæ“ä½œï¼‰å†…å®¹é å³å¯¹é½ï¼ŒæŒ‰é’®é å³å¹¶å¢åŠ å³ä¾§é—´è· */
    .list-header > div:last-child {
      text-align: right;
      padding-right: 22px;
    }
    .train-item > div:last-child {
      justify-self: end;
      padding-right: 12px;
    }
    .train-number {
      font-weight: bold;
      color: #d92121;
    }
    .ticket-btn {
      padding: 8px 14px;
      background: linear-gradient(180deg,#ff4b4b,#d92121);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 6px 18px rgba(217,33,33,0.18);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .ticket-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 26px rgba(217,33,33,0.22);
    }
    .empty-state {
      text-align: center;
      padding: 50px;
      color: #999;
      font-size: 16px;
    }

    /* 2. è®¢å•æŸ¥è¯¢é¡µé¢ï¼ˆå¤ç”¨éƒ¨åˆ†æ ·å¼ï¼‰ */
    .order-search-form {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px 15px;
      margin-bottom: 20px;
    }
    .order-list {
      margin-top: 20px;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    .order-header {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr;
      background-color: #f8f8f8;
      padding: 10px;
      font-weight: bold;
      color: #333;
      border-bottom: 1px solid #eee;
    }
    .order-item {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr;
      padding: 15px 10px;
      border-bottom: 1px solid #eee;
      align-items: center;
    }
    .order-item:hover {
      background-color: #fafafa;
    }
    .order-status {
      color: #d92121;
      font-weight: bold;
    }
    .order-btn {
      padding: 3px 8px;
      border: 1px solid #d92121;
      color: #d92121;
      background-color: #fff;
      border-radius: 2px;
      cursor: pointer;
      font-size: 12px;
    }
    .order-btn:hover {
      background-color: #fef0f0;
    }

    /* 3. æˆ‘çš„12306é¡µé¢ï¼ˆå¤ç”¨éƒ¨åˆ†æ ·å¼ï¼‰ */
    .user-center {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 20px;
    }
    .user-sidebar {
      background-color: #f8f8f8;
      border-radius: 4px;
      padding: 20px;
    }
    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-color: #d92121;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 30px;
    }
    .user-avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; display:block; }
    /* Avatar upload controls */
    #avatarInput { display: none; }
    .avatar-controls { display:flex; gap:8px; align-items:center; }
    .avatar-upload-btn { background: linear-gradient(180deg,#1976d2,#0d47a1); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; box-shadow:0 8px 18px rgba(13,71,161,0.12); }
    .avatar-upload-btn:hover { transform: translateY(-2px); }
    .avatar-remove-btn { background:#fff; border:1px solid #e0e0e0; padding:8px 12px; border-radius:8px; color:#d92121; cursor:pointer; }
    .avatar-preview-small { width:40px; height:40px; border-radius:50%; overflow:hidden; border:1px solid #eee; display:inline-block; }
    .user-name {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .user-menu {
      list-style: none;
    }
    .user-menu-item {
      padding: 10px 0;
      color: #333;
      cursor: pointer;
      border-left: 2px solid transparent;
      padding-left: 10px;
    }
    .user-menu-item.active {
      color: #d92121;
      border-left: 2px solid #d92121;
      background-color: #fff;
    }
    .user-content {
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    /* åœ¨ä¸ªäººä¸­å¿ƒçš„å¡ç‰‡ä¹‹é—´å¢åŠ ç©ºè¡Œæ•ˆæœ */
    .user-panel { margin-bottom: 24px; }
    .passenger-list {
      margin-top: 20px;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    .passenger-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
      padding: 15px 10px;
      border-bottom: 1px solid #eee;
      align-items: center;
    }
    .passenger-header {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
      background-color: #f8f8f8;
      padding: 10px;
      font-weight: bold;
      color: #333;
      border-bottom: 1px solid #eee;
    }

    /* 4. è´­ç¥¨æŒ‡å—é¡µé¢ï¼ˆå¤ç”¨éƒ¨åˆ†æ ·å¼ï¼‰ */
    .guide-content {
      line-height: 2;
      color: #666;
    }
    .guide-section {
      margin-bottom: 30px;
    }
    .guide-section h3 {
      color: #d92121;
      margin-bottom: 10px;
      font-size: 18px;
    }
    .guide-section ul {
      padding-left: 20px;
    }


    /* ========== æ ¸å¿ƒï¼šåª’ä½“æŸ¥è¯¢ï¼ˆå“åº”å¼é€‚é…ï¼‰ ========== */
    /* å¹³æ¿å±å¹•ï¼ˆâ‰¤992pxï¼‰ */
    @media (max-width: 992px) {
      .header-inner {
        flex-direction: column;
        gap: 10px;
      }
      .nav {
        gap: 20px;
      }
      .user-center {
        grid-template-columns: 150px 1fr;
      }
    }

    /* æ‰‹æœºå¤§å±å¹•ï¼ˆâ‰¤768pxï¼‰ */
    @media (max-width: 768px) {
      /* å¯¼èˆªæ æ”¹ä¸ºçºµå‘ */
      .nav {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      /* æŸ¥è¯¢è¡¨å•æ”¹ä¸º2åˆ— */
      .search-form, .order-search-form {
        grid-template-columns: 1fr 1fr;
      }
      /* è½¦æ¬¡/è®¢å•åˆ—è¡¨éšè—æ¬¡è¦åˆ— */
      .list-header, .train-item {
        grid-template-columns: 1fr 1fr 1fr;
        gap: 5px;
      }
      .order-header, .order-item {
        grid-template-columns: 1fr 1fr 1fr;
        gap: 5px;
      }
      /* éšè—çš„åˆ— */
      .list-header > div:nth-child(4), .list-header > div:nth-child(5), 
      .list-header > div:nth-child(6), .list-header > div:nth-child(7),
      .train-item > div:nth-child(4), .train-item > div:nth-child(5), 
      .train-item > div:nth-child(6), .train-item > div:nth-child(7),
      .order-header > div:nth-child(4), .order-header > div:nth-child(5), 
      .order-header > div:nth-child(6),
      .order-item > div:nth-child(4), .order-item > div:nth-child(5), 
      .order-item > div:nth-child(6) {
        display: none;
      }
      /* ä¸ªäººä¸­å¿ƒæ”¹ä¸ºçºµå‘ */
      .user-center {
        grid-template-columns: 1fr;
      }
    }

    /* æ‰‹æœºå°å±å¹•ï¼ˆâ‰¤576pxï¼‰ */
    @media (max-width: 576px) {
      /* æŸ¥è¯¢è¡¨å•æ”¹ä¸º1åˆ— */
      .search-form, .order-search-form {
        grid-template-columns: 1fr;
      }
      /* åˆ—è¡¨å¤´éƒ¨æ–‡å­—ç¼©å° */
      .list-header, .order-header, .passenger-header {
        font-size: 14px;
      }
      /* è½¦æ¬¡/è®¢å•é¡¹æ–‡å­—ç¼©å° */
      .train-item, .order-item, .passenger-item {
        font-size: 14px;
      }
    }
    /* è®¢ç¥¨å¼¹çª—ç¾åŒ–æ ·å¼ */
    .modal-backdrop {
      position: fixed; left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.45); z-index: 2500; display: none;
    }
    #bookingModal {
      width: 480px; max-width: calc(100% - 40px); border-radius: 10px;
      padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.25);
    }
    #bookingTrainInfo { font-weight:600; color:#222; background:#fff7f7; padding:8px 10px; border-radius:6px; border:1px solid #ffecec; }
    .payment-options label { cursor:pointer; padding:6px 10px; border-radius:6px; border:1px solid #eee; background:#fafafa; }
    .payment-options input { margin-right:6px; }
    /* Apple Pay å›¾æ ‡æ”¾å¤§æ ·å¼ */
    .pay-icon.apple { font-size: 24px; margin-right: 6px; vertical-align: middle; display: inline-block; }
    /* æ”¯ä»˜ç»‘å®šå¡ç‰‡æ ·å¼ç¾åŒ– */
    #boundList > div, #unboundList > div {
      padding: 12px; border-radius: 8px; margin-bottom: 10px; display:flex; align-items:center; justify-content:space-between; box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    }
    #boundList > div { border: 1px solid rgba(0,0,0,0.06); background: linear-gradient(180deg,#ffffff,#fbfffe); }
    #unboundList > div { border: 1px dashed rgba(0,0,0,0.04); background: #fcfdff; }
    #boundList .unbind-btn { background:#fff; border:1px solid #d92121; color:#d92121; padding:6px 10px; border-radius:8px; }
    #unboundList .bind-btn { background: linear-gradient(180deg,#1976d2,#0d47a1); color:#fff; border:none; padding:8px 12px; border-radius:8px; }
    #boundList div .meta { color:#666; font-size:13px; margin-top:4px; }
    /* ç»‘å®š/è§£ç»‘æŒ‰é’®ç¾åŒ– */
    .bind-btn {
      background: linear-gradient(180deg,#00c853,#009624);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(0,200,83,0.14);
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .bind-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 26px rgba(0,200,83,0.18); }
    .unbind-btn {
      background: #fff;
      color: #d92121;
      border: 1px solid #d92121;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: background .12s ease, color .12s ease;
    }
    .unbind-btn:hover { background: #fff6f6; }
    /* æ”¯ä»˜ç»‘å®šå¡ç‰‡ç¾åŒ– */
    #boundList > div, #unboundList > div { padding: 10px; border-radius: 8px; }
    #boundList > div { border: 1px solid #e8f5e9; background: linear-gradient(180deg,#f9fff9,#ffffff); }
    #unboundList > div { border: 1px dashed #eee; background: #fafafa; }
    #bookingConfirmBtn { background: linear-gradient(180deg,#2e7d32,#1b5e20); color:#fff; border-radius:6px; padding:8px 14px; box-shadow:0 8px 18px rgba(30,100,40,0.18); }
    /* é“¶è¡Œé€‰æ‹©æŒ‰é’®æ ·å¼ */
    .bank-btn { padding:8px 10px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .bank-btn.selected { background:#1976d2; color:#fff; border-color:#1565c0; box-shadow:0 6px 14px rgba(21,101,192,0.12); }
    /* Apple ç»‘å®šæ¨¡æ€æ ·å¼å°ä¼˜åŒ– */
    #appleBindModal { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    /* Apple é£æ ¼æˆæƒæŒ‰é’® */
    .apple-auth-btn { background:#000; color:#fff; padding:10px 16px; border-radius:12px; border:none; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,0.18); cursor:pointer; }
    .apple-auth-btn:hover { opacity:0.95; }
    /* è§£ç»‘ç¡®è®¤æ¨¡æ€æ ·å¼ */
    #unbindConfirmModal { display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:360px; background:#fff; padding:18px; border-radius:10px; box-shadow:0 20px 40px rgba(0,0,0,0.2); z-index:3800; text-align:center; }
    #unbindConfirmModal .confirm-btn { background:#d92121; color:#fff; padding:8px 12px; border-radius:8px; border:none; }
    #unbindConfirmModal .cancel-btn { background:#fff; color:#333; border:1px solid #ddd; padding:6px 10px; border-radius:8px; }
    #bookingCancelBtn { padding:7px 12px; border-radius:6px; }
    @media (max-width: 600px) {
      #bookingModal { width: 92%; padding:12px; }
      .ticket-btn { padding: 6px 10px; font-size:13px; }
    }
    /* è°ƒæ•´å¸­åˆ«é€‰æ‹©æ¯”ä¾‹ä¸å­—ä½“ï¼Œä½¿é€‰é¡¹æ¯”ä¾‹æ›´åˆç†ã€å ä½ä¸ºç°è‰²ä¸å¯é€‰ */
    #booking_seat_select {
      display: inline-block;
      transform: scaleX(1) scaleY(1.3);
      transform-origin: left center;
      height: 42px;
      width: 100%;
      font-size: 20px;
      line-height: 1.2;
      padding: 6px 8px;
    }
    @media (max-width: 600px) {
      /* å°å±å¹•ä¸Šå›é€€åˆ°æ›´ä¿å®ˆçš„ç¼©æ”¾ï¼Œé˜²æ­¢å¸ƒå±€é”™ä½ */
      #booking_seat_select { transform: scaleX(1) scaleY(1.2); font-size:18px; height:40px; }
    }
    /* å¼ºåˆ¶ option å­—ä½“å¤§å°ä¸å ä½è‰²ï¼ˆéƒ¨åˆ†æµè§ˆå™¨éœ€å¦‚æ­¤ï¼‰ */
    #booking_seat_select option { font-size: 20px; color: #333; }
    #booking_seat_select option[disabled] { color: #999; }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª
  <div class="header">
    <div class="container header-inner">
      <div class="logo">ä¸­å›½é“è·¯12306</div>
      <div class="nav">
      <div class="nav-item active" data-page="ticket-page">è½¦ç¥¨é¢„è®¢</div>
      <div class="nav-item" data-page="order-page">è®¢å•æŸ¥è¯¢</div>
      <div class="nav-item" data-page="user-page">æˆ‘çš„12306</div>
      <div class="nav-item" data-page="payment-page">æ”¯ä»˜ç»‘å®š</div>
      <div class="nav-item" data-page="guide-page">è´­ç¥¨æŒ‡å—</div>
    </div>
      <div class="user-info">æœªç™»å½• | è¯·ç™»å½•</div>
    </div>
  </div> -->

  <!-- é¡¶éƒ¨å¯¼èˆªï¼ˆä¿®æ”¹user-infoéƒ¨åˆ†ï¼‰ -->
<div class="header">
  <div class="container header-inner">
    <div class="logo">ä¸­å›½é“è·¯12306</div>
    <div class="nav">
      <div class="nav-item active" data-page="ticket-page">è½¦ç¥¨é¢„è®¢</div>
      <div class="nav-item" data-page="order-page">è®¢å•æŸ¥è¯¢</div>
      <div class="nav-item" data-page="user-page">æˆ‘çš„12306</div>
      <div class="nav-item" data-page="payment-page">æ”¯ä»˜ç»‘å®š</div>
      <div class="nav-item" data-page="guide-page">è´­ç¥¨æŒ‡å—</div>
    </div>
    <!-- ä¿®æ”¹ä¸ºå¯ç‚¹å‡»çš„ç™»å½•æŒ‰é’® -->
    <div class="user-info">
      <span id="loginLink" style="color: #d92121; cursor: pointer; font-weight: bold;">è¯·ç™»å½•</span>
    </div>
            </div>
            <!-- ç»‘å®šï¼šApple æˆæƒæ¨¡æ€ -->
            <div id="appleBindModal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:360px; background:linear-gradient(180deg,#f6f6f8,#ffffff); padding:18px; border-radius:16px; box-shadow:0 30px 60px rgba(0,0,0,0.22); z-index:3700; text-align:center; border:1px solid rgba(0,0,0,0.06);">
              <div style="font-size:44px; font-weight:700; color:#000; margin-bottom:6px;">ï£¿</div>
              <div style="font-size:20px; font-weight:700;">ä½¿ç”¨ Apple ID æˆæƒ</div>
              <div style="color:#666; margin-top:8px;">å°† Apple Pay ä¸æ­¤è®¾å¤‡å…³è”ä»¥ä¾¿å¿«é€Ÿæ”¯ä»˜ã€‚ç‚¹å‡»â€œæˆæƒå¹¶ç»‘å®šâ€ç»§ç»­ã€‚</div>
              <div style="margin-top:18px; display:flex; gap:10px; justify-content:center;">
                <button id="appleBindConfirm" class="apple-auth-btn">æˆæƒå¹¶ç»‘å®š</button>
                <button id="appleBindCancel" class="order-btn">å–æ¶ˆ</button>
              </div>
            </div>

            <!-- ç»‘å®šï¼šé“¶è”ç»‘å®šæ¨¡æ€ï¼ˆé“¶è¡Œé€‰æ‹©åœ¨ä¸Šæ–¹ï¼Œä½¿ç”¨æŒ‰é’®ï¼‰ -->
            <div id="unionBindModal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:420px; background:#fff; padding:18px; border-radius:10px; box-shadow:0 20px 40px rgba(0,0,0,0.18); z-index:3700; text-align:left;">
              <h4 style="margin:0 0 8px 0;">ç»‘å®šé“¶è¡Œå¡ï¼ˆé“¶è”ï¼‰</h4>
              <div style="color:#666; font-size:13px; margin-bottom:8px;">è¯·é€‰æ‹©å¼€æˆ·é“¶è¡Œ</div>
              <div id="unionBanks" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
                <button class="bank-btn" data-bank="ä¸­å›½é“¶è¡Œ">ä¸­å›½é“¶è¡Œ</button>
                <button class="bank-btn" data-bank="æµ¦å‘é“¶è¡Œ">æµ¦å‘é“¶è¡Œ</button>
                <button class="bank-btn" data-bank="å·¥å•†é“¶è¡Œ">å·¥å•†é“¶è¡Œ</button>
                <button class="bank-btn" data-bank="å»ºè®¾é“¶è¡Œ">å»ºè®¾é“¶è¡Œ</button>
                <button class="bank-btn" data-bank="æ‹›å•†é“¶è¡Œ">æ‹›å•†é“¶è¡Œ</button>
                <button class="bank-btn" data-bank="å…¶ä»–é“¶è¡Œ">å…¶ä»–é“¶è¡Œ</button>
              </div>
              <div id="unionOtherBankWrap" style="display:none; margin-bottom:8px;"><label style="display:block; color:#666; font-size:13px;">è¯·å¡«å†™é“¶è¡Œåç§°</label><input id="unionOtherBank" placeholder="è¯·è¾“å…¥é“¶è¡Œåç§°" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;" /></div>
              <div style="margin-bottom:8px;"><label style="display:block; color:#666; font-size:13px;">å¡å·</label><input id="unionBindCard" placeholder="è¯·è¾“å…¥é“¶è¡Œå¡å·" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;" /></div>
              <div style="margin-bottom:8px;"><label style="display:block; color:#666; font-size:13px;">è¯·è¾“å…¥é“¶è¡Œå¡å¯†ç </label><input id="unionBindPwd" placeholder="é“¶è¡Œå¡æ”¯ä»˜å¯†ç " type="password" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;" /></div>
              <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
                <button id="unionBindConfirm" class="order-btn">ç»‘å®šå¹¶ä¿å­˜</button>
                <button id="unionBindCancel" class="order-btn">å–æ¶ˆ</button>
              </div>
            </div>
            <!-- è§£ç»‘ç¡®è®¤æ¨¡æ€ -->
            <div id="unbindConfirmModal">
              <div style="font-size:16px; font-weight:600; margin-bottom:8px;">ç¡®è®¤è§£ç»‘</div>
              <div id="unbindConfirmMsg" style="color:#666; margin-bottom:12px;">ç¡®å®šè¦è§£ç»‘è¯¥æ”¯ä»˜æ–¹å¼å—ï¼Ÿ</div>
              <div style="display:flex; gap:8px; justify-content:center;">
                <button id="unbindConfirmBtn" class="confirm-btn">ç¡®è®¤è§£ç»‘</button>
                <button id="unbindCancelBtn" class="cancel-btn">å–æ¶ˆ</button>
              </div>
            </div>
            <!-- è®¢ç¥¨å¼¹çª—ï¼šé€‰æ‹©å¸­åˆ«ä¸æ”¯ä»˜æ–¹å¼ -->
            <div id="bookingBackdrop" class="modal-backdrop"></div>
            <div id="bookingModal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(1.0); transform-origin:center; background:#fff; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,0.25); border-radius:8px; z-index:3000; width:70%; max-width:480px;">
              <h4 style="margin-bottom:10px;">ç¡®è®¤é¢„è®¢</h4>
              <div style="display:flex; flex-direction:column; gap:10px;">
                <div id="bookingTrainInfo" style="color:#333; font-size:14px;"></div>
                  <div id="bookingWaitHint" style="color:#d92121; font-size:13px; margin-top:6px; display:none;">å€™è¡¥è®¢å•æ— éœ€ç«‹å³åœ¨çº¿æ”¯ä»˜ï¼Œè¯·ç­‰å¾…æœ‰ç¥¨åç³»ç»Ÿé€šçŸ¥æ‚¨ç»§ç»­æ”¯ä»˜ã€‚</div>
                <label style="display:flex; justify-content:space-between; align-items:center;">
                  <span>é€‰æ‹©å¸­åˆ«</span>
                </label>
                <select id="booking_seat_select" style="height:40px; padding:0 12px; font-size:14px; width:100%; border-radius:6px;">
                  <option value="" disabled selected>è¯·é€‰æ‹©å¸­åˆ«</option>
                  <option value="ä¸€ç­‰åº§">ä¸€ç­‰åº§</option>
                  <option value="äºŒç­‰åº§">äºŒç­‰åº§</option>
                </select>
                <label>ä¹˜å®¢</label>
                <select id="booking_passenger_select" style="height:36px; padding:0 10px; font-size:14px; width:100%; border-radius:6px;">
                  <option value="" disabled selected>è¯·é€‰æ‹©ä¹˜å®¢ï¼ˆæœ¬äººæˆ–å¸¸ç”¨ä¹˜è½¦äººï¼‰</option>
                </select>
                <label>æ”¯ä»˜æ–¹å¼</label>
                <div class="payment-options" style="display:flex; gap:10px; flex-wrap:wrap;">
                  <label><input type="radio" name="booking_payment" value="wechat" checked> ğŸŸ¢ å¾®ä¿¡æ”¯ä»˜</label>
                  <label><input type="radio" name="booking_payment" value="alipay"> ğŸ”µ æ”¯ä»˜å®</label>
                  <label><input type="radio" name="booking_payment" value="apple_pay"> <span class="pay-icon apple">ï£¿</span> Apple Pay</label>
                  <label><input type="radio" name="booking_payment" value="unionpay"> ğŸ”´ é“¶è”</label>
                  <label><input type="radio" name="booking_payment" value="other"> âšª å…¶ä»–</label>
                </div>
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
                  <button id="bookingCancelBtn" class="order-btn" style="background:#fff; color:#d92121;">å–æ¶ˆ</button>
                  <button id="bookingConfirmBtn" class="search-btn">ç¡®è®¤å¹¶æ”¯ä»˜</button>
                </div>
              </div>
            </div>
            <div id="paymentBackdrop" class="modal-backdrop" style="display:none;"></div>
            <!-- æ”¯ä»˜äºŒç»´ç æ¨¡æ€ï¼ˆå¾®ä¿¡/æ”¯ä»˜å®ï¼‰ -->
            <div id="qrPaymentModal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; padding:18px; box-shadow:0 20px 40px rgba(0,0,0,0.25); border-radius:8px; z-index:3600; width:320px; text-align:center;">
              <h4 id="qrPaymentTitle">æ‰«ç æ”¯ä»˜</h4>
              <div id="qrBox" style="width:220px; height:220px; margin:12px auto; display:flex; align-items:center; justify-content:center; border:4px solid #4caf50; border-radius:8px;">
                <div id="qrPlaceholder" style="font-size:14px; color:#666;">[äºŒç»´ç ]</div>
              </div>
              <div style="margin-top:8px;">è¯·ä½¿ç”¨å¯¹åº”åº”ç”¨æ‰«ç æ”¯ä»˜ Â¥<span id="qrPrice">0.00</span></div>
              <div style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
                <button id="qrPaidBtn" class="bind-btn">æˆ‘å·²å®Œæˆæ”¯ä»˜</button>
                <button id="qrCancelBtn" class="order-btn">å–æ¶ˆ</button>
              </div>
            </div>

            <!-- Apple Pay æ¨¡æ‹Ÿæ¨¡æ€ -->
            <div id="applePayModal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#f8f8f8; padding:18px; box-shadow:0 20px 40px rgba(0,0,0,0.25); border-radius:12px; z-index:3600; width:360px; text-align:center;">
              <h4 style="margin:0 0 8px 0;">Apple Pay</h4>
              <div style="background:#fff; padding:14px; border-radius:8px;">
                <div style="font-size:18px; font-weight:600;">ä½¿ç”¨ Apple Pay æ”¯ä»˜</div>
                <div style="color:#666; margin-top:8px;">è¯·ä½¿ç”¨æ‚¨çš„è®¾å¤‡å®ŒæˆæŒ‡çº¹/é¢å®¹éªŒè¯ä»¥æ”¯ä»˜ Â¥<span id="applePayPrice">0.00</span></div>
                <div style="margin-top:12px;"> 
                  <button id="appleConfirmBtn" class="bind-btn">éªŒè¯å¹¶æ”¯ä»˜</button>
                  <button id="appleCancelBtn" class="order-btn">å–æ¶ˆ</button>
                </div>
              </div>
            </div>

            <!-- é“¶è”é“¶è¡Œå¡å¯†ç æ¨¡æ€ï¼ˆç”¨äºæ”¯ä»˜ï¼‰ -->
            <div id="unionPayModal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; padding:18px; box-shadow:0 20px 40px rgba(0,0,0,0.25); border-radius:8px; z-index:3600; width:360px; text-align:left;">
              <h4 style="margin-bottom:8px;">é“¶è”æ”¯ä»˜</h4>
              <div style="margin-bottom:8px;">å¡å·ï¼š<span id="unionCardNo">5773882334</span></div>
              <div style="margin-bottom:8px;"><label>è¯·è¾“å…¥é“¶è¡Œå¡æ”¯ä»˜å¯†ç ï¼š <input id="unionPayPwd" type="password" style="padding:6px; width:60%;" /></label></div>
              <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end;">
                <button id="unionConfirmBtn" class="bind-btn">ç¡®è®¤æ”¯ä»˜</button>
                <button id="unionCancelBtn" class="order-btn">å–æ¶ˆ</button>
              </div>
            </div>
</div>

<!-- æ–°å¢è·³è½¬JSï¼ˆæ”¾åœ¨åŸ12306.htmlçš„<script>æ ‡ç­¾é‡Œï¼‰ -->
<script>
  // ç‚¹å‡»â€œè¯·ç™»å½•â€è·³è½¬åˆ°login.html
  document.getElementById('loginLink').addEventListener('click', function() {
    window.location.href = './login.html'; // è·³è½¬åˆ°frontendä¸‹çš„login.html
  });
</script>
<script>
  // ä½¿ç”¨ç½‘ç»œæ—¶é—´è®¾ç½®å‡ºå‘æ—¥æœŸï¼ˆä¼˜å…ˆä½¿ç”¨ worldtimeapi.orgï¼‰ï¼Œå¤±è´¥æ—¶å›é€€åˆ°æœ¬åœ°æ—¶é—´
  document.addEventListener('DOMContentLoaded', async function setNetworkTrainDate(){
    const el = document.getElementById('trainDate');
    if (!el) return;
    // å…ˆä½¿ç”¨æœ¬åœ°æ—¶é—´ç«‹å³å¡«å……ï¼Œé¿å…åç»­éªŒè¯å¤±è´¥æˆ– UI æ˜¾ç¤ºä¸ºå ä½æš—è‰²
    try {
      const now = new Date();
      el.value = now.toISOString().slice(0,10);
    } catch (e) {}
    try {
      const resp = await fetch('https://worldtimeapi.org/api/ip');
      if (!resp.ok) throw new Error('ç½‘ç»œæ—¶é—´è¯·æ±‚å¤±è´¥');
      const j = await resp.json();
      const dt = new Date(j.utc_datetime || j.datetime || (j.unixtime? j.unixtime*1000: undefined));
      if (isNaN(dt)) throw new Error('è§£æç½‘ç»œæ—¶é—´å¤±è´¥');
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const d = String(dt.getDate()).padStart(2,'0');
      el.value = `${y}-${m}-${d}`;
    } catch (e) {
      // å›é€€åˆ°æœ¬åœ°æ—¶é—´
      const now = new Date();
      el.value = now.toISOString().slice(0,10);
    }
  });
</script>
<script>
  // ä½¿ç”¨ç½‘ç»œæ—¶é—´è®¾ç½®è®¢å•æŸ¥è¯¢æ—¥æœŸï¼ˆä¼˜å…ˆç½‘ç»œï¼Œå¤±è´¥å›é€€æœ¬åœ°ï¼‰ï¼Œç«‹å³å¡«å……æœ¬åœ°æ—¶é—´é¿å…ä¸ºç©º
  document.addEventListener('DOMContentLoaded', async function setNetworkOrderDate(){
    const el = document.getElementById('orderDate');
    if (!el) return;
    try { el.value = new Date().toISOString().slice(0,10); } catch(e) {}
    try {
      const resp = await fetch('https://worldtimeapi.org/api/ip');
      if (!resp.ok) throw new Error('ç½‘ç»œæ—¶é—´å¤±è´¥');
      const j = await resp.json();
      const dt = new Date(j.utc_datetime || j.datetime || (j.unixtime? j.unixtime*1000: undefined));
      if (!isNaN(dt)) {
        const y = dt.getFullYear(); const m = String(dt.getMonth()+1).padStart(2,'0'); const d = String(dt.getDate()).padStart(2,'0');
        el.value = `${y}-${m}-${d}`;
      }
    } catch (e) {
      // å·²ç»ä½¿ç”¨æœ¬åœ°æ—¶é—´ä½œä¸ºå›é€€
    }
  });
</script>
    <!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="orderDetailBackdrop" class="modal-backdrop" style="display:none;"></div>
    <div id="orderDetailModal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; padding:18px; box-shadow:0 20px 40px rgba(0,0,0,0.25); border-radius:8px; z-index:3500; width:520px;">
      <h4 style="margin-bottom:10px;">è®¢å•è¯¦æƒ…</h4>
      <div id="orderDetailContent" style="display:flex; flex-direction:column; gap:8px; color:#333;">
        <div><strong>è®¢å•å·ï¼š</strong><span id="od_order_no"></span></div>
        <div><strong>è½¦æ¬¡ï¼š</strong><span id="od_train_no"></span></div>
        <div><strong>è¡Œç¨‹ï¼š</strong><span id="od_route"></span></div>
        <div><strong>å‘è½¦æ—¶é—´ï¼š</strong><span id="od_depart_time"></span></div>
        <div><strong>å¸­åˆ«ï¼š</strong><span id="od_seat_type"></span></div>
        <div><strong>ä»·æ ¼ï¼š</strong>Â¥<span id="od_price"></span></div>
        <div><strong>æ”¯ä»˜æ–¹å¼ï¼š</strong><span id="od_payment"></span></div>
        <div><strong>çŠ¶æ€ï¼š</strong><span id="od_status" style="color:#d92121;"></span></div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
        <button id="orderRePay" class="bind-btn">é‡æ–°æ”¯ä»˜</button>
        <button id="orderRefund" class="unbind-btn">é€€æ¬¾</button>
        <button id="orderCancelWait" class="order-btn" style="display:none; background:#ff8a65; color:#fff;">å–æ¶ˆå€™è¡¥</button>
        <button id="orderDownload" class="order-btn">ä¸‹è½½å‡­è¯</button>
        <button id="orderDetailClose" class="order-btn">å…³é—­</button>
      </div>
    </div>
    <!-- æ”¹ç­¾å¼¹çª— -->
    <div id="rescheduleModal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:2000;">
      <div style="width:420px; background:#fff; padding:18px; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.12);">
        <h3 style="margin:0 0 10px 0;">æ”¹ç­¾è®¢å•</h3>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <div>
            <label>åŸè®¢å•å·ï¼š <span id="res_old_order_no"></span></label>
          </div>
          <div>
            <label>æ–°è½¦æ¬¡/è¡Œç¨‹ï¼ˆè¯·é€‰æ‹©ï¼‰ï¼š</label>
            <div id="res_new_train_list" style="width:100%; padding:6px; display:flex; flex-direction:column; gap:8px; max-height:240px; overflow:auto; border:1px solid #eee; border-radius:6px;"></div>
          </div>
          <div>
            <label>æ–°å‘è½¦æ—¶é—´ï¼š</label>
            <input type="datetime-local" id="res_new_depart" style="width:100%; padding:8px;" />
          </div>
          <div>
            <label>æ–°ç¥¨ä»·ï¼ˆå…ƒï¼‰ï¼š</label>
            <input type="number" id="res_new_price" min="0" step="0.01" style="width:100%; padding:8px;" />
          </div>
          <div>
            <label>å¸­åˆ«ï¼š</label>
            <input type="text" id="res_new_seat" placeholder="ç¡¬åº§/äºŒç­‰åº§ç­‰" style="width:100%; padding:8px;" />
          </div>
          <div id="res_diff_display" style="color:#333; font-weight:600;">å·®ä»·ï¼š-</div>
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button id="resCancelBtn" class="order-btn" style="background:#fff; color:#d92121;">å–æ¶ˆ</button>
            <button id="resConfirmBtn" class="search-btn">ç¡®è®¤æ”¹ç­¾</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      function showOrderDetail(orderNo) {
        const list = window._lastOrders || [];
        const rec = list.find(o => String(o.order_no) === String(orderNo));
        if (!rec) { alert('æœªèƒ½æ‰¾åˆ°è¯¥è®¢å•çš„è¯¦ç»†ä¿¡æ¯'); return; }
        document.getElementById('od_order_no').textContent = rec.order_no || '';
        document.getElementById('od_train_no').textContent = rec.train_no || '';
        document.getElementById('od_route').textContent = (rec.start_city || '') + ' â†’ ' + (rec.end_city || '');
        document.getElementById('od_depart_time').textContent = rec.depart_time || '';
        document.getElementById('od_seat_type').textContent = rec.seat_type || '';
        document.getElementById('od_price').textContent = (Number(rec.price) || 0).toFixed(2);
        document.getElementById('od_payment').textContent = rec.payment_method || '';
        document.getElementById('od_status').textContent = rec.status || '';
          // è‹¥ä¸ºå€™è¡¥è®¢å•ï¼Œåˆ™éšè—/ç¦ç”¨ä¸æ”¯ä»˜ç›¸å…³çš„æ“ä½œæŒ‰é’®
          try {
            const rePayBtn = document.getElementById('orderRePay');
            const refundBtn = document.getElementById('orderRefund');
            if (rec.status === 'waitlist') {
              if (rePayBtn) { rePayBtn.style.display = 'none'; }
              if (refundBtn) { refundBtn.style.display = 'none'; }
              try { document.getElementById('orderCancelWait').style.display = ''; } catch(e) {}
            } else {
              if (rePayBtn) { rePayBtn.style.display = ''; }
              // ä»…å½“å·²æ”¯ä»˜æ—¶æ˜¾ç¤ºé€€æ¬¾æŒ‰é’®
              if (refundBtn) { refundBtn.style.display = (rec.status === 'paid') ? '' : 'none'; }
              try { document.getElementById('orderCancelWait').style.display = 'none'; } catch(e) {}
            }
          } catch (e) {}
          document.getElementById('orderDetailModal').style.display = 'block';
          document.getElementById('orderDetailBackdrop').style.display = 'block';
        document.body.style.overflow = 'hidden';
      }
      document.getElementById('orderDetailClose').addEventListener('click', function(){ document.getElementById('orderDetailModal').style.display='none'; document.getElementById('orderDetailBackdrop').style.display='none'; document.body.style.overflow=''; });
      // ç‚¹é®ç½©ä¹Ÿå…³é—­
      document.getElementById('orderDetailBackdrop').addEventListener('click', function(){ document.getElementById('orderDetailClose').click(); });

      // é‡æ–°æ”¯ä»˜ - å°†è®¢å•æ ‡è®°ä¸º paidï¼ˆè°ƒç”¨åç«¯ï¼‰
      document.getElementById('orderRePay').addEventListener('click', async function(){
        const orderNo = document.getElementById('od_order_no').textContent;
        if (!orderNo) return alert('æ‰¾ä¸åˆ°è®¢å•å·');
        if (!confirm('ç¡®è®¤é‡æ–°æ”¯ä»˜å¹¶å°†è®¢å•æ ‡è®°ä¸ºå·²æ”¯ä»˜å—ï¼Ÿ')) return;
        try {
          const resp = await fetch('http://localhost:3000/api/orders/pay', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_no: orderNo }) });
          const r = await resp.json();
          if (r.code === 0) {
            alert('å·²æ ‡è®°ä¸ºå·²æ”¯ä»˜');
            // æ›´æ–°è¯¦æƒ…æ˜¾ç¤ºä¸åˆ—è¡¨
            document.getElementById('od_status').textContent = r.data.status || 'paid';
            if (typeof loadOrders === 'function') loadOrders();
            // update local cache
            if (window._lastOrders) {
              const idx = window._lastOrders.findIndex(o => String(o.order_no) === String(orderNo));
              if (idx >= 0) window._lastOrders[idx] = r.data;
            }
          } else {
            alert('æ“ä½œå¤±è´¥ï¼š' + (r.msg || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (err) { console.error(err); alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡'); }
      });

      // é€€æ¬¾ - æ— æ¡ä»¶é€€æ¬¾ï¼ˆåç«¯å·²æä¾›æ¥å£ï¼‰
      document.getElementById('orderRefund').addEventListener('click', async function(){
        const orderNo = document.getElementById('od_order_no').textContent;
        if (!orderNo) return alert('æ‰¾ä¸åˆ°è®¢å•å·');
        if (!confirm('ç¡®å®šè¦å¯¹è¯¥è®¢å•å‘èµ·é€€æ¬¾å—ï¼Ÿï¼ˆå½“å‰ä¸ºæ— æ¡ä»¶é€€æ¬¾ï¼‰')) return;
        try {
          const resp = await fetch('http://localhost:3000/api/orders/refund', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_no: orderNo }) });
          const r = await resp.json();
          if (r.code === 0) {
            alert('é€€æ¬¾æˆåŠŸï¼ˆå·²å°†è®¢å•çŠ¶æ€æ›´æ–°ä¸º refundedï¼‰');
            document.getElementById('od_status').textContent = r.data.status || 'refunded';
            if (typeof loadOrders === 'function') loadOrders();
            if (window._lastOrders) {
              const idx = window._lastOrders.findIndex(o => String(o.order_no) === String(orderNo));
              if (idx >= 0) window._lastOrders[idx] = r.data;
            }
          } else {
            alert('é€€æ¬¾å¤±è´¥ï¼š' + (r.msg || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (err) { console.error(err); alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡'); }
      });

      // å–æ¶ˆå€™è¡¥ï¼ˆä»…é’ˆå¯¹ waitlistï¼‰
      document.getElementById('orderCancelWait').addEventListener('click', async function(){
        const orderNo = document.getElementById('od_order_no').textContent;
        if (!orderNo) return alert('æ‰¾ä¸åˆ°è®¢å•å·');
        if (!confirm('ç¡®å®šå–æ¶ˆè¯¥å€™è¡¥è®¢å•å—ï¼Ÿå–æ¶ˆåä¸å¯æ¢å¤ã€‚')) return;
        try {
          const resp = await fetch('http://localhost:3000/api/orders/cancel', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_no: orderNo }) });
          const r = await resp.json();
          if (r.code === 0) {
            alert('å€™è¡¥è®¢å•å·²å–æ¶ˆ');
            document.getElementById('od_status').textContent = r.data.status || 'cancelled';
            // éšè—ç›¸å…³æŒ‰é’®
            try { document.getElementById('orderCancelWait').style.display = 'none'; } catch(e) {}
            if (typeof loadOrders === 'function') loadOrders();
          } else {
            alert('å–æ¶ˆå¤±è´¥ï¼š' + (r.msg || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (err) { console.error(err); alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡'); }
      });

      // ä¸‹è½½å‡­è¯ï¼ˆç”Ÿæˆç®€å•æ–‡æœ¬å¹¶ä¸‹è½½ï¼‰
      document.getElementById('orderDownload').addEventListener('click', function(){
        const orderNo = document.getElementById('od_order_no').textContent || '';
        const trainNo = document.getElementById('od_train_no').textContent || '';
        const route = document.getElementById('od_route').textContent || '';
        const depart = document.getElementById('od_depart_time').textContent || '';
        const seat = document.getElementById('od_seat_type').textContent || '';
        const price = document.getElementById('od_price').textContent || '';
        const payment = document.getElementById('od_payment').textContent || '';
        const status = document.getElementById('od_status').textContent || '';
        const content = `è®¢å•å·ï¼š${orderNo}\nè½¦æ¬¡ï¼š${trainNo}\nè¡Œç¨‹ï¼š${route}\nå‘è½¦æ—¶é—´ï¼š${depart}\nå¸­åˆ«ï¼š${seat}\nä»·æ ¼ï¼šÂ¥${price}\næ”¯ä»˜æ–¹å¼ï¼š${payment}\nçŠ¶æ€ï¼š${status}\n\næ„Ÿè°¢æ‚¨ä½¿ç”¨12306æ¨¡æ‹Ÿç³»ç»Ÿï¼`;
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `order_${orderNo}.txt`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });
    </script>
  <script>
    // æ”¯ä»˜ç»‘å®šé¡µé¢é€»è¾‘ï¼ˆä½¿ç”¨ localStorage æ¨¡æ‹Ÿç»‘å®šçŠ¶æ€ï¼‰
    (function() {
      const methods = ['wechat','alipay','unionpay','apple_pay','other'];
      const displayNames = { wechat:'å¾®ä¿¡æ”¯ä»˜', alipay:'æ”¯ä»˜å®', unionpay:'é“¶è”', apple_pay:'Apple Pay', other:'å…¶ä»–' };
      const displayIcons = { wechat:'ğŸŸ¢', alipay:'ğŸ”µ', unionpay:'ğŸ”´', apple_pay:'<span class="pay-icon apple">ï£¿</span>', other:'âšª' };

      // ä½¿ç”¨æ¨¡æ€è¡¨å•ç»‘å®šæ”¯ä»˜æ–¹å¼ï¼ˆæä¾›æ›´çœŸå®çš„ä½“éªŒï¼‰
      function loadBindings() {
        const raw = localStorage.getItem('paymentBindings');
        let map = {};
        try { map = raw ? JSON.parse(raw) : {}; } catch(e){ map = {}; }
        const boundList = document.getElementById('boundList');
        const unboundList = document.getElementById('unboundList');
        if (!boundList || !unboundList) return;
        boundList.innerHTML = '';
        unboundList.innerHTML = '';
        methods.forEach(m => {
          const info = map[m];
            if (info && info.account) {
              const el = document.createElement('div');
              el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='12px'; el.style.borderRadius='8px'; el.style.background='#fff';
              const boundAtStr = info.boundAt ? (new Date(info.boundAt)).toLocaleString() : '';
              el.innerHTML = `<div><strong>${displayIcons[m]} ${displayNames[m]}</strong><div style="color:#777; font-size:13px; margin-top:6px;">${info.account}</div><div class="meta" style="color:#999; font-size:12px; margin-top:6px;">ç»‘å®šæ—¶é—´ï¼š${boundAtStr}</div></div><div><button data-method="${m}" class="order-btn unbind-btn">è§£ç»‘</button></div>`;
              boundList.appendChild(el);
            } else {
              const el = document.createElement('div');
              el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='12px'; el.style.border='1px dashed #eee'; el.style.borderRadius='8px'; el.style.background='#fafafa';
              el.innerHTML = `<div><strong>${displayIcons[m]} ${displayNames[m]}</strong><div style="color:#999; font-size:13px; margin-top:6px;">æœªç»‘å®š</div></div><div><button data-method="${m}" class="search-btn bind-btn">ç»‘å®š</button></div>`;
              unboundList.appendChild(el);
            }
        });

        // ç»‘å®šäº‹ä»¶ï¼šä½¿ç”¨æ¨¡æ€è¡¨å•è€Œé prompt
        // ä»…ä¸ºå¸¦æœ‰ data-method çš„ç»‘å®šæŒ‰é’®æ³¨å†Œå¤„ç†ï¼ˆé¿å…ä¸æ”¯ä»˜/å…¶ä»–ç»‘å®šç±»æŒ‰é’®å†²çªï¼‰
        document.querySelectorAll('.bind-btn[data-method]').forEach(b => b.addEventListener('click', function(){
          const m = this.dataset.method;
          // å¾®ä¿¡/æ”¯ä»˜å®ï¼šæ‰‹æœºå·ç»‘å®šï¼ˆå¦‚æœå·²è®¤è¯åˆ™å¡«å……ï¼‰
          if (m === 'wechat' || m === 'alipay') {
            const loginUser = JSON.parse(localStorage.getItem('12306_loginUser')) || {};
            if (!loginUser || !loginUser.phone) {
              if (confirm('ç»‘å®šæ”¯ä»˜éœ€è¦å…ˆå®Œæˆèº«ä»½è®¤è¯ï¼Œæ˜¯å¦å‰å¾€ä¸ªäººä¸­å¿ƒè®¤è¯ï¼Ÿ')) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelector('[data-page="user-page"]').classList.add('active');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('user-page').classList.add('active');
                try { document.querySelector('.user-menu-item[data-menu="info"]').click(); } catch(e) {}
              }
              return;
            }
            const acc = prompt(`ç»‘å®š${displayNames[m]}ï¼ˆæ‰‹æœºå·ï¼‰:`, loginUser.phone || '');
            if (!acc) return;
            const raw2 = localStorage.getItem('paymentBindings'); let map2 = {}; try { map2 = raw2?JSON.parse(raw2):{} } catch(e) { map2 = {}; }
            map2[m] = { account: acc, boundAt: Date.now() };
            localStorage.setItem('paymentBindings', JSON.stringify(map2));
            loadBindings();
            return;
          }

          // Apple Payï¼šä½¿ç”¨ä¸“é—¨çš„ç»‘å®šæ¨¡æ€
          if (m === 'apple_pay') {
            // æ‰“å¼€ Apple ç»‘å®šæ¨¡æ€
            const mod = document.getElementById('appleBindModal'); if (mod) mod.style.display = 'block';
            // æ ‡è®°å¾…ç»‘å®šæ–¹æ³•
            window._pendingBindMethod = 'apple_pay';
            return;
          }

          // é“¶è”ï¼šæ‰“å¼€é“¶è”ç»‘å®šæ¨¡æ€ï¼ˆé€‰æ‹©é“¶è¡Œåœ¨å¡å·ä¹‹ä¸Šï¼Œä½¿ç”¨æŒ‰é’®é€‰æ‹©ï¼‰
          if (m === 'unionpay') {
            const mod = document.getElementById('unionBindModal'); if (mod) mod.style.display = 'block';
            window._pendingBindMethod = 'unionpay';
            // é¢„å¡«ç¤ºä¾‹å¡å·
            try { document.getElementById('unionBindCard').value = '5773882334'; } catch(e) {}
            // æ¸…é™¤ä¸Šæ¬¡é€‰æ‹©
            try { document.querySelectorAll('#unionBindModal .bank-btn').forEach(b=>b.classList.remove('selected')); } catch(e) {}
            return;
          }

          // å…¶ä»–æ–¹å¼ï¼šç®€å• prompt
          const accOther = prompt(`è¯·è¾“å…¥è¦ç»‘å®šçš„${displayNames[m]}è´¦å·ï¼š`);
          if (!accOther) return;
          const raw3 = localStorage.getItem('paymentBindings'); let map3 = {}; try { map3 = raw3?JSON.parse(raw3):{} } catch(e) { map3 = {}; }
          map3[m] = { account: accOther, boundAt: Date.now() };
          localStorage.setItem('paymentBindings', JSON.stringify(map3));
          loadBindings();
        }));

        document.querySelectorAll('.unbind-btn[data-method]').forEach(b => b.addEventListener('click', function(){
          const m = this.dataset.method;
          window._pendingUnbindMethod = m;
          const display = displayNames[m] || m;
          const msgEl = document.getElementById('unbindConfirmMsg');
          if (msgEl) msgEl.textContent = `ç¡®å®šè¦è§£ç»‘ ${display} å—ï¼Ÿ`;
          const mod = document.getElementById('unbindConfirmModal'); if (mod) mod.style.display = 'block';
        }));
      }

      // å½“åˆ‡æ¢åˆ°æ”¯ä»˜ç»‘å®šé¡µæ—¶åŠ è½½
        document.querySelectorAll('.nav-item').forEach(n => n.addEventListener('click', function(){ if (this.getAttribute('data-page')==='payment-page') { setTimeout(loadBindings,100); } }));
      // è‹¥åˆå§‹å³åœ¨æ”¯ä»˜é¡µåˆ™åŠ è½½ä¸€æ¬¡
        setTimeout(()=>{ const p=document.getElementById('payment-page'); if (p && p.classList.contains('active')) loadBindings(); },200);

      // ç»‘å®šæ¨¡æ€çš„äº¤äº’å¤„ç†ï¼ˆApple ä¸ é“¶è”ï¼‰
      // Apple ç»‘å®šï¼šæˆæƒå¹¶ä¿å­˜
      document.getElementById('appleBindConfirm').addEventListener('click', function(){
        const raw = localStorage.getItem('paymentBindings'); let map = {}; try { map = raw?JSON.parse(raw):{} } catch(e) { map = {}; }
        map['apple_pay'] = { account: 'AppleID@example.com', boundAt: Date.now() };
        localStorage.setItem('paymentBindings', JSON.stringify(map));
        document.getElementById('appleBindModal').style.display = 'none';
        loadBindings();
      });
      document.getElementById('appleBindCancel').addEventListener('click', function(){ document.getElementById('appleBindModal').style.display='none'; });

      // é“¶è”ç»‘å®šæ¨¡æ€ï¼šé“¶è¡Œé€‰æ‹©æŒ‰é’®
      document.querySelectorAll('#unionBindModal .bank-btn').forEach(b => {
        b.addEventListener('click', function(){
          document.querySelectorAll('#unionBindModal .bank-btn').forEach(x=>x.classList.remove('selected'));
          this.classList.add('selected');
          // å¦‚æœé€‰æ‹©äº†â€œå…¶ä»–é“¶è¡Œâ€ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
          try {
            const otherWrap = document.getElementById('unionOtherBankWrap');
            if (this.dataset.bank === 'å…¶ä»–é“¶è¡Œ') { if (otherWrap) otherWrap.style.display = 'block'; }
            else { if (otherWrap) otherWrap.style.display = 'none'; }
          } catch(e) {}
        });
      });
      document.getElementById('unionBindCancel').addEventListener('click', function(){ document.getElementById('unionBindModal').style.display='none'; });
      document.getElementById('unionBindConfirm').addEventListener('click', function(){
        const card = (document.getElementById('unionBindCard')||{}).value || '';
        const pwd = (document.getElementById('unionBindPwd')||{}).value || '';
        const bankBtn = document.querySelector('#unionBindModal .bank-btn.selected');
        let bank = bankBtn ? bankBtn.dataset.bank : '';
        if (!bank) return alert('è¯·é€‰æ‹©é“¶è¡Œ');
        if (bank === 'å…¶ä»–é“¶è¡Œ') {
          const other = (document.getElementById('unionOtherBank')||{}).value || '';
          if (!other) return alert('è¯·è¾“å…¥é“¶è¡Œåç§°');
          bank = other;
        }
        if (!card) return alert('è¯·è¾“å…¥é“¶è¡Œå¡å·');
        if (!pwd) return alert('è¯·è¾“å…¥ç»‘å®šå¯†ç ');
        const raw = localStorage.getItem('paymentBindings'); let map = {}; try { map = raw?JSON.parse(raw):{} } catch(e) { map = {}; }
        map['unionpay'] = { account: card + ' (' + bank + ')', boundAt: Date.now(), cardPwd: pwd };
        localStorage.setItem('paymentBindings', JSON.stringify(map));
        document.getElementById('unionBindModal').style.display = 'none';
        loadBindings();
      });
      // è§£ç»‘æ¨¡æ€ç¡®è®¤/å–æ¶ˆå¤„ç†
      document.getElementById('unbindCancelBtn').addEventListener('click', function(){
        document.getElementById('unbindConfirmModal').style.display = 'none';
        window._pendingUnbindMethod = null;
      });
      document.getElementById('unbindConfirmBtn').addEventListener('click', function(){
        const m = window._pendingUnbindMethod;
        if (!m) { document.getElementById('unbindConfirmModal').style.display = 'none'; return; }
        try {
          const raw = localStorage.getItem('paymentBindings'); let map = {}; try { map = raw?JSON.parse(raw):{} } catch(e) { map = {}; }
          delete map[m]; localStorage.setItem('paymentBindings', JSON.stringify(map));
        } catch(e) { console.error('è§£ç»‘å¤±è´¥', e); }
        document.getElementById('unbindConfirmModal').style.display = 'none';
        window._pendingUnbindMethod = null;
        loadBindings();
      });
    })();
  </script>

  <!-- æ ¸å¿ƒé¡µé¢å®¹å™¨ -->
  <div class="container page-container">
    <!-- 1. è½¦ç¥¨é¢„è®¢é¡µé¢ -->
    <div class="page active" id="ticket-page">
      <div class="page-title">ç«è½¦ç¥¨é¢„è®¢</div>
      <form class="search-form" id="trainSearchForm">
        <div class="form-item">
          <label for="startCity">å‡ºå‘åœ°</label>
          <select id="startCity" style="padding:6px;">
              <option value="åŒ—äº¬">åŒ—äº¬</option>
              <option value="ä¸Šæµ·">ä¸Šæµ·</option>
              <option value="å¹¿å·">å¹¿å·</option>
              <option value="æ·±åœ³" selected>æ·±åœ³</option>
              <option value="æˆéƒ½">æˆéƒ½</option>
              <option value="é‡åº†">é‡åº†</option>
              <option value="æ­å·">æ­å·</option>
              <option value="å—äº¬">å—äº¬</option>
              <option value="æ­¦æ±‰">æ­¦æ±‰</option>
              <option value="è¥¿å®‰">è¥¿å®‰</option>
              <option value="éƒ‘å·">éƒ‘å·</option>
              <option value="é•¿æ²™">é•¿æ²™</option>
              <option value="é’å²›">é’å²›</option>
              <option value="è‹å·">è‹å·</option>
              <option value="å®æ³¢">å®æ³¢</option>
              <option value="æ— é”¡">æ— é”¡</option>
              <option value="å¦é—¨">å¦é—¨</option>
              <option value="åˆè‚¥">åˆè‚¥</option>
              <option value="ä½›å±±">ä½›å±±</option>
              <option value="ä¸œè">ä¸œè</option>
            </optgroup>
          </select>
        </div>
        <div class="form-item">
          <label for="endCity">åˆ°è¾¾åœ°</label>
          <select id="endCity" style="padding:6px;">
              <option value="åŒ—äº¬">åŒ—äº¬</option>
              <option value="ä¸Šæµ·" selected>ä¸Šæµ·</option>
              <option value="å¹¿å·">å¹¿å·</option>
              <option value="æ·±åœ³">æ·±åœ³</option>
              <option value="æˆéƒ½">æˆéƒ½</option>
              <option value="é‡åº†">é‡åº†</option>
              <option value="æ­å·">æ­å·</option>
              <option value="å—äº¬">å—äº¬</option>
              <option value="æ­¦æ±‰">æ­¦æ±‰</option>
              <option value="è¥¿å®‰">è¥¿å®‰</option>
              <option value="éƒ‘å·">éƒ‘å·</option>
              <option value="é•¿æ²™">é•¿æ²™</option>
              <option value="é’å²›">é’å²›</option>
              <option value="è‹å·">è‹å·</option>
              <option value="å®æ³¢">å®æ³¢</option>
              <option value="æ— é”¡">æ— é”¡</option>
              <option value="å¦é—¨">å¦é—¨</option>
              <option value="åˆè‚¥">åˆè‚¥</option>
              <option value="ä½›å±±">ä½›å±±</option>
              <option value="ä¸œè">ä¸œè</option>
          </select>
        </div>
        <div class="form-item">
          <label for="trainDate">å‡ºå‘æ—¥æœŸ</label>
          <input type="date" id="trainDate" value="">
        </div>
        <div class="form-item">
          <label for="seatType">å¸­åˆ«</label>
          <select id="seatType">
            <option value="all">å…¨éƒ¨å¸­åˆ«</option>
            <option value="äºŒç­‰åº§">äºŒç­‰åº§</option>
            <option value="ä¸€ç­‰åº§">ä¸€ç­‰åº§</option>
            <option value="æ— åº§">æ— åº§</option>
          </select>
        </div>
        <button type="button" class="search-btn" id="searchBtn">æŸ¥è¯¢è½¦ç¥¨</button>
      </form>
      <div class="train-list" id="trainList">
        <div class="list-header">
          <div>è½¦æ¬¡</div>
          <div>å‡ºå‘ï¼ˆç«™/æ—¶é—´ï¼‰</div>
          <div>åˆ°è¾¾ï¼ˆç«™/æ—¶é—´ï¼‰</div>
          <div>å†æ—¶</div>
          <div>äºŒç­‰åº§ï¼ˆä»·/ä½™ï¼‰</div>
          <div>ä¸€ç­‰åº§ï¼ˆä»·/ä½™ï¼‰</div>
          <div>æ“ä½œ</div>
        </div>
        <div class="empty-state" id="ticketEmptyState">è¯·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®è·å–è½¦æ¬¡ä¿¡æ¯</div>
      </div>
      
    </div>

    <!-- 2. è®¢å•æŸ¥è¯¢é¡µé¢ -->
    <div class="page" id="order-page">
      <div class="page-title">æˆ‘çš„è®¢å•</div>
      <form class="order-search-form" id="orderSearchForm">
        <div class="form-item">
          <label for="orderNo">è®¢å•å·</label>
          <input type="text" id="orderNo" placeholder="è¯·è¾“å…¥è®¢å•å·">
        </div>
        <div class="form-item">
          <label for="orderDate">ä¸‹å•æ—¥æœŸ</label>
          <input type="date" id="orderDate" value="2025-12-20">
        </div>
        <div class="form-item">
          <label for="orderStatus">è®¢å•çŠ¶æ€</label>
          <select id="orderStatus">
            <option value="all">å…¨éƒ¨çŠ¶æ€</option>
            <option value="pending">å¾…æ”¯ä»˜</option>
            <option value="paid">å·²æ”¯ä»˜</option>
            <option value="waitlist">å€™è¡¥ä¸­</option>
            <option value="cancelled">å·²å–æ¶ˆ</option>
          </select>
        </div>
        <button type="button" class="search-btn" id="orderSearchBtn">æŸ¥è¯¢è®¢å•</button>
      </form>
      <div class="order-list" id="orderList">
        <div class="order-header">
          <div>è®¢å•å·</div>
          <div>è½¦æ¬¡/è¡Œç¨‹</div>
          <div>ä¸‹å•æ—¶é—´</div>
          <div>é‡‘é¢</div>
          <div>çŠ¶æ€</div>
          <div>æ“ä½œ</div>
        </div>
        <div class="empty-state" id="orderEmptyState">è¯·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®è·å–è®¢å•ä¿¡æ¯</div>
      </div>
    </div>
    
    <div class="page" id="user-page">
      <div class="page-title">ä¸ªäººä¸­å¿ƒ</div>
      <div class="user-center">
        <div class="user-sidebar">
          <div class="user-avatar" id="userAvatar">ç”¨</div>
            <div class="user-name" id="sidebarUserName">æ¸¸å®¢ç”¨æˆ·</div>
          <ul class="user-menu">
            <li class="user-menu-item active" data-menu="passenger">å¸¸ç”¨ä¹˜å®¢</li>
            <li class="user-menu-item" data-menu="info">ä¸ªäººä¿¡æ¯</li>
            <li class="user-menu-item" data-menu="safe">è´¦æˆ·å®‰å…¨</li>
          </ul>
        </div>
        <div class="user-content" id="userContent">
          <!-- èº«ä»½è®¤è¯æ¨¡å—ï¼ˆæ–°å¢ï¼‰ -->
          <div id="verifyBlock" style="margin-bottom:20px; padding:10px; border:1px dashed #eee; border-radius:4px;">
            <h3 style="margin-bottom:10px;">èº«ä»½è®¤è¯</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <input id="idPhone" placeholder="æ‰‹æœºå·" style="height:38px; padding:0 10px; flex:1; min-width:150px; border:1px solid #ccc; border-radius:2px;" />
              <input id="idCard" placeholder="èº«ä»½è¯å·" style="height:38px; padding:0 10px; flex:2; min-width:200px; border:1px solid #ccc; border-radius:2px;" />
              <button class="search-btn" id="verifyBtn" style="height:38px; font-size:80%;">ä¿å­˜è®¤è¯</button>
            </div>
            <div id="verifyStatus" style="margin-top:10px;color:#666;"></div>
          </div>
          <div id="verifyDone" style="display:none; margin-bottom:20px; padding:10px; border:1px dashed #eee; border-radius:4px; color:#2e7d32;">
            <h3 style="margin-bottom:6px;">èº«ä»½è®¤è¯</h3>
            <div id="verifiedInfo">å·²è®¤è¯</div>
          </div>

          <!-- å¸¸ç”¨ä¹˜å®¢æ¨¡å— -->
          <div class="user-panel active" id="passenger-panel">
            <h3 style="margin-bottom: 15px;">å¸¸ç”¨ä¹˜è½¦äºº</h3>
            <button class="search-btn" style="width: 150px; height: 40px; font-size: 16px; margin-bottom: 20px;" id="addPassengerBtn">æ·»åŠ ä¹˜å®¢</button>
            <!-- æ·»åŠ ä¹˜å®¢å¼¹çª—ï¼ˆé»˜è®¤éšè—ï¼‰ -->
            <div id="passengerModal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(1.6); transform-origin:center; background:#fff; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,0.2); border-radius:6px; z-index:2000; width:420px;">
              <h4 style="margin-bottom:10px;">æ·»åŠ å¸¸ç”¨ä¹˜å®¢</h4>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <input id="modal_passenger_name" placeholder="ä¹˜å®¢å§“å" style="height:36px; padding:0 8px;" />
                <input id="modal_passenger_idcard" placeholder="ä¹˜å®¢èº«ä»½è¯å·" style="height:36px; padding:0 8px;" />
                <input id="modal_passenger_phone" placeholder="ä¹˜å®¢æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰" style="height:36px; padding:0 8px;" />
                <select id="modal_passenger_type" style="height:36px; padding:0 8px;">
                  <option value="adult">æˆäºº</option>
                  <option value="child">å„¿ç«¥</option>
                </select>
                <div style="display:flex; gap:8px; justify-content:flex-end;">
                  <button id="modalCancelBtn" class="order-btn" style="background:#fff; color:#d92121; font-size:70%; padding:6px 8px; height:30px;">å–æ¶ˆ</button>
                  <button id="modalSaveBtn" class="search-btn" style="font-size:70%; padding:6px 10px; height:32px;">ä¿å­˜</button>
                </div>
              </div>
            </div>
            <div class="passenger-list">
              <div class="passenger-header">
                <div>ä¹˜å®¢å§“å</div>
                <div>èº«ä»½è¯å·</div>
                <div>æ‰‹æœºå·</div>
                <div>ç±»å‹</div>
                <div>æ“ä½œ</div>
              </div>
              <div class="empty-state" id="passengerEmptyState">æš‚æ— å¸¸ç”¨ä¹˜å®¢ï¼Œè¯·æ·»åŠ </div>
              <div id="passengerListContent"></div>
            </div>
          </div>
          <!-- ä¸ªäººä¿¡æ¯æ¨¡å—ï¼ˆæ¨¡æ‹Ÿï¼‰ -->
          <div class="user-panel" id="info-panel">
            <h3 style="margin-bottom: 15px;">ä¸ªäººä¿¡æ¯</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px; width: 150px; color: #666;">ç”¨æˆ·å</td>
                <td id="info_username" style="padding: 10px;">æ¸¸å®¢ç”¨æˆ·</td>
                <td style="padding: 10px; width: 160px; text-align: right;">
                  <button class="search-btn" id="changeUsernameBtn" style="height:34px; font-size:14px; padding:0 10px;">ä¿®æ”¹ç”¨æˆ·å</button>
                </td>
              </tr>
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px; color: #666;">æ‰‹æœºå·</td>
                <td id="info_phone" style="padding: 10px;">138****8888</td>
              </tr>
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px; color: #666;">å¤´åƒ</td>
                <td style="padding: 10px;">
                  <div class="avatar-controls">
                    <input type="file" id="avatarInput" accept="image/*" />
                    <div class="avatar-preview-small" id="avatarPreviewSmall"></div>
                    <button id="uploadAvatarBtn" class="avatar-upload-btn">ä¸Šä¼ å¤´åƒ</button>
                    <button id="removeAvatarBtn" class="avatar-remove-btn">ç§»é™¤</button>
                  </div>
                  <div style="color:#999; font-size:12px; margin-top:6px;">æ”¯æŒ JPG/PNGï¼Œæœ€å¤§ 2MBã€‚ä¸Šä¼ åä¼šä¿å­˜è‡³æœ¬åœ°æµè§ˆå™¨å­˜å‚¨ã€‚</div>
                </td>
              </tr>
            </table>
            
          </div>
          <!-- è´¦æˆ·å®‰å…¨æ¨¡å—ï¼ˆæ¨¡æ‹Ÿï¼‰ -->
          <div class="user-panel" id="safe-panel">
            <h3 style="margin-bottom: 15px;">è´¦æˆ·å®‰å…¨</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px; width: 150px; color: #666;">ç™»å½•å¯†ç </td>
                <td style="padding: 10px;">å·²è®¾ç½® <span style="color: #999;">ï¼ˆæœ€åä¿®æ”¹ï¼š2025-12-01ï¼‰</span></td>
                <td style="padding: 10px;"><button class="order-btn" id="changePasswordBtn">ä¿®æ”¹å¯†ç </button></td>
              </tr>
            </table>
            
          </div>
        </div>
      </div>
    </div>

    <!-- 4. è´­ç¥¨æŒ‡å—é¡µé¢ -->
    <div class="page" id="payment-page">
      <div class="page-title">æ”¯ä»˜ç»‘å®š</div>
      <div style="background:#fff; padding:16px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.04);">
        <p style="margin-bottom:8px; color:#666;">ç®¡ç†æ‚¨çš„æ”¯ä»˜æ–¹å¼ã€‚å·²ç»‘å®šçš„æ–¹å¼ä¼šæ˜¾ç¤ºåœ¨ä¸Šæ–¹ï¼Œæœªç»‘å®šçš„å¯ç‚¹å‡»â€œç»‘å®šâ€ã€‚</p>
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
          <div style="flex:1; min-width:260px;">
            <h4 style="margin-bottom:8px;">å·²ç»‘å®š</h4>
            <div id="boundList" style="display:flex; flex-direction:column; gap:8px;"></div>
          </div>
          <div style="flex:1; min-width:260px;">
            <h4 style="margin-bottom:8px;">æœªç»‘å®š</h4>
            <div id="unboundList" style="display:flex; flex-direction:column; gap:8px;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="page" id="guide-page">
      <div class="page-title">è´­ç¥¨æŒ‡å—</div>
      <div class="guide-content">
        <div class="guide-section">
          <h3>ä¸€ã€è´­ç¥¨é¡»çŸ¥</h3>
          <ul>
            <li>12306ç½‘ç«™æ¯å¤©06:00-23:00æä¾›è´­ç¥¨æœåŠ¡ï¼Œå…¶ä½™æ—¶é—´ä¸ºç³»ç»Ÿç»´æŠ¤æœŸã€‚</li>
            <li>å¯é¢„è®¢æœªæ¥15å¤©ä»¥å†…çš„ç«è½¦ç¥¨ï¼Œé¢„å”®æœŸå¦‚æœ‰è°ƒæ•´è¯·ä»¥å®˜æ–¹å…¬å‘Šä¸ºå‡†ã€‚</li>
            <li>ä¸€å¼ æœ‰æ•ˆèº«ä»½è¯ä»¶åŒä¸€ä¹˜è½¦æ—¥æœŸåŒä¸€è½¦æ¬¡åªèƒ½è´­ä¹°ä¸€å¼ è½¦ç¥¨ï¼ˆå„¿ç«¥ç¥¨é™¤å¤–ï¼‰ã€‚</li>
            <li>è®¢å•æäº¤åéœ€åœ¨30åˆ†é’Ÿå†…å®Œæˆæ”¯ä»˜ï¼Œè¶…æ—¶æœªæ”¯ä»˜è®¢å•å°†è‡ªåŠ¨å–æ¶ˆã€‚</li>
          </ul>
        </div>
        <div class="guide-section">
          <h3>äºŒã€é€€ç¥¨/æ”¹ç­¾è§„åˆ™</h3>
          <ul>
            <li>å¼€è½¦å‰8å¤©ï¼ˆå«ï¼‰ä»¥ä¸Šé€€ç¥¨çš„ï¼Œä¸æ”¶å–é€€ç¥¨è´¹ï¼›</li>
            <li>å¼€è½¦å‰48å°æ—¶ä»¥ä¸Šè‡³8å¤©ä»¥å†…é€€ç¥¨çš„ï¼ŒæŒ‰ç¥¨ä»·5%æ”¶å–é€€ç¥¨è´¹ï¼›</li>
            <li>å¼€è½¦å‰24å°æ—¶ä»¥ä¸Šè‡³48å°æ—¶ä»¥å†…é€€ç¥¨çš„ï¼ŒæŒ‰ç¥¨ä»·10%æ”¶å–é€€ç¥¨è´¹ï¼›</li>
            <li>å¼€è½¦å‰24å°æ—¶ä»¥å†…é€€ç¥¨çš„ï¼ŒæŒ‰ç¥¨ä»·20%æ”¶å–é€€ç¥¨è´¹ï¼›</li>
            <li>æ”¹ç­¾ä¸æ”¶å–æ‰‹ç»­è´¹ï¼Œä¸€å¼ è½¦ç¥¨åªèƒ½æ”¹ç­¾ä¸€æ¬¡ã€‚</li>
          </ul>
        </div>
        <div class="guide-section">
          <h3>ä¸‰ã€å¸¸è§é—®é¢˜</h3>
          <ul>
            <li>Qï¼šå¿˜è®°è®¢å•å·å¦‚ä½•æŸ¥è¯¢ï¼Ÿ<br>Aï¼šå¯é€šè¿‡ã€Œæˆ‘çš„12306-è®¢å•æŸ¥è¯¢ã€é€‰æ‹©æ—¥æœŸå’ŒçŠ¶æ€æŸ¥è¯¢ï¼Œæ— éœ€è®¢å•å·ã€‚</li>
            <li>Qï¼šå„¿ç«¥ç¥¨å¦‚ä½•è´­ä¹°ï¼Ÿ<br>Aï¼šèº«é«˜1.2ç±³ä»¥ä¸‹å…ç¥¨ï¼Œ1.2-1.5ç±³è´­ä¹°å„¿ç«¥ç¥¨ï¼Œ1.5ç±³ä»¥ä¸Šéœ€è´­ä¹°æˆäººç¥¨ã€‚</li>
            <li>Qï¼šæ”¯ä»˜å¤±è´¥æ€ä¹ˆåŠï¼Ÿ<br>Aï¼šè¯·æ£€æŸ¥æ”¯ä»˜è´¦æˆ·ä½™é¢æˆ–ç½‘ç»œï¼Œæ”¯ä»˜å¤±è´¥åè®¢å•ä¼šä¿ç•™30åˆ†é’Ÿï¼Œå¯é‡æ–°æ”¯ä»˜ã€‚</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
        // ===== ç™»å½•çŠ¶æ€åŒæ­¥ =====
    window.onload = function() {
      // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
      const loginUser = JSON.parse(localStorage.getItem('12306_loginUser'));
      const loginLink = document.getElementById('loginLink');
      
      if (loginUser) {
        // å·²ç™»å½•ï¼šæ˜¾ç¤ºç”¨æˆ·å+é€€å‡ºæŒ‰é’®
        loginLink.innerHTML = `${loginUser.username} <span style="color: #666; font-weight: normal;">|</span> <span id="logoutBtn" style="color: #d92121; cursor: pointer;">é€€å‡º</span>`;
        // å¡«å……ä¾§è¾¹æ å’Œä¸ªäººä¿¡æ¯ï¼ˆå…ˆæ˜¾ç¤ºæœ¬åœ°ç¼“å­˜å†…å®¹ï¼‰
        const sidebarNameEl = document.getElementById('sidebarUserName');
        const infoNameEl = document.getElementById('info_username');
        const infoPhoneEl = document.getElementById('info_phone');
        if (sidebarNameEl) sidebarNameEl.textContent = loginUser.username || 'æ¸¸å®¢ç”¨æˆ·';
        if (infoNameEl) infoNameEl.textContent = loginUser.username || 'æ¸¸å®¢ç”¨æˆ·';
        if (infoPhoneEl && loginUser.phone) infoPhoneEl.textContent = loginUser.phone;

        // ä»åç«¯æ‹‰å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯å¹¶è¦†ç›–æ˜¾ç¤º
        fetch(`http://localhost:3000/api/user/${loginUser.userId}`)
          .then(res => res.json())
            .then(res => {
              if (res && res.code === 0 && res.data) {
                const u = res.data;
                if (sidebarNameEl) sidebarNameEl.textContent = u.username || sidebarNameEl.textContent;
                if (infoNameEl) infoNameEl.textContent = u.username || infoNameEl.textContent;
                if (infoPhoneEl) infoPhoneEl.textContent = u.phone || infoPhoneEl.textContent;
                // æ›´æ–° localStorage ç¼“å­˜
                const cached = JSON.parse(localStorage.getItem('12306_loginUser')) || {};
                cached.phone = u.phone || cached.phone;
                cached.username = u.username || cached.username;
                cached.id_card = u.id_card || cached.id_card;
                localStorage.setItem('12306_loginUser', JSON.stringify(cached));
                // å¦‚æœå·²è®¤è¯ï¼ˆæ‰‹æœºå·å’Œèº«ä»½è¯éƒ½æœ‰ï¼‰ï¼Œéšè—è¡¨å•å¹¶æ˜¾ç¤ºå·²è®¤è¯ä¿¡æ¯
                try {
                  const verifyBlock = document.getElementById('verifyBlock');
                  const verifyDone = document.getElementById('verifyDone');
                  const verifiedInfo = document.getElementById('verifiedInfo');
                  if (u.phone && u.id_card) {
                    if (verifyBlock) verifyBlock.style.display = 'none';
                    if (verifyDone) {
                      const maskedPhone = String(u.phone).replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
                      const maskedId = maskId(u.id_card);
                      verifiedInfo.textContent = `æ‰‹æœºå· ${maskedPhone}ï¼Œèº«ä»½è¯ ${maskedId}`;
                      verifyDone.style.display = 'block';
                    }
                  } else {
                    if (verifyBlock) verifyBlock.style.display = 'block';
                    if (verifyDone) verifyDone.style.display = 'none';
                  }
                } catch (e) {
                  // ignore DOM errors
                }
              }
            }).catch(err => {
              console.warn('æ— æ³•æ‹‰å–ç”¨æˆ·ä¿¡æ¯ï¼š', err);
            });
        
        // é€€å‡ºç™»å½•åŠŸèƒ½
        document.getElementById('logoutBtn').addEventListener('click', function() {
          localStorage.removeItem('12306_loginUser');
          alert('å·²é€€å‡ºç™»å½•ï¼');
          window.location.reload(); // åˆ·æ–°é¡µé¢æ›´æ–°çŠ¶æ€
        });
      } else {
        // æœªç™»å½•ï¼šæ˜¾ç¤ºè¯·ç™»å½•ï¼ˆè·³è½¬login.htmlï¼‰
        loginLink.onclick = function() {
          window.location.href = './login.html'; 
        };
      }

      // å·²ä½¿ç”¨æ›´ç²¾ç¡®çš„é¢„è®¢æŒ‰é’®å¤„ç†é€»è¾‘ï¼ˆç»‘å®šåœ¨ç”Ÿæˆçš„ ticket-btn ä¸Šï¼‰ï¼Œ
      // è¿™é‡Œç§»é™¤å…¨å±€æ‹¦æˆªå™¨ä»¥é¿å…ä¸å¼¹çª—æµç¨‹å†²çªã€‚
    };
    // ===== é€šç”¨é¡µé¢åˆ‡æ¢é€»è¾‘ =====
    const navItems = document.querySelectorAll('.nav-item');
    const pages = document.querySelectorAll('.page');
    
    navItems.forEach(item => {
      item.addEventListener('click', function() {
        // åˆ‡æ¢å¯¼èˆªæ¿€æ´»çŠ¶æ€
        navItems.forEach(nav => nav.classList.remove('active'));
        this.classList.add('active');
        
        // åˆ‡æ¢é¡µé¢æ˜¾ç¤º
        const targetPage = this.getAttribute('data-page');
        pages.forEach(page => {
          page.classList.remove('active');
          if (page.id === targetPage) {
            page.classList.add('active');
          }
        });
        // å¦‚æœåˆ‡æ¢åˆ°è½¦ç¥¨é¢„è®¢é¡µï¼Œè‡ªåŠ¨æ ¹æ®å½“å‰è¾“å…¥æ¡†è§¦å‘ä¸€æ¬¡æŸ¥è¯¢
        if (targetPage === 'ticket-page') {
          setTimeout(() => {
            const sb = document.getElementById('searchBtn');
            const startCity = (document.getElementById('startCity') || {}).value || '';
            const endCity = (document.getElementById('endCity') || {}).value || '';
            const date = (document.getElementById('trainDate') || {}).value || '';
            if (sb && startCity && endCity && date) sb.click();
          }, 80);
        }
        // å¦‚æœåˆ‡æ¢åˆ°è®¢å•æŸ¥è¯¢é¡µï¼Œä¼˜å…ˆä½¿ç”¨ç½‘ç»œæ—¶é—´è®¾ç½® orderDateï¼Œå†è‡ªåŠ¨åŠ è½½å½“å¤©è®¢å•
        if (targetPage === 'order-page') {
          const orderDateInput = document.getElementById('orderDate');
          if (orderDateInput) {
            (async function(){
              try {
                const resp = await fetch('https://worldtimeapi.org/api/ip');
                if (resp.ok) {
                  const j = await resp.json();
                  const dt = new Date(j.utc_datetime || j.datetime || (j.unixtime? j.unixtime*1000 : undefined));
                  if (!isNaN(dt)) {
                    const y = dt.getFullYear();
                    const m = String(dt.getMonth() + 1).padStart(2, '0');
                    const d = String(dt.getDate()).padStart(2, '0');
                    orderDateInput.value = `${y}-${m}-${d}`;
                  } else {
                    const now = new Date(); orderDateInput.value = now.toISOString().slice(0,10);
                  }
                } else {
                  const now = new Date(); orderDateInput.value = now.toISOString().slice(0,10);
                }
              } catch (e) {
                const now = new Date(); orderDateInput.value = now.toISOString().slice(0,10);
              }
              // ç½‘ç»œæ—¶é—´è®¾ç½®å®Œæˆåå†åŠ è½½è®¢å•ï¼ˆç¡®ä¿æŒ‰æ­£ç¡®æ—¥æœŸè¿‡æ»¤ï¼‰
              setTimeout(() => { if (typeof loadOrders === 'function') loadOrders(); }, 60);
            })();
          } else {
            // è‹¥æ²¡æœ‰æ—¥æœŸè¾“å…¥ï¼Œç›´æ¥åŠ è½½
            setTimeout(() => { if (typeof loadOrders === 'function') loadOrders(); }, 60);
          }
        }
      });
    });

   // ===== 1. è½¦ç¥¨é¢„è®¢é¡µé¢ï¼šä½¿ç”¨æœ¬åœ°å¼€æºè½¦æ¬¡æ•°æ®æŸ¥è¯¢ =====
const searchBtn = document.getElementById('searchBtn');
const trainList = document.getElementById('trainList');
const ticketEmptyState = document.getElementById('ticketEmptyState');
let __searchLock = false;
let __lastSearchAt = 0;
const __SEARCH_DEBOUNCE_MS = 800;

searchBtn.addEventListener('click', function() {
  // 1. è·å–ç”¨æˆ·è¾“å…¥
  const startCity = document.getElementById('startCity').value.trim();
  const endCity = document.getElementById('endCity').value.trim();
  const date = document.getElementById('trainDate').value;

  // 2. åŸºç¡€æ ¡éªŒ
  if (!startCity || !endCity || !date) {
    alert('è¯·å¡«å†™å®Œæ•´çš„å‡ºå‘åœ°ã€åˆ°è¾¾åœ°å’Œæ—¥æœŸï¼');
    return;
  }

  // é˜²æ­¢é‡å¤è§¦å‘ï¼ˆèŠ‚æµï¼‰
  const now = Date.now();
  if (__searchLock || (now - __lastSearchAt) < __SEARCH_DEBOUNCE_MS) {
    return;
  }
  __searchLock = true;
  __lastSearchAt = now;

  // 3. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  ticketEmptyState.textContent = "æ­£åœ¨æŸ¥è¯¢è½¦æ¬¡ä¿¡æ¯...";
  ticketEmptyState.style.display = 'block';

  // 4. æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿï¼ˆæ›´çœŸå®ï¼‰
  setTimeout(() => {
    try {
    // 5. ç­›é€‰è½¦æ¬¡ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼Œå¦‚â€œåŒ—äº¬â€åŒ¹é…â€œåŒ—äº¬å—â€ï¼‰ï¼Œå¹¶æ ¹æ®å‡ºå‘æ—¥æœŸ/å½“å‰æ—¶é—´åªå±•ç¤ºå¯è´­ä¹°è½¦æ¬¡
    const selectedDate = (document.getElementById('trainDate') || {}).value || '';
    const todayStr = new Date().toISOString().slice(0,10);
    const isSearchingToday = (selectedDate === todayStr);

    const filteredTrains = window.trainData.filter(train => {
      const startMatch = train.startStation.includes(startCity);
      const endMatch = train.endStation.includes(endCity);
      if (!(startMatch && endMatch)) return false;

      // å¦‚æœç”¨æˆ·é€‰æ‹©çš„æ—¥æœŸæ˜¯ä»Šå¤©ï¼Œåˆ™åªæ˜¾ç¤ºå‘è½¦æ—¶é—´æ™šäºå½“å‰æ—¶é—´çš„è½¦æ¬¡
      if (isSearchingToday) {
        try {
          let t = String(train.startTime || '').trim();
          if (!t) return false;
          // è¡¥å…¨åˆ° HH:MM:SS æ ¼å¼
          if (/^\d{1,2}:\d{2}$/.test(t)) t = t + ':00';
          // å°† selectedDate + time è½¬ä¸ºæœ¬åœ°æ—¶é—´æ¯”è¾ƒ
          const dtStr = selectedDate + 'T' + t;
          let dt = new Date(dtStr);
          if (isNaN(dt.getTime())) {
            // é™çº§å°è¯•ï¼šç›´æ¥ç”¨ Date æ„é€ 
            dt = new Date(selectedDate + ' ' + String(train.startTime || ''));
          }
          if (isNaN(dt.getTime())) return true; // æ— æ³•è§£ææ—¶æ”¾å¼€æ˜¾ç¤º
          return dt.getTime() > Date.now();
        } catch (e) { return true; }
      }
      // å¦‚æœé€‰æ‹©çš„æ—¥æœŸä¸æ˜¯ä»Šå¤©ï¼ˆæœªæ¥æˆ–è¿‡å»ï¼‰ï¼Œé»˜è®¤å±•ç¤ºï¼ˆæœªæ¥æ—¥æœŸæ˜¾ç¤ºå…¨éƒ¨è½¦æ¬¡ï¼‰
      return true;
    });

    // 6. æ¸…ç©ºåŸæœ‰åˆ—è¡¨
    const existingTrainItems = document.querySelectorAll('.train-item');
    existingTrainItems.forEach(item => item.remove());

    // 7. å¤„ç†ç­›é€‰ç»“æœ
    if (filteredTrains.length === 0) {
      ticketEmptyState.textContent = "æœªæŸ¥è¯¢åˆ°ç¬¦åˆæ¡ä»¶çš„è½¦æ¬¡ï¼Œè¯·æ›´æ¢åŸå¸‚é‡è¯•ï¼";
      ticketEmptyState.style.display = 'block';
      return;
    } else {
      ticketEmptyState.style.display = 'none';
    }

    // 8. æ¸²æŸ“è½¦æ¬¡åˆ—è¡¨
    filteredTrains.forEach(train => {
      const trainItem = document.createElement('div');
      trainItem.className = 'train-item';
      // seatAvailability may be missing in some data; normalize
      const ava = train.seatAvailability || {};
      const avaSecond = ava.second === undefined ? 'æœªçŸ¥' : ava.second;
      const avaFirst = ava.first === undefined ? 'æœªçŸ¥' : ava.first;
      const avaNo = ava.noSeat === undefined ? undefined : ava.noSeat; // 1 è¡¨ç¤ºæœ‰ç¥¨ï¼Œ0 è¡¨ç¤ºæ— ç¥¨
      const showWait = ((ava.second !== undefined && ava.second === 0) || (ava.first !== undefined && ava.first === 0) || (ava.noSeat !== undefined && ava.noSeat === 0));
      // æ ¼å¼åŒ–æ˜¾ç¤ºï¼š>10 æ˜¾ç¤ºâ€œæœ‰ç¥¨â€ï¼Œ==0 æˆ– 'æ— ' æ˜¾ç¤ºâ€œæ— â€ï¼Œå…¶ä»–æ˜¾ç¤ºå…·ä½“å‰©ä½™
      function availDisplay(v) {
        if (v === 'æœªçŸ¥' || v === undefined || v === null) return 'æœªçŸ¥';
        if (v === 'æ— ') return 'æ— ç¥¨';
        const n = Number(v);
        if (!isNaN(n)) {
          if (n === 0) return 'æ— ç¥¨';
          if (n > 10) return 'æœ‰ç¥¨';
          return `ä½™${n}å¼ `;
        }
        return String(v);
      }
      const displaySecond = availDisplay(avaSecond);
      const displayFirst = availDisplay(avaFirst);
      trainItem.innerHTML = `
        <div class="train-number">${train.number}</div>
        <div>${train.startStation || ''} <br/><small style="color:#777;">${train.startTime || ''}</small></div>
        <div>${train.endStation || ''} <br/><small style="color:#777;">${train.endTime || ''}</small></div>
        <div>${train.duration || ''}</div>
        <div>Â¥${train.secondSeatPrice} <br/><small style="color:#777;">${displaySecond}</small></div>
        <div>Â¥${train.firstSeatPrice} <br/><small style="color:#777;">${displayFirst}</small></div>
        <div>
          <button class="ticket-btn"
            data-train-no="${train.number}"
            data-second-price="${train.secondSeatPrice}"
            data-first-price="${train.firstSeatPrice}"
            data-start-station="${train.startStation}"
            data-end-station="${train.endStation}"
            data-depart="${train.startTime}"
            data-ava-second="${avaSecond}"
            data-ava-first="${avaFirst}"
            data-ava-noseat="${avaNo === undefined ? '' : avaNo}"
          >é¢„è®¢</button>
        </div>
      `;
      trainList.appendChild(trainItem);
    });

    // 9. é¢„è®¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼šå¼¹å‡ºé€‰æ‹©å¸­åˆ«ä¸æ”¯ä»˜æ–¹å¼çš„ç¡®è®¤å¼¹çª—ï¼ˆè¦æ±‚å·²è®¤è¯ï¼‰
    const bookingModal = document.getElementById('bookingModal');
    const bookingCancelBtn = document.getElementById('bookingCancelBtn');
    const bookingConfirmBtn = document.getElementById('bookingConfirmBtn');
    const bookingTrainInfo = document.getElementById('bookingTrainInfo');
    const bookingSeatSelect = document.getElementById('booking_seat_select');

    // æ ¹æ®å½“å‰é€‰ä¸­å¸­åˆ«æ›´æ–°ç¡®è®¤æŒ‰é’®æ–‡æœ¬ä¸æ”¯ä»˜é€‰é¡¹ï¼ˆå€™è¡¥æ—¶ç¦ç”¨æ”¯ä»˜ï¼‰
    function updateBookingActionUI() {
      const selected = bookingSeatSelect.options[bookingSeatSelect.selectedIndex];
      const isWait = selected && selected.dataset && selected.dataset.wait === '1';
      const waitHintEl = document.getElementById('bookingWaitHint');
      if (isWait) {
        bookingConfirmBtn.textContent = 'å€™è¡¥';
        // ç¦ç”¨å¹¶å–æ¶ˆé€‰ä¸­æ”¯ä»˜æ–¹å¼
        document.querySelectorAll('input[name="booking_payment"]').forEach(r => { r.checked = false; r.disabled = true; r.parentElement.style.opacity = '0.6'; });
        if (waitHintEl) { waitHintEl.style.display = 'block'; }
      } else {
        bookingConfirmBtn.textContent = 'ç¡®è®¤å¹¶æ”¯ä»˜';
        // å¯ç”¨å·²ç»‘å®šçš„æ”¯ä»˜æ–¹å¼ï¼Œæœªç»‘å®šçš„æ˜¾ç¤ºä¸ºä¸å¯é€‰å¹¶æç¤ºç»‘å®š
        let bindings = {};
        try { bindings = JSON.parse(localStorage.getItem('paymentBindings') || '{}'); } catch(e) { bindings = {}; }
        document.querySelectorAll('input[name="booking_payment"]').forEach(r => {
          const bound = bindings[r.value] && bindings[r.value].account;
          r.disabled = !bound;
          if (!bound) {
            r.parentElement.style.opacity = '0.5';
            r.checked = false;
          } else {
            r.parentElement.style.opacity = '';
          }
        });
        if (waitHintEl) { waitHintEl.style.display = 'none'; }
      }
    }
    bookingSeatSelect.addEventListener('change', updateBookingActionUI);

    let currentBooking = null; // ä¿å­˜å½“å‰å¾…ç¡®è®¤çš„è½¦æ¬¡æ•°æ®

    const bookingBackdrop = document.getElementById('bookingBackdrop');
    // å°† showBookingModal æš´éœ²ä¸ºå…¨å±€å‡½æ•°ï¼Œä¾¿äºæ”¯ä»˜æ¨¡æ€ç­‰å¤„è°ƒç”¨
    window.showBookingModal = function(show) {
      const bookingModalEl = document.getElementById('bookingModal');
      const bookingBackdropEl = document.getElementById('bookingBackdrop');
      if (bookingModalEl) bookingModalEl.style.display = show ? 'block' : 'none';
      if (bookingBackdropEl) bookingBackdropEl.style.display = show ? 'block' : 'none';
      document.body.style.overflow = show ? 'hidden' : '';

      // å½“å¼¹çª—æ‰“å¼€æ—¶ï¼Œå¼‚æ­¥å¡«å……ä¹˜å®¢ä¸‹æ‹‰ï¼ˆæœ¬äºº + å¸¸ç”¨ä¹˜è½¦äººï¼‰
      if (show) {
        (async function fillPassengerSelect(){
          try {
            const select = document.getElementById('booking_passenger_select');
            if (!select) return;
            // æ¸…ç©ºå¹¶æ”¾ç½®å ä½é¡¹
            select.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©ä¹˜å®¢ï¼ˆæœ¬äººæˆ–å¸¸ç”¨ä¹˜è½¦äººï¼‰</option>';
            const loginUser = JSON.parse(localStorage.getItem('12306_loginUser')) || null;
            if (loginUser) {
              const el = document.createElement('option');
              el.value = 'self';
              el.textContent = `æœ¬äºº - ${loginUser.name || ''} ${loginUser.phone ? '('+loginUser.phone+')' : ''}`;
              el.dataset.name = loginUser.name || '';
              el.dataset.id = loginUser.id_card || '';
              el.dataset.phone = loginUser.phone || '';
              select.appendChild(el);
              // é»˜è®¤é€‰æ‹©æœ¬äººï¼Œä¾¿äºç”¨æˆ·ç›´æ¥æäº¤
              try { select.value = 'self'; } catch(e) {}
            }
            // åŠ è½½å¸¸ç”¨ä¹˜è½¦äººåˆ—è¡¨å¹¶è¿½åŠ 
            try {
              const uid = loginUser ? loginUser.userId : '';
              if (uid) {
                const resp = await fetch(`http://localhost:3000/api/frequent_passengers?userId=${encodeURIComponent(uid)}`);
                if (resp && resp.ok) {
                  const j = await resp.json();
                  if (j && j.code === 0 && Array.isArray(j.data)) {
                    j.data.forEach(p => {
                      const o = document.createElement('option');
                      o.value = p.id || (`fp_${p.id || Math.random().toString(36).slice(2,8)}`);
                      // ä½¿ç”¨åç«¯å­—æ®µåï¼špassenger_name/passenger_phone/passenger_id_card
                      o.textContent = `${p.passenger_name || ''} ${p.passenger_phone ? '('+p.passenger_phone+')' : ''}`;
                      o.dataset.name = p.passenger_name || '';
                      o.dataset.id = p.passenger_id_card || '';
                      o.dataset.phone = p.passenger_phone || '';
                      select.appendChild(o);
                    });
                  }
                }
              }
            } catch(e) { console.error('åŠ è½½å¸¸ç”¨ä¹˜è½¦äººå¤±è´¥', e); }
          } catch (e) { console.error('å¡«å……ä¹˜å®¢ä¸‹æ‹‰å¤±è´¥', e); }
        })();
      }
    };

    // ç»‘å®šæ¯ä¸ªé¢„è®¢æŒ‰é’®ï¼šå¼¹çª—å¡«å……å¹¶æ‰“å¼€
    document.querySelectorAll('.ticket-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const loginUser = JSON.parse(localStorage.getItem('12306_loginUser')) || null;
        if (!loginUser) {
          alert('è¯·å…ˆç™»å½•åå†é¢„è®¢è½¦ç¥¨ï¼');
          window.location.href = './login.html';
          return;
        }
        // èº«ä»½è®¤è¯æ£€æŸ¥ï¼šå¿…é¡»æœ‰ phone å’Œ id_card
        if (!loginUser.phone || !loginUser.id_card) {
          alert('è¯·å…ˆå®Œæˆèº«ä»½è®¤è¯ï¼ˆæ‰‹æœºå·ä¸èº«ä»½è¯ï¼‰ï¼Œè®¤è¯åæ‰èƒ½é¢„è®¢');
          // å¯è·³è½¬åˆ°ä¸ªäººä¸­å¿ƒè®¤è¯ä½ç½®
          document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
          document.querySelector('[data-page="user-page"]').classList.add('active');
          document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
          document.getElementById('user-page').classList.add('active');
          // åˆ‡æ¢åˆ°ä¸ªäººä¸­å¿ƒå¹¶æ‰“å¼€è®¤è¯æ¨¡å—ä½ç½®
          try { document.querySelector('.user-menu-item[data-menu="info"]').click(); } catch (e) {}
          return;
        }

        const btnEl = this;
        const trainNo = btnEl.dataset.trainNo;
        const secondPrice = parseFloat(btnEl.dataset.secondPrice) || 0;
        const firstPrice = parseFloat(btnEl.dataset.firstPrice) || 0;
        const start = btnEl.dataset.startStation || document.getElementById('startCity').value;
        const end = btnEl.dataset.endStation || document.getElementById('endCity').value;
        const depart = btnEl.dataset.depart || document.getElementById('trainDate').value;
        // availability from data attributes (å¯èƒ½ä¸ºæ•°å­—ã€å­—ç¬¦ä¸² 'æ— ' æˆ– 'æœªçŸ¥')
        const avaSecondRaw = btnEl.dataset.avaSecond;
        const avaFirstRaw = btnEl.dataset.avaFirst;
        const avaBusinessRaw = btnEl.dataset.avaBusiness;
        const avaNoRaw = btnEl.dataset.avaNoseat;
        function normalizeA(v) {
          if (v === undefined || v === null) return null;
          if (v === 'æœªçŸ¥' || v === '') return null;
          if (v === 'æ— ') return 0;
          const n = Number(v);
          return isNaN(n) ? v : n;
        }
        const avaSecond = normalizeA(avaSecondRaw);
        const avaFirst = normalizeA(avaFirstRaw);
        const avaBusiness = normalizeA(avaBusinessRaw);
        const avaNo = normalizeA(avaNoRaw);

        currentBooking = { trainNo, secondPrice, firstPrice, start, end, depart, avaSecond, avaFirst, avaBusiness, avaNo };
        window.currentBooking = currentBooking;
        const noSeatText = avaNo === null || avaNo === undefined ? 'æœªçŸ¥' : (avaNo === 1 ? 'æœ‰ç¥¨' : 'æ— ç¥¨');
        bookingTrainInfo.textContent = `${trainNo} ${start}â†’${end} å‘è½¦ï¼š${depart} â€” ä½™ç¥¨ï¼šäºŒç­‰${avaSecond ?? 'æœªçŸ¥'} ä¸€ç­‰${avaFirst ?? 'æœªçŸ¥'} æ— åº§${noSeatText}`;

        // æ ¹æ®ä½™ç¥¨åŠ¨æ€ç”Ÿæˆå¸­åˆ«é€‰é¡¹ï¼ˆè¦æ±‚æ˜¾å¼é€‰æ‹©ï¼‰
        (function populateSeatOptions(){
          const createOption = (val, label, avail) => {
            let text = label;
            if (avail === null || avail === undefined) {
              // ä¸æ˜¾ç¤ºä½™é‡
            } else if (typeof avail === 'number') {
              text += `ï¼ˆä½™${avail}å¼ ï¼‰`;
            } else {
              text += `ï¼ˆ${avail}ï¼‰`;
            }
            let attrs = '';
            if (avail === 0) {
              // ä½™ç¥¨ä¸º0ï¼Œå…è®¸å€™è¡¥ï¼šæ ‡è®° data-wait="1" å¹¶åœ¨æ–‡å­—ä¸Šæç¤º
              text += 'ï¼ˆå·²å”®ç½„ï¼Œå¯å€™è¡¥ï¼‰';
              attrs += ' data-wait="1"';
            }
            return `<option value="${val}"${attrs}>${text}</option>`;
          };
          const opts = [];
          opts.push(`<option value="" disabled selected>è¯·é€‰æ‹©å¸­åˆ«</option>`);
          // ä¸€ç­‰åº§
          opts.push(createOption('ä¸€ç­‰åº§', 'ä¸€ç­‰åº§', avaFirst));
          // äºŒç­‰åº§
          opts.push(createOption('äºŒç­‰åº§', 'äºŒç­‰åº§', avaSecond));
          // æ— åº§/ç¡¬åº§/ç¡¬å§ï¼šæ˜¾ç¤ºæœ‰/æ— ç¥¨ï¼ˆavaNo: 1 æœ‰ç¥¨ï¼Œ0 æ— ç¥¨ï¼‰
          if (avaNo !== null && avaNo !== undefined) {
            // å¯¹æ— åº§å•ç‹¬æ ¼å¼åŒ–æ˜¾ç¤º
            const createNoOption = (val, label, avail) => {
              let text = label;
              if (avail === 1) text += 'ï¼ˆæœ‰ç¥¨ï¼‰';
              else if (avail === 0) text += 'ï¼ˆæ— ç¥¨ï¼Œå¯å€™è¡¥ï¼‰';
              else text += `ï¼ˆ${avail}ï¼‰`;
              let attrs = '';
              if (avail === 0) attrs += ' data-wait="1"';
              return `<option value="${val}"${attrs}>${text}</option>`;
            };
            opts.push(createNoOption('æ— åº§', 'æ— åº§', avaNo));
          }
          bookingSeatSelect.innerHTML = opts.join('');
        })();

        // å¦‚æœå…¨å±€å¸­åˆ«å·²ç»æŒ‡å®šå¹¶ä¸”å¯ç”¨ï¼Œåˆ™é»˜è®¤é€‰æ‹©ï¼Œå¦åˆ™ä¿æŒç©º
        const globalSeat = (document.getElementById('seatType') || {}).value || '';
        if (globalSeat && globalSeat !== 'all') {
          try { bookingSeatSelect.value = globalSeat; } catch(e) { bookingSeatSelect.value = ''; }
        } else bookingSeatSelect.value = '';
        // åœ¨å±•ç¤ºå¼¹çª—å‰æ ¹æ®é»˜è®¤é€‰é¡¹æ›´æ–°æŒ‰é’®/æ”¯ä»˜æ§ä»¶çŠ¶æ€
        updateBookingActionUI();
        showBookingModal(true);
      });
    });

    bookingCancelBtn.addEventListener('click', function() { currentBooking = null; window.currentBooking = null; showBookingModal(false); });

    // NOTE: å€™è¡¥ç”±å¼¹çª—å†…çš„å¸­åˆ«é€‰é¡¹æ§åˆ¶ï¼ˆé€‰ä¸­å·²å”®ç½„é¡¹ä¼šå°†è®¢å•æ ‡è®°ä¸º waitlistï¼‰

    bookingConfirmBtn.addEventListener('click', async function() {
      if (!currentBooking) { showBookingModal(false); return; }
      const loginUser = JSON.parse(localStorage.getItem('12306_loginUser')) || null;
      if (!loginUser) { alert('ç™»å½•ä¿¡æ¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•'); window.location.href = './login.html'; return; }

      const seatTypeSelected = bookingSeatSelect.value;
      if (!seatTypeSelected) { alert('è¯·å…ˆé€‰æ‹©å¸­åˆ«å†ä¸‹å•'); return; }
      // æ ¹æ®å¸­åˆ«é€‰æ‹©ä»·æ ¼
      let price = currentBooking.secondPrice || 0;
      if (seatTypeSelected.includes('ä¸€ç­‰') || seatTypeSelected === 'ä¸€ç­‰åº§') price = currentBooking.firstPrice || price;
      // å•†åŠ¡åº§å·²ç§»é™¤ï¼Œä¿ç•™ä¸€ç­‰/äºŒç­‰/æ— åº§é€»è¾‘
      // è‹¥é€‰ä¸­çš„å¸­åˆ«å¸¦æœ‰ data-wait="1"ï¼Œåˆ™è§†ä¸ºå€™è¡¥ï¼ˆæœªæ”¯ä»˜ï¼‰
      const selectedOption = bookingSeatSelect.options[bookingSeatSelect.selectedIndex];
      const isWait = selectedOption && selectedOption.dataset && selectedOption.dataset.wait === '1';

      // å°†é€‰æ‹©çš„å¸­åˆ«ä¸ä»·æ ¼è®°å½•åˆ° currentBookingï¼Œä¾›åç»­æ”¯ä»˜æ¨¡æ€ä½¿ç”¨
      window.currentBooking.seatType = seatTypeSelected;
      window.currentBooking.price = price;

      // ç¡®å®šæ”¯ä»˜æ–¹å¼ï¼šå€™è¡¥ä¸éœ€è¦æ”¯ä»˜ï¼›è‹¥éå€™è¡¥åˆ™å…ˆèµ°æ”¯ä»˜ UIï¼ˆäºŒç»´ç /Apple/é“¶è”ï¼‰ï¼Œæ”¯ä»˜å®Œæˆåå†åˆ›å»ºè®¢å•ä¸º paid
      const selectedPay = document.querySelector('input[name="booking_payment"]:checked')?.value || '';
      if (isWait) {
        // ç›´æ¥åˆ›å»ºå€™è¡¥è®¢å•
        // å–æ‰€é€‰ä¹˜å®¢ä¿¡æ¯ï¼ˆè‹¥æ— åˆ™ç©ºï¼‰
        const _ps = document.getElementById('booking_passenger_select');
        const _sel = _ps && _ps.options[_ps.selectedIndex];
        const passenger_name = _sel ? (_sel.dataset.name || '') : '';
        const passenger_id_card = _sel ? (_sel.dataset.id || '') : '';
        const passenger_phone = _sel ? (_sel.dataset.phone || '') : '';
        const payload = {
          userId: loginUser.userId,
          start_city: currentBooking.start,
          end_city: currentBooking.end,
          train_no: currentBooking.trainNo,
          price: price,
          depart_time: document.getElementById('trainDate').value + ' ' + currentBooking.depart,
          seat_type: seatTypeSelected,
          payment_method: '',
          status: 'waitlist',
          passenger_name: passenger_name,
          passenger_id_card: passenger_id_card,
          passenger_phone: passenger_phone
        };
        // å‘é€åˆ›å»ºè¯·æ±‚
        try {
          const resp = await fetch('http://localhost:3000/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const result = await resp.json();
          if (result.code === 0) {
            alert('å€™è¡¥å·²æäº¤ï¼š' + result.data.order_no + 'ï¼ŒçŠ¶æ€ï¼šå€™è¡¥ï¼ˆæœªæ”¯ä»˜ï¼‰ã€‚è¯·ç­‰å¾…æœ‰ç¥¨åç³»ç»Ÿé€šçŸ¥æ‚¨æ”¯ä»˜ã€‚');
            currentBooking = null; window.currentBooking = null; showBookingModal(false);
            try { if (typeof loadOrders === 'function') await loadOrders(); } catch(e) { console.error('åŠ è½½è®¢å•å¤±è´¥', e); }
          } else { alert('åˆ›å»ºå€™è¡¥å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯')); }
        } catch (err) { console.error(err); alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡'); }
        return;
      }

      // éå€™è¡¥ï¼šæ ¹æ®æ”¯ä»˜æ–¹å¼å±•ç¤ºä¸åŒæ”¯ä»˜äº¤äº’
      const bindings = JSON.parse(localStorage.getItem('paymentBindings') || '{}');
      if (selectedPay === 'apple_pay') {
        // Apple Pay æ¨¡æ‹Ÿï¼šæ— éœ€å¯†ç ï¼Œç›´æ¥å±•ç¤º UIï¼Œç„¶ååˆ›å»º paid è®¢å•
        document.getElementById('applePayPrice').textContent = price.toFixed(2);
        // éšè—é¢„è®¢å¼¹çª—ï¼Œæ˜¾ç¤ºæ”¯ä»˜æ¨¡æ€
        showBookingModal(false);
        document.getElementById('paymentBackdrop').style.display = 'block';
        document.getElementById('applePayModal').style.display = 'block';
        return; // åç»­é€šè¿‡ appleConfirmBtn å¤„ç†
      }
      if (selectedPay === 'wechat' || selectedPay === 'alipay') {
        // QR ç æ”¯ä»˜ï¼šæ˜¾ç¤ºäºŒç»´ç å’Œä»·æ ¼ï¼Œç”¨æˆ·ç‚¹å‡»å·²å®Œæˆååˆ›å»º paid è®¢å•
        document.getElementById('qrPrice').textContent = price.toFixed(2);
        const box = document.getElementById('qrBox');
        box.style.borderColor = (selectedPay === 'wechat') ? '#4caf50' : '#2196f3';
        document.getElementById('qrPaymentTitle').textContent = (selectedPay === 'wechat') ? 'å¾®ä¿¡æ‰«ç æ”¯ä»˜' : 'æ”¯ä»˜å®æ‰«ç æ”¯ä»˜';
        // éšè—é¢„è®¢å¼¹çª—ï¼Œæ˜¾ç¤ºæ”¯ä»˜æ¨¡æ€
        showBookingModal(false);
        document.getElementById('paymentBackdrop').style.display = 'block';
        document.getElementById('qrPaymentModal').style.display = 'block';
        // qrPaidBtn handler will call order creation
        return;
      }
      if (selectedPay === 'unionpay') {
        // é“¶è”éœ€è¦å¡å¯†ç ï¼›å¿…é¡»å·²ç»‘å®šæ‰å¯æ”¯ä»˜
        const u = bindings['unionpay'];
        if (!u || !u.account) { if (confirm('æœªç»‘å®šé“¶è¡Œå¡ï¼Œæ˜¯å¦å‰å¾€æ”¯ä»˜ç»‘å®šé¡µé¢ç»‘å®šï¼Ÿ')) { document.querySelector('[data-page="payment-page"]').click(); } return; }
        document.getElementById('unionCardNo').textContent = (u.account || '5773882334');
        // éšè—é¢„è®¢å¼¹çª—ï¼Œæ˜¾ç¤ºæ”¯ä»˜æ¨¡æ€
        showBookingModal(false);
        document.getElementById('paymentBackdrop').style.display = 'block';
        document.getElementById('unionPayModal').style.display = 'block';
        return; // unionConfirmBtn ä¼šå¤„ç†åˆ›å»º order
      }
      // å…¶ä»–æ”¯ä»˜æ–¹å¼æš‚ä¸æ”¯æŒç›´æ¥æ”¯ä»˜
      alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„æ”¯ä»˜æ–¹å¼');
      return;

    });

    } finally {
      __searchLock = false;
    }
  }, 100); // 100mså»¶è¿Ÿï¼Œæ¨¡æ‹Ÿè”ç½‘æŸ¥è¯¢
});


// é¡µé¢åŠ è½½æ—¶å¦‚æœå½“å‰å°±æ˜¯è½¦ç¥¨é¢„è®¢é¡µï¼Œè‡ªåŠ¨è§¦å‘ä¸€æ¬¡æŸ¥è¯¢ï¼ˆä½¿ç”¨åˆå§‹åŒ–æ¡†çš„åœ°å€ï¼‰
setTimeout(() => {
  const ticketPage = document.getElementById('ticket-page');
  if (ticketPage && ticketPage.classList.contains('active')) {
    const sb = document.getElementById('searchBtn');
    const startCity = (document.getElementById('startCity') || {}).value || '';
    const endCity = (document.getElementById('endCity') || {}).value || '';
    const date = (document.getElementById('trainDate') || {}).value || '';
    if (sb && startCity && endCity && date) sb.click();
  }
}, 200);

    // ===== æ”¯ä»˜æ¨¡æ€ç¡®è®¤æŒ‰é’®å¤„ç†ï¼ˆåœ¨åˆ›å»ºè®¢å•æ—¶ä½œä¸ºå·²æ”¯ä»˜çš„æ ‡è®°ï¼‰ =====
    // å¾®ä¿¡/æ”¯ä»˜å®ï¼šäºŒç»´ç æ”¯ä»˜å·²å®Œæˆ
    document.getElementById('qrPaidBtn').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true;
      document.getElementById('qrPaymentModal').style.display = 'none';
      document.getElementById('paymentBackdrop').style.display = 'none';
      const loginUser = JSON.parse(localStorage.getItem('12306_loginUser')) || null;
      if (!loginUser || !window.currentBooking) { alert('å½“å‰æ”¯ä»˜ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼Œè¯·é‡è¯•'); btn.disabled = false; return; }
      const price = parseFloat(window.currentBooking.price || window.currentBooking.secondPrice || 0);
      // ä»ä¹˜å®¢ä¸‹æ‹‰è·å–æ‰€é€‰ä¹˜å®¢ä¿¡æ¯
      const __ps = document.getElementById('booking_passenger_select');
      const __sel = __ps && __ps.options[__ps.selectedIndex];
      const __p_name = __sel ? (__sel.dataset.name || '') : '';
      const __p_id = __sel ? (__sel.dataset.id || '') : '';
      const __p_phone = __sel ? (__sel.dataset.phone || '') : '';
      const payload = {
        userId: loginUser.userId,
        start_city: window.currentBooking.start,
        end_city: window.currentBooking.end,
        train_no: window.currentBooking.trainNo,
        price: price,
        depart_time: document.getElementById('trainDate').value + ' ' + window.currentBooking.depart,
        seat_type: (window.currentBooking.seatType || ''),
        payment_method: document.querySelector('input[name="booking_payment"]:checked')?.value || '',
        status: 'paid',
        passenger_name: __p_name,
        passenger_id_card: __p_id,
        passenger_phone: __p_phone
      };
      try {
        const resp = await fetch('http://localhost:3000/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!resp.ok) {
          console.error('Order create HTTP error', resp.status, resp.statusText);
          alert('åˆ›å»ºè®¢å•è¯·æ±‚å¤±è´¥ï¼šHTTP ' + resp.status);
          btn.disabled = false;
          return;
        }
        let res;
        try { res = await resp.json(); } catch (e) { console.error('è§£æè®¢å•åˆ›å»ºå“åº”å¤±è´¥', e); alert('åˆ›å»ºè®¢å•å“åº”è§£æå¤±è´¥'); btn.disabled = false; return; }
        if (res.code === 0) {
          alert('æ”¯ä»˜æˆåŠŸï¼Œè®¢å•å·²åˆ›å»ºï¼š' + res.data.order_no);
          window.currentBooking = null; showBookingModal(false);
          try { if (typeof loadOrders === 'function') await loadOrders(); } catch(e) { console.error('åŠ è½½è®¢å•å¤±è´¥', e); }
        } else { alert('åˆ›å»ºè®¢å•å¤±è´¥ï¼š' + (res.msg || 'æœªçŸ¥é”™è¯¯')); }
      } catch (err) { console.error(err); alert('åˆ›å»ºè®¢å•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡'); }
      btn.disabled = false;
    });

    // Apple Pay ç¡®è®¤
    document.getElementById('appleConfirmBtn').addEventListener('click', async function() {
      const btn = this; btn.disabled = true;
      document.getElementById('applePayModal').style.display = 'none';
      document.getElementById('paymentBackdrop').style.display = 'none';
      const loginUser = JSON.parse(localStorage.getItem('12306_loginUser')) || null;
      if (!loginUser || !window.currentBooking) { alert('å½“å‰æ”¯ä»˜ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼Œè¯·é‡è¯•'); btn.disabled = false; return; }
      const price = parseFloat(window.currentBooking.price || window.currentBooking.secondPrice || 0);
      // åŠ å…¥ä¹˜å®¢ä¿¡æ¯
      const __ps2 = document.getElementById('booking_passenger_select');
      const __sel2 = __ps2 && __ps2.options[__ps2.selectedIndex];
      const __p_name2 = __sel2 ? (__sel2.dataset.name || '') : '';
      const __p_id2 = __sel2 ? (__sel2.dataset.id || '') : '';
      const __p_phone2 = __sel2 ? (__sel2.dataset.phone || '') : '';
      const payload = {
        userId: loginUser.userId,
        start_city: window.currentBooking.start,
        end_city: window.currentBooking.end,
        train_no: window.currentBooking.trainNo,
        price: price,
        depart_time: document.getElementById('trainDate').value + ' ' + window.currentBooking.depart,
        seat_type: (window.currentBooking.seatType || ''),
        payment_method: 'apple_pay',
        status: 'paid',
        passenger_name: __p_name2,
        passenger_id_card: __p_id2,
        passenger_phone: __p_phone2
      };
      try {
        const resp = await fetch('http://localhost:3000/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!resp.ok) { console.error('Order create HTTP error', resp.status); alert('åˆ›å»ºè®¢å•è¯·æ±‚å¤±è´¥ï¼šHTTP ' + resp.status); btn.disabled = false; return; }
        let res; try { res = await resp.json(); } catch(e) { console.error('è§£æè®¢å•åˆ›å»ºå“åº”å¤±è´¥', e); alert('åˆ›å»ºè®¢å•å“åº”è§£æå¤±è´¥'); btn.disabled = false; return; }
        if (res.code === 0) {
          alert('Apple Pay æ”¯ä»˜æˆåŠŸï¼Œè®¢å•å·²åˆ›å»ºï¼š' + res.data.order_no);
          window.currentBooking = null; showBookingModal(false);
          try { if (typeof loadOrders === 'function') await loadOrders(); } catch(e) { console.error('åŠ è½½è®¢å•å¤±è´¥', e); }
        } else { alert('åˆ›å»ºè®¢å•å¤±è´¥ï¼š' + (res.msg || 'æœªçŸ¥é”™è¯¯')); }
      } catch (err) { console.error(err); alert('åˆ›å»ºè®¢å•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡'); }
      btn.disabled = false;
    });

    // å–æ¶ˆæŒ‰é’®ï¼šå…³é—­æ”¯ä»˜æ¨¡æ€å¹¶è¿”å›é¢„è®¢å¼¹çª—
    document.getElementById('qrCancelBtn').addEventListener('click', function(){
      document.getElementById('qrPaymentModal').style.display = 'none';
      document.getElementById('paymentBackdrop').style.display = 'none';
      // æ¸…ç†äºŒç»´ç å ä½çŠ¶æ€ï¼ˆå¯æ‰©å±•ï¼‰
      showBookingModal(true);
    });
    document.getElementById('appleCancelBtn').addEventListener('click', function(){
      document.getElementById('applePayModal').style.display = 'none';
      document.getElementById('paymentBackdrop').style.display = 'none';
      showBookingModal(true);
    });
    document.getElementById('unionCancelBtn').addEventListener('click', function(){
      document.getElementById('unionPayModal').style.display = 'none';
      document.getElementById('paymentBackdrop').style.display = 'none';
      // æ¸…ç©ºå¯†ç è¾“å…¥
      try { document.getElementById('unionPayPwd').value = ''; } catch(e) {}
      showBookingModal(true);
    });

    // é“¶è”ç¡®è®¤ï¼ˆéœ€è¦è¾“å…¥å¯†ç ï¼‰
    document.getElementById('unionConfirmBtn').addEventListener('click', async function() {
      const pwd = document.getElementById('unionPayPwd').value;
      document.getElementById('unionPayModal').style.display = 'none';
      document.getElementById('paymentBackdrop').style.display = 'none';
      if (!pwd) { alert('è¯·è¾“å…¥é“¶è¡Œå¡å¯†ç '); return; }
      const loginUser = JSON.parse(localStorage.getItem('12306_loginUser')) || null;
      if (!loginUser || !window.currentBooking) { alert('å½“å‰æ”¯ä»˜ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼Œè¯·é‡è¯•'); return; }
      const price = parseFloat(window.currentBooking.price || window.currentBooking.secondPrice || 0);
      const __ps3 = document.getElementById('booking_passenger_select');
      const __sel3 = __ps3 && __ps3.options[__ps3.selectedIndex];
      const __p_name3 = __sel3 ? (__sel3.dataset.name || '') : '';
      const __p_id3 = __sel3 ? (__sel3.dataset.id || '') : '';
      const __p_phone3 = __sel3 ? (__sel3.dataset.phone || '') : '';
      const payload = {
        userId: loginUser.userId,
        start_city: window.currentBooking.start,
        end_city: window.currentBooking.end,
        train_no: window.currentBooking.trainNo,
        price: price,
        depart_time: document.getElementById('trainDate').value + ' ' + window.currentBooking.depart,
        seat_type: (window.currentBooking.seatType || ''),
        payment_method: 'unionpay',
        status: 'paid',
        passenger_name: __p_name3,
        passenger_id_card: __p_id3,
        passenger_phone: __p_phone3
      };
      try {
        const resp = await fetch('http://localhost:3000/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const res = await resp.json();
        if (res.code === 0) {
          alert('é“¶è”æ”¯ä»˜æˆåŠŸï¼Œè®¢å•å·²åˆ›å»ºï¼š' + res.data.order_no);
          window.currentBooking = null; showBookingModal(false);
          if (typeof loadOrders === 'function') loadOrders();
        } else { alert('åˆ›å»ºè®¢å•å¤±è´¥ï¼š' + (res.msg || 'æœªçŸ¥é”™è¯¯')); }
      } catch (err) { console.error(err); alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡'); }
    });


    // ===== 2. è®¢å•æŸ¥è¯¢é¡µé¢é€»è¾‘ =====
    const orderSearchBtn = document.getElementById('orderSearchBtn');
    const orderList = document.getElementById('orderList');
    const orderEmptyState = document.getElementById('orderEmptyState');

    // æœ¬åœ°æ—¶é—´æ ¼å¼åŒ–ï¼šæŠŠ ISO/UTC æ—¶é—´è½¬æ¢ä¸ºæœ¬åœ° `YYYY-MM-DD HH:mm`ï¼Œè§£æå¤±è´¥åˆ™è¿”å›åŸå­—ç¬¦ä¸²
    function formatLocalDateTime(dt) {
      try {
        if (!dt) return '';
        const d = new Date(dt);
        if (isNaN(d.getTime())) return String(dt);
        const pad = n => String(n).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      } catch (e) { return String(dt || ''); }
    }

    // ä»åç«¯åŠ è½½è®¢å•ï¼ˆå¯æŒ‰ userId è¿‡æ»¤ï¼‰
    async function loadOrders() {
      const loginUser = JSON.parse(localStorage.getItem('12306_loginUser')) || {};
      const userId = loginUser.userId;
      orderEmptyState.style.display = 'none';
      // æ¸…ç©ºåŸæœ‰åˆ—è¡¨
      const existingOrderItems = document.querySelectorAll('.order-item');
      existingOrderItems.forEach(item => item.remove());

      try {
        const url = userId ? `http://localhost:3000/api/orders?userId=${userId}` : 'http://localhost:3000/api/orders';
        const resp = await fetch(url);
        if (!resp.ok) { console.error('åŠ è½½è®¢å• HTTP é”™è¯¯', resp.status, resp.statusText); orderEmptyState.textContent = 'åŠ è½½è®¢å•å¤±è´¥ï¼šHTTP ' + resp.status; orderEmptyState.style.display = 'block'; return; }
        const result = await resp.json();
        if (result.code !== 0) {
          orderEmptyState.textContent = 'æŸ¥è¯¢è®¢å•å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯');
          orderEmptyState.style.display = 'block';
          return;
        }
        const orders = result.data || [];
        // åˆ¤æ–­è®¢å•æ˜¯å¦å¯æ”¹ç­¾ï¼šæ”¯ä»˜çŠ¶æ€ä¸”æœªå‡ºå‘ã€‚å¢å¼ºæ—¶é—´è§£æå®¹é”™ä¸çŠ¶æ€å¤§å°å†™å…¼å®¹ã€‚
        function orderCanReschedule(o) {
          try {
            const status = String(o.status || '').trim().toLowerCase();
            if (status !== 'paid') return false;
            if (!o.depart_time) return true;
            let dtStr = String(o.depart_time || '');
            // å°è¯•æŠŠå¸¸è§æ ¼å¼è½¬æˆ ISO
            if (dtStr.indexOf(' ') !== -1 && dtStr.indexOf('T') === -1) dtStr = dtStr.replace(' ', 'T');
            // è‹¥æ²¡æœ‰æ—¶åˆ†ç§’ï¼Œå°è¯•è¡¥å…¨
            if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(dtStr)) dtStr = dtStr + ':00';
            let d = new Date(dtStr);
            if (isNaN(d.getTime())) {
              // æœ€åé™çº§ï¼šå°è¯•ç›´æ¥ç”¨ Date æ„é€ ï¼ˆæŸäº›æµè§ˆå™¨è§£æä¸åŒï¼‰
              d = new Date(o.depart_time);
            }
            if (isNaN(d.getTime())) return true; // è‹¥æ— æ³•è§£æï¼Œä¿å®ˆå…è®¸æ”¹ç­¾ä»¥ä¾¿ç”¨æˆ·æ“ä½œ
            return d.getTime() > Date.now();
          } catch (e) { return true; }
        }
        // æ ¹æ® orderDate è¾“å…¥è¿‡æ»¤ï¼ˆä¼˜å…ˆä½¿ç”¨ created_atï¼Œå›é€€åˆ° depart_timeï¼‰
        const selectedDate = (document.getElementById('orderDate') || {}).value || '';
        const selectedStatus = (document.getElementById('orderStatus') || {}).value || 'all';
        const orderNoQuery = ((document.getElementById('orderNo') || {}).value || '').trim();
        let filtered = orders;
        if (selectedDate) {
          filtered = orders.filter(o => {
            try {
              if (o.created_at) {
                const cd = new Date(o.created_at);
                if (!isNaN(cd)) {
                  const pad = n => String(n).padStart(2,'0');
                  const s = `${cd.getFullYear()}-${pad(cd.getMonth()+1)}-${pad(cd.getDate())}`;
                  if (s === selectedDate) return true;
                }
              }
              if (o.depart_time) {
                const dd = new Date(o.depart_time);
                if (!isNaN(dd)) {
                  const pad = n => String(n).padStart(2,'0');
                  const s = `${dd.getFullYear()}-${pad(dd.getMonth()+1)}-${pad(dd.getDate())}`;
                  if (s === selectedDate) return true;
                } else {
                  // fallback to string split if not parseable
                  const dt = String(o.depart_time).split(' ')[0];
                  if (dt === selectedDate) return true;
                }
              }
            } catch (e) {}
            return false;
          });
        }
        // æŒ‰çŠ¶æ€è¿‡æ»¤ï¼ˆå¦‚æœé€‰æ‹©äº†å…·ä½“çŠ¶æ€ï¼‰
        if (selectedStatus && selectedStatus !== 'all') {
          filtered = filtered.filter(o => String(o.status || '').toLowerCase() === String(selectedStatus || '').toLowerCase());
        }
        // æŒ‰è®¢å•å·æ¨¡ç³ŠåŒ¹é…
        if (orderNoQuery) {
          filtered = filtered.filter(o => (o.order_no || '').indexOf(orderNoQuery) !== -1);
        }
        // ç¼“å­˜æœ€è¿‘åŠ è½½çš„è®¢å•ï¼Œä¾›è¯¦æƒ…ç•Œé¢ä½¿ç”¨
        window._lastOrders = filtered;
        if (filtered.length === 0) {
          orderEmptyState.textContent = 'æš‚æ— è®¢å•è®°å½•';
          orderEmptyState.style.display = 'block';
          return;
        }
        // æ¸²æŸ“è®¢å•
        filtered.forEach(o => {
          const orderItem = document.createElement('div');
          orderItem.className = 'order-item';
          const isReschedulable = orderCanReschedule(o);
          orderItem.innerHTML = `
            <div>${o.order_no}</div>
            <div>${o.train_no || ''} ${o.start_city}â†’${o.end_city}</div>
            <div>${formatLocalDateTime(o.depart_time) || ''}</div>
            <div>Â¥${Number(o.price).toFixed(2)}</div>
            <div class="order-status">${o.status}</div>
            <div>
              <button class="order-btn">è¯¦æƒ…</button>
              ${isReschedulable ? '<button class="order-btn reschedule-btn" style="margin-left:6px;">æ”¹ç­¾</button>' : ''}
            </div>
          `;
          orderList.appendChild(orderItem);
        });
        // è®¢å•æŒ‰é’®äº‹ä»¶ï¼šæ‰“å¼€è¯¦æƒ…ç•Œé¢ï¼ˆæ’é™¤æ”¹ç­¾æŒ‰é’®ï¼‰
        document.querySelectorAll('.order-item .order-btn').forEach(btn => {
          if (btn.classList.contains('reschedule-btn')) return;
          btn.addEventListener('click', function() {
            const orderNo = this.closest('.order-item').querySelector('div:first-child').textContent;
            showOrderDetail(orderNo);
          });
        });
        // ç»‘å®šæ”¹ç­¾æŒ‰é’®äº‹ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (typeof bindRescheduleButtons === 'function') bindRescheduleButtons();
      } catch (err) {
        console.error(err);
        orderEmptyState.textContent = 'åŠ è½½è®¢å•å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡';
        orderEmptyState.style.display = 'block';
      }
    }

    orderSearchBtn.addEventListener('click', loadOrders);
    // çŠ¶æ€ä¸‹æ‹‰æ”¹å˜æ—¶è‡ªåŠ¨é‡è½½ï¼ˆå³æ—¶ç­›é€‰ï¼‰
    const orderStatusSelect = document.getElementById('orderStatus');
    if (orderStatusSelect) orderStatusSelect.addEventListener('change', loadOrders);
    // ===== æ”¹ç­¾åŠŸèƒ½é€»è¾‘ =====
    const rescheduleModal = document.getElementById('rescheduleModal');
    const resOldNoEl = document.getElementById('res_old_order_no');
    const resNewPriceInput = document.getElementById('res_new_price');
    const resNewDepartInput = document.getElementById('res_new_depart');
    const resNewTrainList = document.getElementById('res_new_train_list');
    const resNewSeatInput = document.getElementById('res_new_seat');
    const resDiffDisplay = document.getElementById('res_diff_display');
    const resCancelBtn = document.getElementById('resCancelBtn');
    const resConfirmBtn = document.getElementById('resConfirmBtn');
    let _res_currentOrder = null;

    function showRescheduleModal(order) {
      _res_currentOrder = order;
      if (!rescheduleModal) return;
      resOldNoEl.textContent = order.order_no || '';
      // å¡«å……å¯é€‰è½¦æ¬¡ï¼ˆåŒè·¯ç”±ï¼‰å¹¶å°è¯•é»˜è®¤é€‰ä¸­åŸè½¦æ¬¡
      try { populateRescheduleTrainOptions(order); } catch(e) { console.error('å¡«å……æ”¹ç­¾è½¦æ¬¡å¤±è´¥', e); }
      // å¦‚æœåç«¯æœ‰ depart_time å¯è½¬ä¸º datetime-local æ ¼å¼
      try {
        if (order.depart_time) {
          const d = new Date(order.depart_time);
          const pad = n => String(n).padStart(2,'0');
          const local = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
          resNewDepartInput.value = local;
        } else resNewDepartInput.value = '';
      } catch(e){ resNewDepartInput.value = ''; }
      resNewPriceInput.value = Number(order.price || 0).toFixed(2);
      resNewSeatInput.value = order.seat_type || '';
      updateResDiff();
      rescheduleModal.style.display = 'flex';
    }

    function hideRescheduleModal(){ if (rescheduleModal) rescheduleModal.style.display = 'none'; _res_currentOrder = null; }

    function updateResDiff(){
      try {
        const oldPrice = Number((_res_currentOrder && _res_currentOrder.price) || 0);
        const newPrice = Number(resNewPriceInput.value || 0);
        const diff = (newPrice - oldPrice);
        if (diff > 0) { resDiffDisplay.textContent = `å·®ä»·ï¼šÂ¥${diff.toFixed(2)}ï¼ˆéœ€è¡¥å·®ä»·ï¼‰`; resDiffDisplay.style.color = '#d92121'; }
        else if (diff < 0) { resDiffDisplay.textContent = `é€€å·®ï¼šÂ¥${Math.abs(diff).toFixed(2)}ï¼ˆå¯åŸè·¯é€€å›ï¼‰`; resDiffDisplay.style.color = '#1976d2'; }
        else { resDiffDisplay.textContent = 'å·®ä»·ï¼šÂ¥0.00ï¼ˆæ— éœ€è¡¥å·®ï¼‰'; resDiffDisplay.style.color = '#333'; }
        return diff;
      } catch(e){ resDiffDisplay.textContent = 'å·®ä»·ï¼š-'; return 0; }
    }

    // å¡«å……æ”¹ç­¾å€™é€‰è½¦æ¬¡ä¸ºå¡ç‰‡åˆ—è¡¨ï¼ˆä»æœ¬åœ° trainData è¿‡æ»¤åŒè·¯ç”±è½¦æ¬¡ï¼‰
    function populateRescheduleTrainOptions(order) {
      try {
        if (!resNewTrainList) return;
        const routeStart = (order.start_city || order.start || '').toLowerCase();
        const routeEnd = (order.end_city || order.end || '').toLowerCase();
        resNewTrainList.innerHTML = '';
        const list = (window.trainData || []).filter(t => {
          try {
            const a = (t.startStation||'').toLowerCase();
            const b = (t.endStation||'').toLowerCase();
            return (a.includes(routeStart) || routeStart.includes(a)) && (b.includes(routeEnd) || routeEnd.includes(b));
          } catch(e) { return false; }
        });
        const makeCard = (t) => {
          const card = document.createElement('div');
          card.className = 'res-card';
          card.style.padding = '8px';
          card.style.border = '1px solid #eee';
          card.style.borderRadius = '6px';
          card.style.cursor = 'pointer';
          card.style.display = 'flex';
          card.style.justifyContent = 'space-between';
          card.style.alignItems = 'center';
          const num = t.number || t.trainNo || '';
          const p2 = t.secondSeatPrice || t.secondPrice || '';
          const p1 = t.firstSeatPrice || t.firstPrice || '';
          const left = document.createElement('div');
          left.innerHTML = `<div style="font-weight:600">${num} ${t.startStation}â†’${t.endStation}</div><div style="font-size:12px;color:#666">å‘:${t.startTime}  æ—¶é•¿:${t.duration}</div>`;
          const right = document.createElement('div');
          right.style.textAlign = 'right';
          right.innerHTML = `<div style="font-weight:600">äºŒç­‰ Â¥${p2}</div><div style="font-size:12px;color:#666">ä¸€ç­‰ Â¥${p1}</div>`;
          card.appendChild(left);
          card.appendChild(right);
          card.dataset.trainNo = num;
          card.dataset.startTime = t.startTime || '';
          card.dataset.secondPrice = p2;
          card.dataset.firstPrice = p1;
          card.dataset.firstAvail = (t.seatAvailability && (t.seatAvailability.first || t.seatAvailability.first === 0)) ? String(t.seatAvailability.first) : '';
          card.addEventListener('click', function(){
            // å–æ¶ˆå…¶ä»–é€‰ä¸­
            Array.from(resNewTrainList.querySelectorAll('.res-card.selected')).forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            try {
              const tstart = (this.dataset.startTime || '').trim();
              if (tstart && resNewDepartInput) {
                let datePart = new Date();
                try { if (_res_currentOrder && _res_currentOrder.depart_time) datePart = new Date(_res_currentOrder.depart_time); } catch(e) {}
                const pad = n => String(n).padStart(2,'0');
                const dstr = `${datePart.getFullYear()}-${pad(datePart.getMonth()+1)}-${pad(datePart.getDate())}`;
                let tt = tstart;
                if (/^\d{1,2}:\d{2}$/.test(tt)) tt += ':00';
                resNewDepartInput.value = dstr + 'T' + tt;
              }
              if (resNewPriceInput) resNewPriceInput.value = (this.dataset.secondPrice || this.dataset.firstPrice || resNewPriceInput.value);
              if (resNewSeatInput) resNewSeatInput.value = (this.dataset.firstAvail && Number(this.dataset.firstAvail) > 0) ? 'ä¸€ç­‰åº§' : 'äºŒç­‰åº§';
              updateResDiff();
            } catch(e){ console.error('res-card click handler error', e); }
          });
          return card;
        };
        if (list.length > 0) {
          list.forEach(t => resNewTrainList.appendChild(makeCard(t)));
          // é»˜è®¤é€‰æ‹©ç¬¬ä¸€é¡¹
          const first = resNewTrainList.querySelector('.res-card'); if (first) first.click();
        } else {
          // æ— å€™é€‰æ—¶æ˜¾ç¤ºåŸè½¦æ¬¡å¡ç‰‡
          const placeholder = document.createElement('div');
          placeholder.className = 'res-card'; placeholder.style.padding='8px'; placeholder.style.border='1px dashed #eee'; placeholder.style.borderRadius='6px';
          placeholder.textContent = (order.train_no || '') + 'ï¼ˆåŸè½¦æ¬¡ï¼Œæš‚æ— åŒè·¯å¯æ”¹ç­¾è½¦æ¬¡ï¼‰';
          placeholder.dataset.trainNo = order.train_no || '';
          resNewTrainList.appendChild(placeholder);
        }
      } catch (e) { console.error('populateRescheduleTrainOptions error', e); }
    }

    if (resNewPriceInput) resNewPriceInput.addEventListener('input', updateResDiff);

    if (resCancelBtn) resCancelBtn.addEventListener('click', function(){ hideRescheduleModal(); });

    if (resConfirmBtn) resConfirmBtn.addEventListener('click', async function(){
      if (!_res_currentOrder) return alert('å½“å‰è®¢å•ä¿¡æ¯ç¼ºå¤±');
      const diff = updateResDiff();
      const confirmed = (diff > 0) ? confirm(`éœ€è¡¥å·®ä»· Â¥${diff.toFixed(2)}ï¼Œç¡®è®¤æ”¯ä»˜å¹¶æ”¹ç­¾å—ï¼Ÿ`) : confirm('ç¡®è®¤æ”¹ç­¾å¹¶åˆ›å»ºæ–°è®¢å•ï¼Ÿ');
      if (!confirmed) return;
      // å‘èµ·æ”¹ç­¾è¯·æ±‚åˆ°åç«¯ï¼›å‰ç«¯åœ¨æ­¤å¤„å‡å®šå·²æ”¯ä»˜ï¼ˆè‹¥ diff>0ï¼Œå®é™…åº”é›†æˆæ”¯ä»˜æµç¨‹ï¼‰
      try {
        // è¯»å–ç”¨æˆ·é€‰ä¸­çš„å¡ç‰‡ï¼ˆè‹¥æœ‰ï¼‰ä½œä¸ºç›®æ ‡è½¦æ¬¡
        let selectedTrainNo = _res_currentOrder.train_no || '';
        try {
          const selCard = document.querySelector('#res_new_train_list .res-card.selected');
          if (selCard && selCard.dataset && selCard.dataset.trainNo) selectedTrainNo = selCard.dataset.trainNo;
        } catch(e) { /* ignore */ }
        const payload = {
          old_order_no: _res_currentOrder.order_no,
          userId: _res_currentOrder.user_id,
          start_city: _res_currentOrder.start_city,
          end_city: _res_currentOrder.end_city,
          train_no: selectedTrainNo || (_res_currentOrder.train_no || ''),
          price: Number(resNewPriceInput.value || 0),
          depart_time: (resNewDepartInput.value ? (new Date(resNewDepartInput.value)).toISOString() : _res_currentOrder.depart_time || ''),
          seat_type: resNewSeatInput.value || _res_currentOrder.seat_type || '',
          status: 'paid'
        };
        const resp = await fetch('http://localhost:3000/api/orders/reschedule', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (!resp.ok) { console.error('æ”¹ç­¾ HTTP é”™è¯¯', resp.status); alert('æ”¹ç­¾å¤±è´¥ï¼šHTTP ' + resp.status); return; }
        const result = await resp.json();
        if (result.code === 0) {
          alert('æ”¹ç­¾æˆåŠŸï¼Œæ–°è®¢å•ï¼š' + (result.data && result.data.order_no));
          hideRescheduleModal();
          if (typeof loadOrders === 'function') loadOrders();
        } else {
          alert('æ”¹ç­¾å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (e) { console.error(e); alert('æ”¹ç­¾è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡'); }
    });

    // å§”æ‰˜ï¼šä¸ºåŠ¨æ€ç”Ÿæˆçš„æ”¹ç­¾æŒ‰é’®ç»‘å®šäº‹ä»¶ï¼ˆåœ¨æ¯æ¬¡æ¸²æŸ“åè°ƒç”¨ï¼‰
    function bindRescheduleButtons(){
      document.querySelectorAll('.reschedule-btn').forEach(btn => {
        btn.removeEventListener('click', btn._resHandler);
        btn._resHandler = function(){
          const orderNo = this.closest('.order-item').querySelector('div:first-child').textContent;
          const orders = window._lastOrders || [];
          const order = orders.find(x => x.order_no === orderNo) || null;
          if (!order) return alert('æœªæ‰¾åˆ°è®¢å•æ•°æ®');
          showRescheduleModal(order);
        };
        btn.addEventListener('click', btn._resHandler);
      });
    }


    // ===== 3. æˆ‘çš„12306é¡µé¢é€»è¾‘ =====
    const userMenuItems = document.querySelectorAll('.user-menu-item');
    const userPanels = document.querySelectorAll('.user-panel');
    
    // ä¾§è¾¹æ èœå•åˆ‡æ¢
    userMenuItems.forEach(item => {
      item.addEventListener('click', function() {
        userMenuItems.forEach(menu => menu.classList.remove('active'));
        this.classList.add('active');
        const targetPanel = this.getAttribute('data-menu') + '-panel';
        userPanels.forEach(panel => {
          panel.classList.remove('active');
          if (panel.id === targetPanel) {
            panel.classList.add('active');
            // æ»šåŠ¨é¡µé¢åˆ°è¯¥å¡ç‰‡ï¼ˆå¹³æ»‘æ»šåŠ¨ï¼‰
            try {
              document.getElementById(targetPanel).scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (e) {
              // å®‰å…¨é™çº§ï¼šå¦‚æœå¤±è´¥åˆ™ä¸å½±å“åŠŸèƒ½
            }
            // è‹¥åˆ‡æ¢åˆ°å¸¸ç”¨ä¹˜å®¢é¢æ¿ï¼Œåˆ·æ–°åˆ—è¡¨ï¼ˆè‹¥å‡½æ•°å­˜åœ¨ï¼‰
            if (targetPanel === 'passenger-panel' && typeof loadPassengers === 'function') {
              loadPassengers();
            }
          }
        });
      });
    });

    // æ·»åŠ ä¹˜å®¢é€»è¾‘ï¼ˆä½¿ç”¨å¼¹çª—å¹¶ä¿å­˜åˆ°åç«¯ï¼‰
    const addPassengerBtn = document.getElementById('addPassengerBtn');
    const passengerEmptyState = document.getElementById('passengerEmptyState');
    const passengerListContent = document.getElementById('passengerListContent');
    const passengerModal = document.getElementById('passengerModal');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalSaveBtn = document.getElementById('modalSaveBtn');

    function showPassengerModal(show) {
      passengerModal.style.display = show ? 'block' : 'none';
    }

    // è„±æ•èº«ä»½è¯ï¼šæ©ç›–ç¬¬4ä½åˆ°ç¬¬7ä½ï¼ˆåŸºäº 1-indexedï¼‰
    function maskId(id) {
      if (!id) return '';
      id = String(id);
      // æ ‡å‡†æƒ…å†µï¼šé•¿åº¦å¤§äº7ï¼Œä¿ç•™å‰3ä½ï¼Œæ©ç›–4-7ä½ï¼Œä¿ç•™ç¬¬8ä½åŠä»¥å
      if (id.length > 7) {
        return id.slice(0,3) + '****' + id.slice(7);
      }
      // æ¬¡ä¼˜å¤„ç†ï¼šé•¿åº¦åœ¨4~7ä¹‹é—´ï¼Œå°½é‡æ©ç›–ç¬¬4ä½åˆ°æœ«ä½ï¼ˆæœ€å¤š4ä½ï¼‰
      if (id.length >= 4) {
        const visiblePrefix = id.slice(0,3);
        const maskLen = Math.min(4, id.length - 3);
        return visiblePrefix + '*'.repeat(maskLen) + id.slice(3 + maskLen);
      }
      return id;
    }

    addPassengerBtn.addEventListener('click', function() {
      const currentUser = JSON.parse(localStorage.getItem('12306_loginUser'));
      if (!currentUser || !currentUser.userId) {
        alert('è¯·å…ˆç™»å½•åå†æ·»åŠ å¸¸ç”¨ä¹˜è½¦äºº');
        window.location.href = './login.html';
        return;
      }
      // æ–°å¢æ—¶ç¡®ä¿ä¸ºæ–°å¢çŠ¶æ€
      editingPassengerId = null;
      document.getElementById('modal_passenger_name').value = '';
      document.getElementById('modal_passenger_idcard').value = '';
      document.getElementById('modal_passenger_phone').value = '';
      document.getElementById('modal_passenger_type').value = 'adult';
      showPassengerModal(true);
    });
    modalCancelBtn.addEventListener('click', function() { editingPassengerId = null; showPassengerModal(false); });

    // ä¿å­˜ä¹˜å®¢åˆ°åç«¯
    // ç¼–è¾‘çŠ¶æ€ idï¼ˆnull è¡¨ç¤ºæ–°å¢ï¼‰
    let editingPassengerId = null;

    modalSaveBtn.addEventListener('click', async function() {
      const name = document.getElementById('modal_passenger_name').value.trim();
      const idcard = document.getElementById('modal_passenger_idcard').value.trim();
      const phone = document.getElementById('modal_passenger_phone').value.trim();
      const type = document.getElementById('modal_passenger_type').value;
      const currentUser = JSON.parse(localStorage.getItem('12306_loginUser'));
      if (!currentUser) { alert('è¯·å…ˆç™»å½•'); window.location.href = './login.html'; return; }
      if (!name || !idcard) { alert('è¯·å¡«å†™ä¹˜å®¢å§“åå’Œèº«ä»½è¯å·'); return; }

      try {
        let resp, result;
        if (editingPassengerId) {
          resp = await fetch(`http://localhost:3000/api/frequent_passengers/${editingPassengerId}`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUser.userId, passenger_name: name, passenger_id_card: idcard, passenger_phone: phone, passenger_type: type })
          });
        } else {
          resp = await fetch('http://localhost:3000/api/frequent_passengers', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUser.userId, passenger_name: name, passenger_id_card: idcard, passenger_phone: phone, passenger_type: type })
          });
        }
        result = await resp.json();
        if (result.code === 0) {
          alert(editingPassengerId ? 'æ›´æ–°å¸¸ç”¨ä¹˜å®¢æˆåŠŸ' : 'æ·»åŠ å¸¸ç”¨ä¹˜å®¢æˆåŠŸ');
          showPassengerModal(false);
          // æ¸…ç©º modal
          document.getElementById('modal_passenger_name').value = '';
          document.getElementById('modal_passenger_idcard').value = '';
          document.getElementById('modal_passenger_phone').value = '';
          document.getElementById('modal_passenger_type').value = 'adult';
          editingPassengerId = null;
          // åˆ·æ–°åˆ—è¡¨
          loadPassengers();
        } else {
          alert((editingPassengerId ? 'æ›´æ–°' : 'æ·»åŠ ') + 'å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (err) {
        console.error(err);
        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
      }
    });

    // åŠ è½½å¸¸ç”¨ä¹˜å®¢åˆ—è¡¨
    async function loadPassengers() {
      const currentUser = JSON.parse(localStorage.getItem('12306_loginUser')) || null;
      passengerEmptyState.style.display = 'none';
      passengerListContent.innerHTML = '';
      if (!currentUser || !currentUser.userId) {
        passengerEmptyState.textContent = 'è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹å¸¸ç”¨ä¹˜è½¦äºº';
        passengerEmptyState.style.display = 'block';
        return;
      }
      try {
        const url = `http://localhost:3000/api/frequent_passengers?userId=${currentUser.userId}`;
        const resp = await fetch(url);
        const result = await resp.json();
        if (result.code !== 0) {
          passengerEmptyState.textContent = 'æŸ¥è¯¢å¸¸ç”¨ä¹˜å®¢å¤±è´¥';
          passengerEmptyState.style.display = 'block';
          return;
        }
        const list = result.data || [];
        if (list.length === 0) {
          passengerEmptyState.textContent = 'æš‚æ— å¸¸ç”¨ä¹˜å®¢ï¼Œè¯·æ·»åŠ ';
          passengerEmptyState.style.display = 'block';
          return;
        }
        list.forEach(p => {
          const passengerItem = document.createElement('div');
          passengerItem.className = 'passenger-item';
          passengerItem.innerHTML = `
            <div>${p.passenger_name}</div>
            <div>${maskId(p.passenger_id_card)}</div>
            <div>${p.passenger_phone ? p.passenger_phone : ''}</div>
            <div>${p.passenger_type === 'child' ? 'å°å­©' : 'æˆäºº'}</div>
            <div><button class="order-btn" data-id="${p.id}" data-action="edit">ç¼–è¾‘</button> <button class="order-btn" data-id="${p.id}" data-action="delete">åˆ é™¤</button></div>
          `;
          passengerListContent.appendChild(passengerItem);
        });
        // ç»‘å®šç¼–è¾‘/åˆ é™¤äº‹ä»¶
        passengerListContent.querySelectorAll('button[data-action]').forEach(btn => {
          btn.addEventListener('click', async function() {
            const id = this.dataset.id;
            const action = this.dataset.action;
            if (action === 'delete') {
              if (!confirm('ç¡®å®šåˆ é™¤è¯¥å¸¸ç”¨ä¹˜å®¢å—ï¼Ÿ')) return;
              try {
                const resp = await fetch(`http://localhost:3000/api/frequent_passengers/${id}`, { method: 'DELETE' });
                const r = await resp.json();
                if (r.code === 0) { loadPassengers(); } else { alert('åˆ é™¤å¤±è´¥ï¼š' + (r.msg || 'æœªçŸ¥é”™è¯¯')); }
              } catch (err) { console.error(err); alert('åˆ é™¤è¯·æ±‚å¤±è´¥'); }
            } else if (action === 'edit') {
              // ç¼–è¾‘ï¼šæ ¹æ®å½“å‰ç™»å½•ç”¨æˆ·ä»åç«¯æ‹‰å–å¹¶å¡«å……æ•°æ®
              try {
                const currentUser2 = JSON.parse(localStorage.getItem('12306_loginUser')) || null;
                if (!currentUser2 || !currentUser2.userId) { alert('è¯·å…ˆç™»å½•'); window.location.href = './login.html'; return; }
                const resp2 = await fetch(`http://localhost:3000/api/frequent_passengers?userId=${currentUser2.userId}`);
                const resj = await resp2.json();
                if (resj.code === 0) {
                  const rec = (resj.data || []).find(x => String(x.id) === String(id));
                  if (rec) {
                    document.getElementById('modal_passenger_name').value = rec.passenger_name || '';
                    document.getElementById('modal_passenger_idcard').value = rec.passenger_id_card || '';
                    document.getElementById('modal_passenger_phone').value = rec.passenger_phone || '';
                    document.getElementById('modal_passenger_type').value = rec.passenger_type || 'adult';
                    editingPassengerId = id;
                    showPassengerModal(true);
                  } else {
                    alert('æœªæ‰¾åˆ°è¯¥ä¹˜å®¢ä¿¡æ¯');
                  }
                } else {
                  alert('åŠ è½½ä¹˜å®¢ä¿¡æ¯å¤±è´¥ï¼š' + (resj.msg || 'æœªçŸ¥é”™è¯¯'));
                }
              } catch (err) { console.error(err); alert('åŠ è½½ä¹˜å®¢ä¿¡æ¯å¤±è´¥'); }
            }
          });
        });
      } catch (err) {
        console.error(err);
        passengerEmptyState.textContent = 'åŠ è½½å¸¸ç”¨ä¹˜å®¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡';
        passengerEmptyState.style.display = 'block';
      }
    }

    // åœ¨åˆæ¬¡åŠ è½½é¡µé¢æˆ–åˆ‡æ¢åˆ°ä¹˜å®¢é¢æ¿æ—¶åˆ·æ–°
    if (document.querySelector('.user-menu-item.active') && document.querySelector('.user-menu-item.active').getAttribute('data-menu') === 'passenger') {
      loadPassengers();
    }

    // è´¦æˆ·å®‰å…¨ï¼šä¿®æ”¹ç”¨æˆ·åä¸å¯†ç é€»è¾‘
    const changeUsernameBtn = document.getElementById('changeUsernameBtn');
    const changePasswordBtn = document.getElementById('changePasswordBtn');

    if (changeUsernameBtn) {
      changeUsernameBtn.addEventListener('click', async function() {
        const currentUser = JSON.parse(localStorage.getItem('12306_loginUser'));
        if (!currentUser) { alert('è¯·å…ˆç™»å½•'); window.location.href = './login.html'; return; }
        const newName = prompt('è¯·è¾“å…¥æ–°çš„ç”¨æˆ·åï¼š', currentUser.username || '');
        if (!newName) return;
        try {
          const resp = await fetch('http://localhost:3000/api/user/update', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUser.userId, username: newName })
          });
          const result = await resp.json();
          if (result.code === 0) {
            alert('ç”¨æˆ·åå·²æ›´æ–°');
            // æ›´æ–°æ˜¾ç¤ºä¸ localStorage
            document.getElementById('sidebarUserName').textContent = result.data.username;
            const infoNameEl = document.getElementById('info_username');
            if (infoNameEl) infoNameEl.textContent = result.data.username;
            currentUser.username = result.data.username;
            localStorage.setItem('12306_loginUser', JSON.stringify(currentUser));
            // update logout display
            const loginLink = document.getElementById('loginLink');
            if (loginLink) loginLink.innerHTML = `${currentUser.username} <span style="color: #666; font-weight: normal;">|</span> <span id="logoutBtn" style="color: #d92121; cursor: pointer;">é€€å‡º</span>`;
          } else {
            alert('æ›´æ–°å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (err) {
          console.error(err);
          alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
        }
      });
    }

    if (changePasswordBtn) {
      changePasswordBtn.addEventListener('click', async function() {
        const currentUser = JSON.parse(localStorage.getItem('12306_loginUser'));
        if (!currentUser) { alert('è¯·å…ˆç™»å½•'); window.location.href = './login.html'; return; }
        const newPwd = prompt('è¯·è¾“å…¥æ–°çš„å¯†ç ï¼š');
        if (!newPwd) return;
        const confirmPwd = prompt('è¯·å†æ¬¡è¾“å…¥æ–°çš„å¯†ç ï¼š');
        if (newPwd !== confirmPwd) { alert('ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´'); return; }
        try {
          const resp = await fetch('http://localhost:3000/api/user/update', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUser.userId, password: newPwd })
          });
          const result = await resp.json();
          if (result.code === 0) {
            alert('å¯†ç å·²æ›´æ–°');
          } else {
            alert('æ›´æ–°å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (err) {
          console.error(err);
          alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
        }
      });
    }
  </script>
  <script>
    // èº«ä»½è®¤è¯ä¿å­˜é€»è¾‘
    document.addEventListener('DOMContentLoaded', function() {
      const verifyBtn = document.getElementById('verifyBtn');
      const idPhone = document.getElementById('idPhone');
      const idCard = document.getElementById('idCard');
      const verifyStatus = document.getElementById('verifyStatus');

      // è‹¥å·²ç™»å½•ï¼Œå°è¯•é¢„å¡«
      const loginUser = JSON.parse(localStorage.getItem('12306_loginUser'));
      if (loginUser) {
        if (loginUser.phone) idPhone.value = loginUser.phone;
        if (loginUser.id_card) idCard.value = loginUser.id_card;
        // åŠ è½½å¤´åƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰å¹¶åŒæ­¥å°é¢„è§ˆ
        try {
          const avatarEl = document.getElementById('userAvatar');
          const previewSmall = document.getElementById('avatarPreviewSmall');
          if (loginUser.avatar) {
            if (avatarEl) {
              avatarEl.innerHTML = '';
              const img = document.createElement('img'); img.src = loginUser.avatar; img.alt = 'avatar';
              avatarEl.appendChild(img);
            }
            if (previewSmall) { previewSmall.innerHTML = ''; const s = document.createElement('img'); s.src = loginUser.avatar; s.alt = 'preview'; s.style.width='100%'; s.style.height='100%'; s.style.objectFit='cover'; previewSmall.appendChild(s); }
          }
        } catch(e) {}
      }

      verifyBtn.addEventListener('click', async function() {
        const currentUser = JSON.parse(localStorage.getItem('12306_loginUser'));
        if (!currentUser) {
          alert('è¯·å…ˆç™»å½•åå†è¿›è¡Œèº«ä»½è®¤è¯');
          window.location.href = './login.html';
          return;
        }

        const payload = {
          userId: currentUser.userId,
          phone: idPhone.value,
          id_card: idCard.value
        };

        verifyStatus.textContent = 'ä¿å­˜ä¸­...';

        try {
          const resp = await fetch('http://localhost:3000/api/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await resp.json();
          if (result.code === 0) {
            verifyStatus.textContent = 'è®¤è¯ä¿¡æ¯å·²ä¿å­˜';
            // æ›´æ–° localStorage ä¸­çš„ä¿¡æ¯
            currentUser.phone = payload.phone;
            currentUser.id_card = payload.id_card;
            localStorage.setItem('12306_loginUser', JSON.stringify(currentUser));
            // åˆ‡æ¢ä¸ºå·²è®¤è¯æ˜¾ç¤º
            try {
              const verifyBlock = document.getElementById('verifyBlock');
              const verifyDone = document.getElementById('verifyDone');
              const verifiedInfo = document.getElementById('verifiedInfo');
              if (verifyBlock) verifyBlock.style.display = 'none';
              if (verifyDone) {
                const maskedPhone = String(payload.phone).replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
                const maskedId = maskId(payload.id_card);
                verifiedInfo.textContent = `æ‰‹æœºå· ${maskedPhone}ï¼Œèº«ä»½è¯ ${maskedId}`;
                verifyDone.style.display = 'block';
              }
            } catch (e) {}
          } else {
            verifyStatus.textContent = 'ä¿å­˜å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯');
            alert('ä¿å­˜å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (err) {
          console.error(err);
          verifyStatus.textContent = 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡';
          alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡ï¼ˆhttp://localhost:3000ï¼‰');
        }
      });
      // å¤´åƒä¸Šä¼ å¤„ç†ï¼ˆæœ¬åœ°ä¿å­˜ä¸º dataURLï¼‰
      (function(){
        const input = document.getElementById('avatarInput');
        const uploadBtn = document.getElementById('uploadAvatarBtn');
        const removeBtn = document.getElementById('removeAvatarBtn');
        const previewSmall = document.getElementById('avatarPreviewSmall');
        const setAvatar = (dataUrl) => {
          try {
            const login = JSON.parse(localStorage.getItem('12306_loginUser')) || {};
            login.avatar = dataUrl;
            localStorage.setItem('12306_loginUser', JSON.stringify(login));
            const avatarEl = document.getElementById('userAvatar'); if (avatarEl) {
              avatarEl.innerHTML = '';
              const img = document.createElement('img'); img.src = dataUrl; img.alt = 'avatar'; avatarEl.appendChild(img);
            }
            if (previewSmall) { previewSmall.innerHTML = ''; const s = document.createElement('img'); s.src = dataUrl; s.alt = 'preview'; s.style.width='100%'; s.style.height='100%'; s.style.objectFit='cover'; previewSmall.appendChild(s); }
          } catch(e){ console.error('ä¿å­˜å¤´åƒå¤±è´¥', e); }
        };

        const handleFile = (file) => {
          if (!file) return alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
          if (!file.type.startsWith('image/')) return alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
          if (file.size > 2*1024*1024) return alert('æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ 2MB');
          const reader = new FileReader();
          reader.onload = function(e){ setAvatar(e.target.result); alert('å¤´åƒå·²ä¿å­˜ï¼ˆä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼‰'); };
          reader.onerror = function(e){ console.error('è¯»å–æ–‡ä»¶å¤±è´¥', e); alert('è¯»å–æ–‡ä»¶å¤±è´¥'); };
          reader.readAsDataURL(file);
        };

        if (uploadBtn && input) {
          // ç‚¹å‡»ä¸Šä¼ æŒ‰é’®æ—¶æ‰“å¼€æ–‡ä»¶é€‰æ‹©ï¼›çœŸæ­£å¤„ç†åœ¨ input.change ä¸­
          uploadBtn.addEventListener('click', function(){ input.click(); });
          input.addEventListener('change', function(){ const file = input.files && input.files[0]; if (file) handleFile(file); });
        }
        if (removeBtn) {
          removeBtn.addEventListener('click', function(){
            try {
              const login = JSON.parse(localStorage.getItem('12306_loginUser')) || {};
              delete login.avatar;
              localStorage.setItem('12306_loginUser', JSON.stringify(login));
              const avatarEl = document.getElementById('userAvatar'); if (avatarEl) { avatarEl.innerHTML = ''; }
              if (previewSmall) previewSmall.innerHTML = '';
              alert('å¤´åƒå·²ç§»é™¤');
            } catch(e){ console.error(e); }
          });
        }
      })();
    });
  </script>
</body>
</html>