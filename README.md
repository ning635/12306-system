# ä¸­å›½é“è·¯12306è´­ç¥¨ç³»ç»Ÿ - å¼€å‘æŠ¥å‘Š

---

## ç›®å½•

- [æˆå‘˜è´¡çŒ®æ¯”ä¾‹](#æˆå‘˜è´¡çŒ®æ¯”ä¾‹)
- [1. å¼•è¨€](#1-å¼•è¨€)
  - [1.1 ç¼–å†™ç›®çš„](#11-ç¼–å†™ç›®çš„)
  - [1.2 é¡¹ç›®é£é™©](#12-é¡¹ç›®é£é™©)
  - [1.3 æ–‡æ¡£çº¦å®š](#13-æ–‡æ¡£çº¦å®š)
  - [1.4 é¢„æœŸè¯»è€…å’Œé˜…è¯»å»ºè®®](#14-é¢„æœŸè¯»è€…å’Œé˜…è¯»å»ºè®®)
  - [1.5 äº§å“èŒƒå›´](#15-äº§å“èŒƒå›´)
  - [1.6 å‚è€ƒæ–‡çŒ®](#16-å‚è€ƒæ–‡çŒ®)
- [2. ç³»ç»Ÿæ¦‚è¿°](#2-ç³»ç»Ÿæ¦‚è¿°)
  - [2.1 ç³»ç»Ÿç›®æ ‡](#21-ç³»ç»Ÿç›®æ ‡)
  - [2.2 ç”¨æˆ·ç‰¹ç‚¹](#22-ç”¨æˆ·ç‰¹ç‚¹)
  - [2.3 è¿è¡Œç¯å¢ƒ](#23-è¿è¡Œç¯å¢ƒ)
  - [2.4 è®¾è®¡å’Œå®ç°ä¸Šçš„é™åˆ¶](#24-è®¾è®¡å’Œå®ç°ä¸Šçš„é™åˆ¶)
  - [2.5 å‡è®¾å’Œçº¦æŸ](#25-å‡è®¾å’Œçº¦æŸ)
- [3. å¤–éƒ¨æ¥å£éœ€æ±‚](#3-å¤–éƒ¨æ¥å£éœ€æ±‚)
  - [3.1 ç”¨æˆ·ç•Œé¢](#31-ç”¨æˆ·ç•Œé¢)
  - [3.2 ç¡¬ä»¶æ¥å£](#32-ç¡¬ä»¶æ¥å£)
  - [3.3 è½¯ä»¶æ¥å£](#33-è½¯ä»¶æ¥å£)
  - [3.4 é€šè®¯æ¥å£](#34-é€šè®¯æ¥å£)
- [4. ç³»ç»ŸåŠŸèƒ½éœ€æ±‚](#4-ç³»ç»ŸåŠŸèƒ½éœ€æ±‚)
  - [4.1 ç³»ç»Ÿå‰å°ä¸»è¦åŠŸèƒ½](#41-ç³»ç»Ÿå‰å°ä¸»è¦åŠŸèƒ½)
    - [4.1.1 ç”¨æˆ·è®¤è¯æ¨¡å—](#411-ç”¨æˆ·è®¤è¯æ¨¡å—)
    - [4.1.2 è½¦ç¥¨é¢„è®¢æ¨¡å—](#412-è½¦ç¥¨é¢„è®¢æ¨¡å—)
    - [4.1.3 è®¢å•ç®¡ç†æ¨¡å—](#413-è®¢å•ç®¡ç†æ¨¡å—)
    - [4.1.4 ä¸ªäººä¸­å¿ƒæ¨¡å—](#414-ä¸ªäººä¸­å¿ƒæ¨¡å—)
- [5. ç³»ç»Ÿè®¾è®¡](#5-ç³»ç»Ÿè®¾è®¡)
  - [5.1 ç³»ç»Ÿæ¶æ„è®¾è®¡](#51-ç³»ç»Ÿæ¶æ„è®¾è®¡)
  - [5.2 æ•°æ®åº“è®¾è®¡](#52-æ•°æ®åº“è®¾è®¡)
  - [5.3 æ¥å£è®¾è®¡](#53-æ¥å£è®¾è®¡)
  - [5.4 å‰ç«¯é¡µé¢è®¾è®¡](#54-å‰ç«¯é¡µé¢è®¾è®¡)
  - [5.5 å®‰å…¨è®¾è®¡](#55-å®‰å…¨è®¾è®¡)
- [6. ç³»ç»Ÿå®ç°](#6-ç³»ç»Ÿå®ç°)
  - [6.1 å¼€å‘ç¯å¢ƒæ­å»º](#61-å¼€å‘ç¯å¢ƒæ­å»º)
  - [6.2 æ ¸å¿ƒæ¨¡å—å®ç°](#62-æ ¸å¿ƒæ¨¡å—å®ç°)
  - [6.3 å…³é”®åŠŸèƒ½å®ç°ç»†èŠ‚](#63-å…³é”®åŠŸèƒ½å®ç°ç»†èŠ‚)
- [7. ç³»ç»Ÿæµ‹è¯•](#7-ç³»ç»Ÿæµ‹è¯•)
  - [7.1 æµ‹è¯•ç¯å¢ƒ](#71-æµ‹è¯•ç¯å¢ƒ)
  - [7.2 åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹](#72-åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹)
  - [7.3 æ¥å£æµ‹è¯•](#73-æ¥å£æµ‹è¯•)
  - [7.4 å…¼å®¹æ€§æµ‹è¯•](#74-å…¼å®¹æ€§æµ‹è¯•)
  - [7.5 æµ‹è¯•æ€»ç»“](#75-æµ‹è¯•æ€»ç»“)
- [8. ç³»ç»Ÿéƒ¨ç½²](#8-ç³»ç»Ÿéƒ¨ç½²)
  - [8.1 éƒ¨ç½²æ¶æ„](#81-éƒ¨ç½²æ¶æ„)
  - [8.2 éƒ¨ç½²æ­¥éª¤](#82-éƒ¨ç½²æ­¥éª¤)
  - [8.3 é…ç½®è¯´æ˜](#83-é…ç½®è¯´æ˜)
- [9. é¡¹ç›®æ€»ç»“](#9-é¡¹ç›®æ€»ç»“)
  - [9.1 å·²å®ç°åŠŸèƒ½](#91-å·²å®ç°åŠŸèƒ½)
  - [9.2 æŠ€æœ¯äº®ç‚¹](#92-æŠ€æœ¯äº®ç‚¹)
  - [9.3 å¾…ä¼˜åŒ–é¡¹](#93-å¾…ä¼˜åŒ–é¡¹)
  - [9.4 å­¦ä¹ æ”¶è·](#94-å­¦ä¹ æ”¶è·)
- [é™„å½• Aï¼šå®Œæ•´ä»£ç æ¸…å•](#é™„å½•-aå®Œæ•´ä»£ç æ¸…å•)
- [é™„å½• Bï¼šAPI æ¥å£æ–‡æ¡£](#é™„å½•-bapi-æ¥å£æ–‡æ¡£)
- [é™„å½• Cï¼šæ•°æ®åº“è„šæœ¬](#é™„å½•-cæ•°æ®åº“è„šæœ¬)
- [é™„å½• Dï¼šå‚è€ƒèµ„æ–™](#é™„å½•-då‚è€ƒèµ„æ–™)

---

## æˆå‘˜è´¡çŒ®æ¯”ä¾‹

| æˆå‘˜           | è´Ÿè´£æ¨¡å—           | è´¡çŒ®æ¯”ä¾‹ |
| -------------- | ------------------ | -------- |
| éƒ‘ä½³é‘«ï¼Œè°¢å‰‘é”‹ | å‰ç«¯ç•Œé¢è®¾è®¡ä¸å®ç° | 35%      |
| éƒ‘ä½³é‘«ï¼Œè°¢å‰‘é”‹ | åç«¯APIå¼€å‘        | 35       |
| éƒ‘ä½³é‘«ï¼Œè°¢å‰‘é”‹ | æ•°æ®åº“è®¾è®¡ä¸æµ‹è¯•   | 30%      |

---

## 1. å¼•è¨€

### 1.1 ç¼–å†™ç›®çš„

æœ¬æ–‡æ¡£æ—¨åœ¨è¯¦ç»†æè¿°ä¸­å›½é“è·¯12306æ¨¡æ‹Ÿè´­ç¥¨ç³»ç»Ÿçš„åŠŸèƒ½éœ€æ±‚ã€éåŠŸèƒ½éœ€æ±‚åŠç³»ç»Ÿè®¾è®¡çº¦æŸã€‚é€šè¿‡æœ¬æ–‡æ¡£ï¼Œå¼€å‘å›¢é˜Ÿå¯ä»¥æ˜ç¡®ç³»ç»Ÿçš„åŠŸèƒ½è¾¹ç•Œå’ŒæŠ€æœ¯å®ç°æ–¹æ¡ˆï¼Œä¸ºåç»­çš„ç³»ç»Ÿè®¾è®¡ã€ç¼–ç å®ç°å’Œæµ‹è¯•éªŒè¯æä¾›ä¾æ®ã€‚

æœ¬ç³»ç»Ÿæ¨¡æ‹ŸçœŸå®çš„12306é“è·¯è´­ç¥¨å¹³å°ï¼Œå®ç°ç”¨æˆ·æ³¨å†Œç™»å½•ã€èº«ä»½è®¤è¯ã€è½¦ç¥¨æŸ¥è¯¢ã€åœ¨çº¿è´­ç¥¨ã€è®¢å•ç®¡ç†ã€æ”¯ä»˜ç»‘å®šã€å¸¸ç”¨ä¹˜å®¢ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸ºå­¦ä¹ Webå…¨æ ˆå¼€å‘æä¾›å®Œæ•´çš„å®è·µæ¡ˆä¾‹ã€‚

### 1.2 é¡¹ç›®é£é™©

| é£é™©ç±»åˆ« | é£é™©æè¿°                           | åº”å¯¹æªæ–½                           |
| -------- | ---------------------------------- | ---------------------------------- |
| æŠ€æœ¯é£é™© | Node.js + MySQLæŠ€æœ¯æ ˆå­¦ä¹ æ›²çº¿      | æå‰å­¦ä¹ ç›¸å…³æŠ€æœ¯æ–‡æ¡£ï¼Œå‚è€ƒå®˜æ–¹ç¤ºä¾‹ |
| æ•°æ®é£é™© | ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ï¼ˆèº«ä»½è¯ã€æ‰‹æœºå·ï¼‰æ³„éœ² | å‰ç«¯è„±æ•æ˜¾ç¤ºï¼Œæ•°æ®åº“åŠ å¯†å­˜å‚¨       |
| æ€§èƒ½é£é™© | é«˜å¹¶å‘æŸ¥è¯¢å¯¼è‡´ç³»ç»Ÿå“åº”æ…¢           | ä½¿ç”¨æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ï¼Œå‰ç«¯èŠ‚æµé˜²æŠ–   |
| å®‰å…¨é£é™© | SQLæ³¨å…¥ã€XSSæ”»å‡»                   | ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œè¾“å…¥æ ¡éªŒ           |

### 1.3 æ–‡æ¡£çº¦å®š

- **ä»£ç ç¤ºä¾‹**ï¼šä½¿ç”¨ Markdown ä»£ç å—æ ¼å¼å±•ç¤º
- **æ¥å£è§„èŒƒ**ï¼šRESTful API è®¾è®¡é£æ ¼
- **å‘½åè§„èŒƒ**ï¼š
  - æ•°æ®åº“è¡¨åï¼šå°å†™ä¸‹åˆ’çº¿å‘½åï¼ˆå¦‚ `frequent_passengers`ï¼‰
  - JavaScript å˜é‡ï¼šé©¼å³°å‘½åï¼ˆå¦‚ `loginUser`ï¼‰
  - CSS ç±»åï¼šçŸ­æ¨ªçº¿å‘½åï¼ˆå¦‚ `train-item`ï¼‰

### 1.4 é¢„æœŸè¯»è€…å’Œé˜…è¯»å»ºè®®

| è¯»è€…ç±»å‹ | é˜…è¯»å»ºè®®                                     |
| -------- | -------------------------------------------- |
| é¡¹ç›®ç»ç† | é‡ç‚¹é˜…è¯»ç¬¬1ç« å¼•è¨€å’Œç¬¬2ç« ç³»ç»Ÿæ¦‚è¿°             |
| å¼€å‘äººå‘˜ | é‡ç‚¹é˜…è¯»ç¬¬3ç« å¤–éƒ¨æ¥å£éœ€æ±‚å’Œç¬¬4ç« ç³»ç»ŸåŠŸèƒ½éœ€æ±‚ |
| æµ‹è¯•äººå‘˜ | é‡ç‚¹é˜…è¯»ç¬¬4ç« åŠŸèƒ½éœ€æ±‚å’Œç¬¬5ç« éåŠŸèƒ½éœ€æ±‚       |
| è¿ç»´äººå‘˜ | é‡ç‚¹é˜…è¯»ç¬¬2.3èŠ‚è¿è¡Œç¯å¢ƒå’Œç¬¬5ç« éåŠŸèƒ½éœ€æ±‚     |

### 1.5 äº§å“èŒƒå›´

æœ¬ç³»ç»Ÿä¸ºä¸­å›½é“è·¯12306è´­ç¥¨å¹³å°çš„æ¨¡æ‹Ÿå®ç°ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹åŠŸèƒ½æ¨¡å—ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    12306 æ¨¡æ‹Ÿè´­ç¥¨ç³»ç»Ÿ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ç”¨æˆ·è®¤è¯  â”‚  â”‚è½¦ç¥¨é¢„è®¢  â”‚  â”‚è®¢å•ç®¡ç†  â”‚  â”‚  ä¸ªäººä¸­å¿ƒ      â”‚ â”‚
â”‚  â”‚æ¨¡å—     â”‚  â”‚æ¨¡å—     â”‚  â”‚æ¨¡å—     â”‚  â”‚  æ¨¡å—          â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚â€¢ æ³¨å†Œ   â”‚  â”‚â€¢ è½¦æ¬¡æŸ¥è¯¢â”‚  â”‚â€¢ è®¢å•åˆ—è¡¨â”‚  â”‚â€¢ èº«ä»½è®¤è¯      â”‚ â”‚
â”‚  â”‚â€¢ ç™»å½•   â”‚  â”‚â€¢ å¸­åˆ«é€‰æ‹©â”‚  â”‚â€¢ è®¢å•è¯¦æƒ…â”‚  â”‚â€¢ å¸¸ç”¨ä¹˜å®¢ç®¡ç†  â”‚ â”‚
â”‚  â”‚â€¢ é€€å‡º   â”‚  â”‚â€¢ ä¹˜å®¢é€‰æ‹©â”‚  â”‚â€¢ é€€æ¬¾    â”‚  â”‚â€¢ æ”¯ä»˜ç»‘å®š      â”‚ â”‚
â”‚  â”‚         â”‚  â”‚â€¢ æ”¯ä»˜    â”‚  â”‚â€¢ æ”¹ç­¾    â”‚  â”‚â€¢ å¤´åƒä¸Šä¼       â”‚ â”‚
â”‚  â”‚         â”‚  â”‚â€¢ å€™è¡¥    â”‚  â”‚â€¢ å–æ¶ˆ    â”‚  â”‚â€¢ å¯†ç ä¿®æ”¹      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.6 å‚è€ƒæ–‡çŒ®

1. Express.js å®˜æ–¹æ–‡æ¡£ï¼šhttps://expressjs.com/
2. MySQL 8.0 å‚è€ƒæ‰‹å†Œï¼šhttps://dev.mysql.com/doc/refman/8.0/en/
3. MDN Web æ–‡æ¡£ï¼šhttps://developer.mozilla.org/
4. ä¸­å›½é“è·¯12306å®˜æ–¹ç½‘ç«™ï¼ˆå‚è€ƒUIè®¾è®¡ï¼‰

---

## 2. ç³»ç»Ÿæ¦‚è¿°

### 2.1 ç³»ç»Ÿç›®æ ‡

æœ¬ç³»ç»Ÿçš„ä¸»è¦ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€ç•Œé¢å‹å¥½çš„ç«è½¦ç¥¨åœ¨çº¿è´­ç¥¨æ¨¡æ‹Ÿå¹³å°ï¼Œå…·ä½“ç›®æ ‡åŒ…æ‹¬ï¼š

1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šå®ç°ç”¨æˆ·è®¤è¯ã€è½¦ç¥¨æŸ¥è¯¢ã€åœ¨çº¿è´­ç¥¨ã€è®¢å•ç®¡ç†ã€æ”¹ç­¾é€€ç¥¨ç­‰æ ¸å¿ƒä¸šåŠ¡æµç¨‹
2. **ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›æ¥è¿‘çœŸå®12306çš„ç•Œé¢é£æ ¼å’Œäº¤äº’ä½“éªŒ
3. **æ•°æ®æŒä¹…åŒ–**ï¼šä½¿ç”¨MySQLæ•°æ®åº“å­˜å‚¨ç”¨æˆ·ã€è®¢å•ã€ä¹˜å®¢ç­‰æ ¸å¿ƒæ•°æ®
4. **æ”¯ä»˜æ¨¡æ‹Ÿ**ï¼šæ”¯æŒå¾®ä¿¡ã€æ”¯ä»˜å®ã€Apple Payã€é“¶è”ç­‰å¤šç§æ”¯ä»˜æ–¹å¼çš„ç»‘å®šä¸æ¨¡æ‹Ÿæ”¯ä»˜
5. **å“åº”å¼è®¾è®¡**ï¼šæ”¯æŒPCç«¯å’Œç§»åŠ¨ç«¯çš„è‡ªé€‚åº”æ˜¾ç¤º

### 2.2 ç”¨æˆ·ç‰¹ç‚¹

| ç”¨æˆ·ç±»å‹ | ç‰¹ç‚¹æè¿°                       | ä¸»è¦åŠŸèƒ½éœ€æ±‚                     |
| -------- | ------------------------------ | -------------------------------- |
| æ™®é€šä¹˜å®¢ | éœ€è¦è´­ä¹°ç«è½¦ç¥¨å‡ºè¡Œçš„ç”¨æˆ·       | æŸ¥è¯¢è½¦æ¬¡ã€è´­ç¥¨ã€æŸ¥çœ‹è®¢å•ã€é€€æ”¹ç­¾ |
| å¸¸æ—…å®¢   | é¢‘ç¹å‡ºè¡Œï¼Œéœ€è¦ç®¡ç†å¤šä¸ªä¹˜å®¢ä¿¡æ¯ | å¸¸ç”¨ä¹˜å®¢ç®¡ç†ã€å¿«é€Ÿè´­ç¥¨           |
| æ–°ç”¨æˆ·   | é¦–æ¬¡ä½¿ç”¨ç³»ç»Ÿ                   | æ³¨å†Œã€èº«ä»½è®¤è¯ã€ç»‘å®šæ”¯ä»˜æ–¹å¼     |

### 2.3 è¿è¡Œç¯å¢ƒ

#### 2.3.1 ç¡¬ä»¶ç¯å¢ƒ

| ç»„ä»¶ | æœ€ä½é…ç½®      | æ¨èé…ç½®    |
| ---- | ------------- | ----------- |
| CPU  | åŒæ ¸ 2.0GHz   | å››æ ¸ 3.0GHz |
| å†…å­˜ | 4GB           | 8GB         |
| ç¡¬ç›˜ | 10GB å¯ç”¨ç©ºé—´ | 20GB SSD    |
| ç½‘ç»œ | 100Mbps       | 1Gbps       |

#### 2.3.2 è½¯ä»¶ç¯å¢ƒ

**æœåŠ¡ç«¯ç¯å¢ƒï¼š**

```bash
# Node.js ç‰ˆæœ¬
node --version
# v23.x æˆ–æ›´é«˜ç‰ˆæœ¬

# npm ç‰ˆæœ¬
npm --version
# v10.x æˆ–æ›´é«˜ç‰ˆæœ¬

# MySQL ç‰ˆæœ¬
mysql --version
# mysql Ver 8.0.x
```

**ä¾èµ–åŒ…æ¸…å•ï¼ˆpackage.jsonï¼‰ï¼š**

```json
{
  "name": "12306-backend",
  "version": "1.0.0",
  "description": "12306æ¨¡æ‹Ÿè´­ç¥¨ç³»ç»Ÿåç«¯æœåŠ¡",
  "main": "app.js",
  "scripts": {
    "start": "node app.js",
    "dev": "nodemon app.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mysql2": "^3.6.0"
  }
}
```

**å®¢æˆ·ç«¯ç¯å¢ƒï¼š**

| æµè§ˆå™¨  | æœ€ä½ç‰ˆæœ¬ |
| ------- | -------- |
| Chrome  | 90+      |
| Firefox | 88+      |
| Safari  | 14+      |
| Edge    | 90+      |

### 2.4 è®¾è®¡å’Œå®ç°ä¸Šçš„é™åˆ¶

1. **æ•°æ®åº“é™åˆ¶**ï¼šä»…æ”¯æŒ MySQL æ•°æ®åº“ï¼Œä¸æ”¯æŒå…¶ä»–æ•°æ®åº“ç±»å‹
2. **æ”¯ä»˜é™åˆ¶**ï¼šæ‰€æœ‰æ”¯ä»˜åŠŸèƒ½å‡ä¸ºæ¨¡æ‹Ÿå®ç°ï¼Œä¸æ¶‰åŠçœŸå®èµ„é‡‘äº¤æ˜“
3. **è½¦æ¬¡æ•°æ®**ï¼šä½¿ç”¨æœ¬åœ°é™æ€è½¦æ¬¡æ•°æ®ï¼ˆ`train-data.js`ï¼‰ï¼Œä¸è¿æ¥çœŸå®é“è·¯æ•°æ®æ¥å£
4. **å•æœºéƒ¨ç½²**ï¼šå½“å‰ç‰ˆæœ¬ä»…æ”¯æŒå•æœºéƒ¨ç½²ï¼Œä¸æ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤
5. **è®¤è¯æ–¹å¼**ï¼šä½¿ç”¨ localStorage å­˜å‚¨ç™»å½•çŠ¶æ€ï¼Œæœªä½¿ç”¨ JWT/Session ç­‰æ ‡å‡†è®¤è¯æ–¹æ¡ˆ

### 2.5 å‡è®¾å’Œçº¦æŸ

**å‡è®¾æ¡ä»¶ï¼š**

1. ç”¨æˆ·ä½¿ç”¨ç°ä»£æµè§ˆå™¨è®¿é—®ç³»ç»Ÿï¼ˆæ”¯æŒ ES6+ è¯­æ³•ï¼‰
2. åç«¯æœåŠ¡ä¸æ•°æ®åº“éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨æˆ–åŒä¸€å±€åŸŸç½‘å†…
3. ç”¨æˆ·å…·å¤‡åŸºæœ¬çš„äº’è”ç½‘ä½¿ç”¨ç»éªŒ

**çº¦æŸæ¡ä»¶ï¼š**

1. æ‰€æœ‰è®¢å•å·ä¸º10ä½éšæœºæ•°å­—ï¼Œéœ€ä¿è¯å”¯ä¸€æ€§
2. èº«ä»½è¯å·åœ¨æ˜¾ç¤ºæ—¶éœ€è¿›è¡Œè„±æ•å¤„ç†ï¼ˆéšè—ç¬¬4-7ä½ï¼‰
3. å€™è¡¥è®¢å•ä¸ç«‹å³æ”¯ä»˜ï¼Œç­‰å¾…æœ‰ç¥¨åé€šçŸ¥ç”¨æˆ·
4. æ”¹ç­¾ä»…é™å·²æ”¯ä»˜ä¸”æœªå‡ºå‘çš„è®¢å•

---

## 3. å¤–éƒ¨æ¥å£éœ€æ±‚

### 3.1 ç”¨æˆ·ç•Œé¢

#### 3.1.1 æ•´ä½“å¸ƒå±€

ç³»ç»Ÿé‡‡ç”¨å•é¡µé¢åº”ç”¨ï¼ˆSPAï¼‰æ¶æ„ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹é¡µé¢åŒºåŸŸï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Logo: ä¸­å›½é“è·¯12306          å¯¼èˆªèœå•          ç”¨æˆ·ä¿¡æ¯/ç™»å½•   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚                         å†…å®¹åŒºåŸŸ                               â”‚
â”‚                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                                                      â”‚    â”‚
â”‚   â”‚   â€¢ è½¦ç¥¨é¢„è®¢é¡µé¢                                     â”‚    â”‚
â”‚   â”‚   â€¢ è®¢å•æŸ¥è¯¢é¡µé¢                                     â”‚    â”‚
â”‚   â”‚   â€¢ ä¸ªäººä¸­å¿ƒé¡µé¢ï¼ˆå«èº«ä»½è®¤è¯ã€å¸¸ç”¨ä¹˜å®¢ã€è´¦æˆ·å®‰å…¨ï¼‰    â”‚    â”‚
â”‚   â”‚   â€¢ æ”¯ä»˜ç»‘å®šé¡µé¢                                     â”‚    â”‚
â”‚   â”‚   â€¢ è´­ç¥¨æŒ‡å—é¡µé¢                                     â”‚    â”‚
â”‚   â”‚                                                      â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.1.2 å¯¼èˆªæ è®¾è®¡

```html
<!-- é¡¶éƒ¨å¯¼èˆªæ  HTML ç»“æ„ -->
<div class="header">
  <div class="container header-inner">
    <div class="logo">ä¸­å›½é“è·¯12306</div>
    <div class="nav">
      <div class="nav-item active" data-page="ticket-page">è½¦ç¥¨é¢„è®¢</div>
      <div class="nav-item" data-page="order-page">è®¢å•æŸ¥è¯¢</div>
      <div class="nav-item" data-page="user-page">æˆ‘çš„12306</div>
      <div class="nav-item" data-page="payment-page">æ”¯ä»˜ç»‘å®š</div>
      <div class="nav-item" data-page="guide-page">è´­ç¥¨æŒ‡å—</div>
    </div>
    <div class="user-info">
      <span id="loginLink" style="color: #d92121; cursor: pointer;">è¯·ç™»å½•</span>
    </div>
  </div>
</div>
```

å¯¼èˆªæ æ ·å¼å®ç°ï¼š

```css
/* é¡¶éƒ¨å¯¼èˆªæ æ ·å¼ */
.header {
  background-color: #fff;
  border-bottom: 2px solid #d92121; /* 12306æ ‡å¿—æ€§çº¢è‰² */
  margin-bottom: 30px;
}

.header-inner {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 0;
}

.logo {
  font-size: 28px;
  color: #d92121;
  font-weight: bold;
}

.nav {
  display: flex;
  gap: 30px;
}

.nav-item {
  text-decoration: none;
  color: #333;
  font-size: 16px;
  padding: 5px 0;
  cursor: pointer;
  position: relative;
}

.nav-item.active {
  color: #d92121;
}

.nav-item.active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: #d92121;
}
```

#### 3.1.3 é¡µé¢åˆ‡æ¢é€»è¾‘

```javascript
// é€šç”¨é¡µé¢åˆ‡æ¢é€»è¾‘
const navItems = document.querySelectorAll('.nav-item');
const pages = document.querySelectorAll('.page');

navItems.forEach(item => {
  item.addEventListener('click', function() {
    // åˆ‡æ¢å¯¼èˆªæ¿€æ´»çŠ¶æ€
    navItems.forEach(nav => nav.classList.remove('active'));
    this.classList.add('active');
  
    // åˆ‡æ¢é¡µé¢æ˜¾ç¤º
    const targetPage = this.getAttribute('data-page');
    pages.forEach(page => {
      page.classList.remove('active');
      if (page.id === targetPage) {
        page.classList.add('active');
      }
    });
  
    // ç‰¹å®šé¡µé¢çš„åˆå§‹åŒ–é€»è¾‘
    if (targetPage === 'ticket-page') {
      // è‡ªåŠ¨è§¦å‘è½¦ç¥¨æŸ¥è¯¢
      setTimeout(() => {
        const searchBtn = document.getElementById('searchBtn');
        if (searchBtn) searchBtn.click();
      }, 80);
    }
  
    if (targetPage === 'order-page') {
      // åŠ è½½è®¢å•åˆ—è¡¨
      if (typeof loadOrders === 'function') loadOrders();
    }
  });
});
```

### 3.2 ç¡¬ä»¶æ¥å£

æœ¬ç³»ç»Ÿä¸ºçº¯ Web åº”ç”¨ï¼Œä¸ç›´æ¥ä¸ç¡¬ä»¶äº¤äº’ã€‚æ‰€æœ‰æ•°æ®é€šè¿‡ HTTP åè®®åœ¨æµè§ˆå™¨ä¸æœåŠ¡å™¨ä¹‹é—´ä¼ è¾“ã€‚

### 3.3 è½¯ä»¶æ¥å£

#### 3.3.1 åç«¯ API æ¥å£æ€»è§ˆ

| æ¥å£è·¯å¾„                         | æ–¹æ³•   | åŠŸèƒ½æè¿°     |
| -------------------------------- | ------ | ------------ |
| `/api/register`                | POST   | ç”¨æˆ·æ³¨å†Œ     |
| `/api/login`                   | POST   | ç”¨æˆ·ç™»å½•     |
| `/api/verify`                  | POST   | èº«ä»½è®¤è¯     |
| `/api/user/:id`                | GET    | è·å–ç”¨æˆ·ä¿¡æ¯ |
| `/api/user/update`             | POST   | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ |
| `/api/orders`                  | GET    | æŸ¥è¯¢è®¢å•åˆ—è¡¨ |
| `/api/orders`                  | POST   | åˆ›å»ºè®¢å•     |
| `/api/orders/pay`              | POST   | è®¢å•æ”¯ä»˜     |
| `/api/orders/refund`           | POST   | è®¢å•é€€æ¬¾     |
| `/api/orders/cancel`           | POST   | å–æ¶ˆè®¢å•     |
| `/api/orders/reschedule`       | POST   | è®¢å•æ”¹ç­¾     |
| `/api/frequent_passengers`     | GET    | æŸ¥è¯¢å¸¸ç”¨ä¹˜å®¢ |
| `/api/frequent_passengers`     | POST   | æ·»åŠ å¸¸ç”¨ä¹˜å®¢ |
| `/api/frequent_passengers/:id` | PUT    | æ›´æ–°å¸¸ç”¨ä¹˜å®¢ |
| `/api/frequent_passengers/:id` | DELETE | åˆ é™¤å¸¸ç”¨ä¹˜å®¢ |
| `/api/payment_bindings`        | GET    | æŸ¥è¯¢æ”¯ä»˜ç»‘å®š |
| `/api/payment_bindings`        | POST   | æ·»åŠ æ”¯ä»˜ç»‘å®š |
| `/api/payment_bindings/:id`    | DELETE | åˆ é™¤æ”¯ä»˜ç»‘å®š |

#### 3.3.2 æ•°æ®åº“æ¥å£

**æ•°æ®åº“è¿æ¥é…ç½®ï¼š**

```javascript
const mysql = require('mysql2');

const db = mysql.createConnection({
  host: 'localhost',  
  user: 'root',       
  password: '12345678', 
  database: 'test_db'   
});

db.connect((err) => {
  if (err) {
    console.error('MySQLè¿æ¥å¤±è´¥ï¼š', err);
    return;
  }
  console.log('âœ… MySQLè¿æ¥æˆåŠŸï¼');
});
```

### 3.4 é€šè®¯æ¥å£

#### 3.4.1 HTTP é€šä¿¡åè®®

æ‰€æœ‰ API è¯·æ±‚å‡ä½¿ç”¨ HTTP/1.1 åè®®ï¼Œé»˜è®¤ç«¯å£ä¸º 3000ã€‚

**è¯·æ±‚å¤´é…ç½®ï¼š**

```javascript
// å‰ç«¯ fetch è¯·æ±‚ç¤ºä¾‹
const response = await fetch('http://localhost:3000/api/orders', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(payload)
});
```

**è·¨åŸŸé…ç½®ï¼ˆCORSï¼‰ï¼š**

```javascript
// åç«¯è·¨åŸŸä¸­é—´ä»¶
app.use((req, res, next) => {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  next();
});
```

#### 3.4.2 å“åº”æ ¼å¼è§„èŒƒ

æ‰€æœ‰ API å“åº”å‡é‡‡ç”¨ JSON æ ¼å¼ï¼Œç»Ÿä¸€ç»“æ„å¦‚ä¸‹ï¼š

```typescript
interface APIResponse<T> {
  code: number;      // çŠ¶æ€ç ï¼š0 è¡¨ç¤ºæˆåŠŸï¼Œ-1 è¡¨ç¤ºå¤±è´¥
  msg?: string;      // æç¤ºä¿¡æ¯
  data?: T;          // å“åº”æ•°æ®
}
```

**æˆåŠŸå“åº”ç¤ºä¾‹ï¼š**

```json
{
  "code": 0,
  "msg": "è®¢å•åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 1,
    "order_no": "1234567890",
    "user_id": 1,
    "start_city": "æ·±åœ³",
    "end_city": "ä¸Šæµ·",
    "train_no": "G0005",
    "price": 760.00,
    "status": "paid",
    "created_at": "2025-12-22T10:30:00.000Z"
  }
}
```

**å¤±è´¥å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "code": -1,
  "msg": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼"
}
```

---

## 4. ç³»ç»ŸåŠŸèƒ½éœ€æ±‚

### 4.1 ç³»ç»Ÿå‰å°ä¸»è¦åŠŸèƒ½

#### 4.1.1 ç”¨æˆ·è®¤è¯æ¨¡å—

##### 4.1.1.1 ç”¨æˆ·æ³¨å†Œ

**åŠŸèƒ½æè¿°**ï¼šæ–°ç”¨æˆ·é€šè¿‡å¡«å†™ç”¨æˆ·åå’Œå¯†ç å®Œæˆè´¦å·æ³¨å†Œã€‚

**ç•Œé¢è®¾è®¡**ï¼š

```html
<!-- æ³¨å†Œè¡¨å• (login.html) -->
<form id="registerForm">
  <div class="form-group">
    <label>ç”¨æˆ·å</label>
    <input type="text" id="regUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
  </div>
  <div class="form-group">
    <label>å¯†ç </label>
    <input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
  </div>
  <div class="form-group">
    <label>ç¡®è®¤å¯†ç </label>
    <input type="password" id="regConfirmPwd" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
  </div>
  <button type="submit" class="submit-btn">æ³¨å†Œ</button>
</form>
```

**åç«¯æ¥å£å®ç°**ï¼š

```javascript
// æ³¨å†Œæ¥å£
app.post('/api/register', (req, res) => {
  const { username, password } = req.body;

  // å‚æ•°æ ¡éªŒ
  if (!username || !password) {
    return res.json({ code: -1, msg: 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼' });
  }

  // æ’å…¥ç”¨æˆ·æ•°æ®
  const insertSql = `INSERT INTO user (username, password) VALUES (?, ?)`;
  db.query(insertSql, [username, password], (err, result) => {
    if (err) {
      // å¤„ç†ç”¨æˆ·åé‡å¤
      if (err.code === 'ER_DUP_ENTRY') {
        return res.json({ code: -1, msg: 'ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·æ›´æ¢ï¼' });
      }
      return res.json({ code: -1, msg: 'æ³¨å†Œå¤±è´¥ï¼š' + err.message });
    }
    res.json({ code: 0, msg: 'æ³¨å†ŒæˆåŠŸï¼', data: { userId: result.insertId } });
  });
});
```

##### 4.1.1.2 ç”¨æˆ·ç™»å½•

**åŠŸèƒ½æè¿°**ï¼šå·²æ³¨å†Œç”¨æˆ·é€šè¿‡ç”¨æˆ·åå’Œå¯†ç ç™»å½•ç³»ç»Ÿã€‚

**ç™»å½•é€»è¾‘å®ç°**ï¼š

```javascript
// ç™»å½•æ¥å£
app.post('/api/login', (req, res) => {
  const { username, password } = req.body;

  if (!username || !password) {
    return res.json({ code: -1, msg: 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼' });
  }

  const selectSql = `SELECT id, username FROM user WHERE username = ? AND password = ?`;
  db.query(selectSql, [username, password], (err, results) => {
    if (err) {
      return res.json({ code: -1, msg: 'ç™»å½•å¤±è´¥ï¼š' + err.message });
    }
    if (results.length === 0) {
      return res.json({ code: -1, msg: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼' });
    }
    res.json({
      code: 0,
      msg: 'ç™»å½•æˆåŠŸï¼',
      data: {
        userId: results[0].id,
        username: results[0].username
      }
    });
  });
});
```

**å‰ç«¯ç™»å½•çŠ¶æ€ç®¡ç†**ï¼š

```javascript
// ç™»å½•æˆåŠŸåä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° localStorage
window.onload = function() {
  const loginUser = JSON.parse(localStorage.getItem('12306_loginUser'));
  const loginLink = document.getElementById('loginLink');
  
  if (loginUser) {
    // å·²ç™»å½•ï¼šæ˜¾ç¤ºç”¨æˆ·å + é€€å‡ºæŒ‰é’®
    loginLink.innerHTML = `${loginUser.username} | <span id="logoutBtn">é€€å‡º</span>`;
  
    // é€€å‡ºç™»å½•åŠŸèƒ½
    document.getElementById('logoutBtn').addEventListener('click', function() {
      localStorage.removeItem('12306_loginUser');
      alert('å·²é€€å‡ºç™»å½•ï¼');
      window.location.reload();
    });
  } else {
    // æœªç™»å½•ï¼šç‚¹å‡»è·³è½¬ç™»å½•é¡µ
    loginLink.onclick = function() {
      window.location.href = './login.html'; 
    };
  }
};
```

##### 4.1.1.3 èº«ä»½è®¤è¯

**åŠŸèƒ½æè¿°**ï¼šç”¨æˆ·å¡«å†™æ‰‹æœºå·å’Œèº«ä»½è¯å·å®Œæˆå®åè®¤è¯ï¼Œè®¤è¯åæ–¹å¯è´­ç¥¨ã€‚

**ç•Œé¢è®¾è®¡**ï¼š

```html
<!-- èº«ä»½è®¤è¯æ¨¡å— -->
<div id="verifyBlock">
  <h3>èº«ä»½è®¤è¯</h3>
  <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <input id="idPhone" placeholder="æ‰‹æœºå·" />
    <input id="idCard" placeholder="èº«ä»½è¯å·" />
    <button id="verifyBtn">ä¿å­˜è®¤è¯</button>
  </div>
  <div id="verifyStatus"></div>
</div>

<!-- å·²è®¤è¯çŠ¶æ€æ˜¾ç¤º -->
<div id="verifyDone" style="display:none;">
  <h3>èº«ä»½è®¤è¯</h3>
  <div id="verifiedInfo">å·²è®¤è¯</div>
</div>
```

**è®¤è¯æ¥å£å®ç°**ï¼š

```javascript
// èº«ä»½è®¤è¯æ¥å£
app.post('/api/verify', (req, res) => {
  const { userId, phone, id_card } = req.body;

  if (!userId) {
    return res.json({ code: -1, msg: 'ç¼ºå°‘ userId å‚æ•°' });
  }

  const updateSql = `UPDATE user SET phone = ?, id_card = ? WHERE id = ?`;
  db.query(updateSql, [phone || '', id_card || '', userId], (err, result) => {
    if (err) {
      return res.json({ code: -1, msg: 'ä¿å­˜å¤±è´¥ï¼š' + err.message });
    }

    // è¿”å›æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯
    db.query('SELECT id, username, phone, id_card FROM user WHERE id = ?', [userId], (err2, rows) => {
      if (err2) {
        return res.json({ code: -1, msg: 'æŸ¥è¯¢å¤±è´¥ï¼š' + err2.message });
      }
      res.json({ code: 0, msg: 'è®¤è¯ä¿¡æ¯å·²ä¿å­˜', data: rows[0] });
    });
  });
});
```

**èº«ä»½è¯è„±æ•å¤„ç†**ï¼š

```javascript
// è„±æ•èº«ä»½è¯ï¼šæ©ç›–ç¬¬4ä½åˆ°ç¬¬7ä½
function maskId(id) {
  if (!id) return '';
  id = String(id);
  if (id.length > 7) {
    return id.slice(0, 3) + '****' + id.slice(7);
  }
  if (id.length >= 4) {
    const visiblePrefix = id.slice(0, 3);
    const maskLen = Math.min(4, id.length - 3);
    return visiblePrefix + '*'.repeat(maskLen) + id.slice(3 + maskLen);
  }
  return id;
}

// ç¤ºä¾‹ï¼š440305199001011234 â†’ 440****199001011234 â†’ 440****9001011234
```

---


#### 4.1.2 è½¦ç¥¨é¢„è®¢æ¨¡å—

##### 4.1.2.1 è½¦æ¬¡æŸ¥è¯¢

**åŠŸèƒ½æè¿°**ï¼šç”¨æˆ·é€‰æ‹©å‡ºå‘åœ°ã€ç›®çš„åœ°å’Œæ—¥æœŸåï¼Œç³»ç»Ÿä»æœ¬åœ°è½¦æ¬¡æ•°æ®ä¸­ç­›é€‰åŒ¹é…çš„è½¦æ¬¡ã€‚

**æŸ¥è¯¢è¡¨å•ç•Œé¢**ï¼š

```html
<!-- è½¦ç¥¨æŸ¥è¯¢è¡¨å• -->
<form class="search-form" id="trainSearchForm">
  <div class="form-item">
    <label for="startCity">å‡ºå‘åœ°</label>
    <select id="startCity">
      <option value="åŒ—äº¬">åŒ—äº¬</option>
      <option value="ä¸Šæµ·">ä¸Šæµ·</option>
      <option value="å¹¿å·">å¹¿å·</option>
      <option value="æ·±åœ³" selected>æ·±åœ³</option>
      <option value="æˆéƒ½">æˆéƒ½</option>
      <option value="é‡åº†">é‡åº†</option>
      <option value="æ­å·">æ­å·</option>
      <option value="å—äº¬">å—äº¬</option>
      <option value="æ­¦æ±‰">æ­¦æ±‰</option>
      <option value="è¥¿å®‰">è¥¿å®‰</option>
      <!-- æ›´å¤šåŸå¸‚... -->
    </select>
  </div>
  <div class="form-item">
    <label for="endCity">åˆ°è¾¾åœ°</label>
    <select id="endCity">
      <option value="ä¸Šæµ·" selected>ä¸Šæµ·</option>
      <!-- åŸå¸‚é€‰é¡¹åŒä¸Š -->
    </select>
  </div>
  <div class="form-item">
    <label for="trainDate">å‡ºå‘æ—¥æœŸ</label>
    <input type="date" id="trainDate" value="">
  </div>
  <div class="form-item">
    <label for="seatType">å¸­åˆ«</label>
    <select id="seatType">
      <option value="all">å…¨éƒ¨å¸­åˆ«</option>
      <option value="äºŒç­‰åº§">äºŒç­‰åº§</option>
      <option value="ä¸€ç­‰åº§">ä¸€ç­‰åº§</option>
      <option value="æ— åº§">æ— åº§</option>
    </select>
  </div>
  <button type="button" class="search-btn" id="searchBtn">æŸ¥è¯¢è½¦ç¥¨</button>
</form>
```

**è½¦æ¬¡æ•°æ®ç»“æ„ï¼ˆtrain-data.jsï¼‰**ï¼š

```javascript
// ç«è½¦ç­æ¬¡æ ·æœ¬æ•°æ®
const trainData = [
  { 
    "number": "G0005",           // è½¦æ¬¡å·
    "startStation": "æ·±åœ³åŒ—",     // å‡ºå‘ç«™
    "endStation": "ä¸Šæµ·å—",       // åˆ°è¾¾ç«™
    "startTime": "04:20",         // å‡ºå‘æ—¶é—´
    "endTime": "12:10",           // åˆ°è¾¾æ—¶é—´
    "duration": "7å°æ—¶50åˆ†",      // å†æ—¶
    "secondSeatPrice": "760",     // äºŒç­‰åº§ä»·æ ¼
    "firstSeatPrice": "1210",     // ä¸€ç­‰åº§ä»·æ ¼
    "seatAvailability": {         // ä½™ç¥¨ä¿¡æ¯
      "second": 3,                // äºŒç­‰åº§ä½™ç¥¨
      "first": 1,                 // ä¸€ç­‰åº§ä½™ç¥¨
      "noSeat": 0                 // æ— åº§ï¼ˆ1æœ‰ç¥¨ï¼Œ0æ— ç¥¨ï¼‰
    }
  },
  { 
    "number": "G0006", 
    "startStation": "æ·±åœ³ä¸œ", 
    "endStation": "ä¸Šæµ·è™¹æ¡¥", 
    "startTime": "05:30", 
    "endTime": "13:20", 
    "duration": "7å°æ—¶50åˆ†", 
    "secondSeatPrice": "770", 
    "firstSeatPrice": "1225", 
    "seatAvailability": { "second": 10, "first": 2, "noSeat": 1 } 
  },
  // ... æ›´å¤šè½¦æ¬¡æ•°æ®ï¼ˆå…±150+æ¡ï¼‰
];

// æš´éœ²ä¸ºå…¨å±€å˜é‡ä¾›å‰ç«¯ä½¿ç”¨
if (typeof window !== 'undefined') {
  window.trainData = trainData;
}
```

**è½¦æ¬¡æŸ¥è¯¢é€»è¾‘å®ç°**ï¼š

```javascript
// è½¦ç¥¨æŸ¥è¯¢æ ¸å¿ƒé€»è¾‘
const searchBtn = document.getElementById('searchBtn');
const trainList = document.getElementById('trainList');
const ticketEmptyState = document.getElementById('ticketEmptyState');

// é˜²æŠ–æ§åˆ¶
let __searchLock = false;
let __lastSearchAt = 0;
const __SEARCH_DEBOUNCE_MS = 800;

searchBtn.addEventListener('click', function() {
  // 1. è·å–ç”¨æˆ·è¾“å…¥
  const startCity = document.getElementById('startCity').value.trim();
  const endCity = document.getElementById('endCity').value.trim();
  const date = document.getElementById('trainDate').value;

  // 2. åŸºç¡€æ ¡éªŒ
  if (!startCity || !endCity || !date) {
    alert('è¯·å¡«å†™å®Œæ•´çš„å‡ºå‘åœ°ã€åˆ°è¾¾åœ°å’Œæ—¥æœŸï¼');
    return;
  }

  // 3. é˜²æŠ–å¤„ç†
  const now = Date.now();
  if (__searchLock || (now - __lastSearchAt) < __SEARCH_DEBOUNCE_MS) {
    return;
  }
  __searchLock = true;
  __lastSearchAt = now;

  // 4. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  ticketEmptyState.textContent = "æ­£åœ¨æŸ¥è¯¢è½¦æ¬¡ä¿¡æ¯...";
  ticketEmptyState.style.display = 'block';

  // 5. æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿåæ‰§è¡ŒæŸ¥è¯¢
  setTimeout(() => {
    try {
      // åˆ¤æ–­æ˜¯å¦æŸ¥è¯¢å½“å¤©è½¦æ¬¡
      const selectedDate = document.getElementById('trainDate').value;
      const todayStr = new Date().toISOString().slice(0, 10);
      const isSearchingToday = (selectedDate === todayStr);

      // ç­›é€‰è½¦æ¬¡ï¼ˆæ¨¡ç³ŠåŒ¹é…åŸå¸‚åï¼‰
      const filteredTrains = window.trainData.filter(train => {
        const startMatch = train.startStation.includes(startCity);
        const endMatch = train.endStation.includes(endCity);
        if (!(startMatch && endMatch)) return false;

        // å¦‚æœæŸ¥è¯¢å½“å¤©ï¼Œåªæ˜¾ç¤ºå°šæœªå‘è½¦çš„è½¦æ¬¡
        if (isSearchingToday) {
          try {
            let t = String(train.startTime || '').trim();
            if (/^\d{1,2}:\d{2}$/.test(t)) t = t + ':00';
            const dtStr = selectedDate + 'T' + t;
            const dt = new Date(dtStr);
            if (!isNaN(dt.getTime())) {
              return dt.getTime() > Date.now();
            }
          } catch (e) { return true; }
        }
        return true;
      });

      // 6. æ¸…ç©ºåŸæœ‰åˆ—è¡¨
      document.querySelectorAll('.train-item').forEach(item => item.remove());

      // 7. å¤„ç†ç©ºç»“æœ
      if (filteredTrains.length === 0) {
        ticketEmptyState.textContent = "æœªæŸ¥è¯¢åˆ°ç¬¦åˆæ¡ä»¶çš„è½¦æ¬¡ï¼Œè¯·æ›´æ¢åŸå¸‚é‡è¯•ï¼";
        ticketEmptyState.style.display = 'block';
        return;
      }
      ticketEmptyState.style.display = 'none';

      // 8. æ¸²æŸ“è½¦æ¬¡åˆ—è¡¨
      filteredTrains.forEach(train => {
        const trainItem = document.createElement('div');
        trainItem.className = 'train-item';
      
        // æ ¼å¼åŒ–ä½™ç¥¨æ˜¾ç¤º
        const ava = train.seatAvailability || {};
        function availDisplay(v) {
          if (v === undefined || v === null) return 'æœªçŸ¥';
          const n = Number(v);
          if (!isNaN(n)) {
            if (n === 0) return 'æ— ç¥¨';
            if (n > 10) return 'æœ‰ç¥¨';
            return `ä½™${n}å¼ `;
          }
          return String(v);
        }
      
        trainItem.innerHTML = `
          <div class="train-number">${train.number}</div>
          <div>${train.startStation}<br/><small>${train.startTime}</small></div>
          <div>${train.endStation}<br/><small>${train.endTime}</small></div>
          <div>${train.duration}</div>
          <div>Â¥${train.secondSeatPrice}<br/><small>${availDisplay(ava.second)}</small></div>
          <div>Â¥${train.firstSeatPrice}<br/><small>${availDisplay(ava.first)}</small></div>
          <div>
            <button class="ticket-btn"
              data-train-no="${train.number}"
              data-second-price="${train.secondSeatPrice}"
              data-first-price="${train.firstSeatPrice}"
              data-start-station="${train.startStation}"
              data-end-station="${train.endStation}"
              data-depart="${train.startTime}"
              data-ava-second="${ava.second}"
              data-ava-first="${ava.first}"
              data-ava-noseat="${ava.noSeat}"
            >é¢„è®¢</button>
          </div>
        `;
        trainList.appendChild(trainItem);
      });
    
      // 9. ç»‘å®šé¢„è®¢æŒ‰é’®äº‹ä»¶
      bindBookingButtons();
    
    } finally {
      __searchLock = false;
    }
  }, 100);
});
```

**è½¦æ¬¡åˆ—è¡¨æ ·å¼**ï¼š

```css
/* è½¦æ¬¡åˆ—è¡¨å®¹å™¨ */
.train-list {
  margin-top: 20px;
  border: 1px solid #eee;
  border-radius: 4px;
}

/* åˆ—è¡¨å¤´éƒ¨ */
.list-header {
  display: grid;
  grid-template-columns: 1fr 2fr 2fr 1fr 1fr 1fr 1fr;
  background-color: #f8f8f8;
  padding: 10px;
  font-weight: bold;
  color: #333;
  border-bottom: 1px solid #eee;
}

/* è½¦æ¬¡è¡Œ */
.train-item {
  display: grid;
  grid-template-columns: 1fr 2fr 2fr 1fr 1fr 1fr 1fr;
  padding: 15px 10px;
  border-bottom: 1px solid #eee;
  align-items: center;
}

.train-item:hover {
  background-color: #fafafa;
}

/* è½¦æ¬¡å·é«˜äº® */
.train-number {
  font-weight: bold;
  color: #d92121;
}

/* é¢„è®¢æŒ‰é’® */
.ticket-btn {
  padding: 8px 14px;
  background: linear-gradient(180deg, #ff4b4b, #d92121);
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  box-shadow: 0 6px 18px rgba(217, 33, 33, 0.18);
  transition: transform 0.12s ease, box-shadow 0.12s ease;
}

.ticket-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 26px rgba(217, 33, 33, 0.22);
}
```

##### 4.1.2.2 é¢„è®¢å¼¹çª—

**åŠŸèƒ½æè¿°**ï¼šç‚¹å‡»"é¢„è®¢"æŒ‰é’®åï¼Œå¼¹å‡ºç¡®è®¤å¼¹çª—ï¼Œç”¨æˆ·é€‰æ‹©å¸­åˆ«ã€ä¹˜å®¢å’Œæ”¯ä»˜æ–¹å¼ã€‚

**å¼¹çª—ç•Œé¢ç»“æ„**ï¼š

```html
<!-- é¢„è®¢é®ç½©å±‚ -->
<div id="bookingBackdrop" class="modal-backdrop"></div>

<!-- é¢„è®¢ç¡®è®¤å¼¹çª— -->
<div id="bookingModal">
  <h4>ç¡®è®¤é¢„è®¢</h4>
  <div style="display:flex; flex-direction:column; gap:10px;">
    <!-- è½¦æ¬¡ä¿¡æ¯å±•ç¤º -->
    <div id="bookingTrainInfo"></div>
  
    <!-- å€™è¡¥æç¤ºï¼ˆä»…åœ¨é€‰æ‹©å·²å”®ç½„å¸­åˆ«æ—¶æ˜¾ç¤ºï¼‰ -->
    <div id="bookingWaitHint" style="color:#d92121; display:none;">
      å€™è¡¥è®¢å•æ— éœ€ç«‹å³åœ¨çº¿æ”¯ä»˜ï¼Œè¯·ç­‰å¾…æœ‰ç¥¨åç³»ç»Ÿé€šçŸ¥æ‚¨ç»§ç»­æ”¯ä»˜ã€‚
    </div>
  
    <!-- å¸­åˆ«é€‰æ‹© -->
    <label>é€‰æ‹©å¸­åˆ«</label>
    <select id="booking_seat_select">
      <option value="" disabled selected>è¯·é€‰æ‹©å¸­åˆ«</option>
      <option value="ä¸€ç­‰åº§">ä¸€ç­‰åº§</option>
      <option value="äºŒç­‰åº§">äºŒç­‰åº§</option>
    </select>
  
    <!-- ä¹˜å®¢é€‰æ‹© -->
    <label>ä¹˜å®¢</label>
    <select id="booking_passenger_select">
      <option value="" disabled selected>è¯·é€‰æ‹©ä¹˜å®¢ï¼ˆæœ¬äººæˆ–å¸¸ç”¨ä¹˜è½¦äººï¼‰</option>
    </select>
  
    <!-- æ”¯ä»˜æ–¹å¼ -->
    <label>æ”¯ä»˜æ–¹å¼</label>
    <div class="payment-options">
      <label><input type="radio" name="booking_payment" value="wechat" checked> ğŸŸ¢ å¾®ä¿¡æ”¯ä»˜</label>
      <label><input type="radio" name="booking_payment" value="alipay"> ğŸ”µ æ”¯ä»˜å®</label>
      <label><input type="radio" name="booking_payment" value="apple_pay"> Apple Pay</label>
      <label><input type="radio" name="booking_payment" value="unionpay"> ğŸ”´ é“¶è”</label>
      <label><input type="radio" name="booking_payment" value="other"> âšª å…¶ä»–</label>
    </div>
  
    <!-- æ“ä½œæŒ‰é’® -->
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="bookingCancelBtn" class="order-btn">å–æ¶ˆ</button>
      <button id="bookingConfirmBtn" class="search-btn">ç¡®è®¤å¹¶æ”¯ä»˜</button>
    </div>
  </div>
</div>
```

**å¼¹çª—æ˜¾ç¤º/éšè—æ§åˆ¶**ï¼š

```javascript
// é¢„è®¢å¼¹çª—æ§åˆ¶å‡½æ•°
window.showBookingModal = function(show) {
  const bookingModal = document.getElementById('bookingModal');
  const bookingBackdrop = document.getElementById('bookingBackdrop');
  
  bookingModal.style.display = show ? 'block' : 'none';
  bookingBackdrop.style.display = show ? 'block' : 'none';
  document.body.style.overflow = show ? 'hidden' : '';

  // å¼¹çª—æ‰“å¼€æ—¶ï¼Œå¡«å……ä¹˜å®¢ä¸‹æ‹‰åˆ—è¡¨
  if (show) {
    fillPassengerSelect();
  }
};

// å¼‚æ­¥å¡«å……ä¹˜å®¢ä¸‹æ‹‰ï¼ˆæœ¬äºº + å¸¸ç”¨ä¹˜è½¦äººï¼‰
async function fillPassengerSelect() {
  const select = document.getElementById('booking_passenger_select');
  if (!select) return;
  
  // æ¸…ç©ºå¹¶æ·»åŠ å ä½é¡¹
  select.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©ä¹˜å®¢ï¼ˆæœ¬äººæˆ–å¸¸ç”¨ä¹˜è½¦äººï¼‰</option>';
  
  const loginUser = JSON.parse(localStorage.getItem('12306_loginUser')) || null;
  
  // æ·»åŠ "æœ¬äºº"é€‰é¡¹
  if (loginUser) {
    const selfOption = document.createElement('option');
    selfOption.value = 'self';
    selfOption.textContent = `æœ¬äºº - ${loginUser.name || loginUser.username}`;
    selfOption.dataset.name = loginUser.name || loginUser.username || '';
    selfOption.dataset.id = loginUser.id_card || '';
    selfOption.dataset.phone = loginUser.phone || '';
    select.appendChild(selfOption);
    select.value = 'self'; // é»˜è®¤é€‰ä¸­æœ¬äºº
  }
  
  // ä»åç«¯åŠ è½½å¸¸ç”¨ä¹˜è½¦äºº
  try {
    const uid = loginUser ? loginUser.userId : '';
    if (uid) {
      const resp = await fetch(`http://localhost:3000/api/frequent_passengers?userId=${uid}`);
      const result = await resp.json();
      if (result.code === 0 && Array.isArray(result.data)) {
        result.data.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = `${p.passenger_name} (${p.passenger_phone || ''})`;
          opt.dataset.name = p.passenger_name || '';
          opt.dataset.id = p.passenger_id_card || '';
          opt.dataset.phone = p.passenger_phone || '';
          select.appendChild(opt);
        });
      }
    }
  } catch (e) {
    console.error('åŠ è½½å¸¸ç”¨ä¹˜è½¦äººå¤±è´¥', e);
  }
}
```

##### 4.1.2.3 å¸­åˆ«é€‰æ‹©ä¸å€™è¡¥é€»è¾‘

**åŠŸèƒ½æè¿°**ï¼šæ ¹æ®ä½™ç¥¨æƒ…å†µåŠ¨æ€ç”Ÿæˆå¸­åˆ«é€‰é¡¹ï¼Œå·²å”®ç½„çš„å¸­åˆ«æ ‡è®°ä¸º"å¯å€™è¡¥"ã€‚

```javascript
// åŠ¨æ€ç”Ÿæˆå¸­åˆ«é€‰é¡¹
function populateSeatOptions(currentBooking) {
  const bookingSeatSelect = document.getElementById('booking_seat_select');
  const { avaSecond, avaFirst, avaNo } = currentBooking;
  
  const createOption = (val, label, avail) => {
    let text = label;
    let attrs = '';
  
    if (typeof avail === 'number') {
      if (avail === 0) {
        text += 'ï¼ˆå·²å”®ç½„ï¼Œå¯å€™è¡¥ï¼‰';
        attrs = ' data-wait="1"'; // æ ‡è®°ä¸ºå€™è¡¥
      } else {
        text += `ï¼ˆä½™${avail}å¼ ï¼‰`;
      }
    }
  
    return `<option value="${val}"${attrs}>${text}</option>`;
  };
  
  let opts = ['<option value="" disabled selected>è¯·é€‰æ‹©å¸­åˆ«</option>'];
  opts.push(createOption('ä¸€ç­‰åº§', 'ä¸€ç­‰åº§', avaFirst));
  opts.push(createOption('äºŒç­‰åº§', 'äºŒç­‰åº§', avaSecond));
  
  // æ— åº§é€‰é¡¹
  if (avaNo !== null && avaNo !== undefined) {
    const noText = avaNo === 1 ? 'ï¼ˆæœ‰ç¥¨ï¼‰' : 'ï¼ˆæ— ç¥¨ï¼Œå¯å€™è¡¥ï¼‰';
    const noAttrs = avaNo === 0 ? ' data-wait="1"' : '';
    opts.push(`<option value="æ— åº§"${noAttrs}>æ— åº§${noText}</option>`);
  }
  
  bookingSeatSelect.innerHTML = opts.join('');
}

// æ ¹æ®å¸­åˆ«é€‰æ‹©æ›´æ–°æŒ‰é’®çŠ¶æ€å’Œæ”¯ä»˜é€‰é¡¹
function updateBookingActionUI() {
  const bookingSeatSelect = document.getElementById('booking_seat_select');
  const bookingConfirmBtn = document.getElementById('bookingConfirmBtn');
  const waitHint = document.getElementById('bookingWaitHint');
  
  const selected = bookingSeatSelect.options[bookingSeatSelect.selectedIndex];
  const isWait = selected && selected.dataset.wait === '1';
  
  if (isWait) {
    // å€™è¡¥æ¨¡å¼ï¼šç¦ç”¨æ”¯ä»˜é€‰é¡¹
    bookingConfirmBtn.textContent = 'å€™è¡¥';
    document.querySelectorAll('input[name="booking_payment"]').forEach(r => {
      r.checked = false;
      r.disabled = true;
      r.parentElement.style.opacity = '0.6';
    });
    waitHint.style.display = 'block';
  } else {
    // æ­£å¸¸è´­ç¥¨æ¨¡å¼
    bookingConfirmBtn.textContent = 'ç¡®è®¤å¹¶æ”¯ä»˜';
  
    // æ ¹æ®ç»‘å®šçŠ¶æ€å¯ç”¨/ç¦ç”¨æ”¯ä»˜é€‰é¡¹
    const bindings = JSON.parse(localStorage.getItem('paymentBindings') || '{}');
    document.querySelectorAll('input[name="booking_payment"]').forEach(r => {
      const bound = bindings[r.value] && bindings[r.value].account;
      r.disabled = !bound;
      r.parentElement.style.opacity = bound ? '' : '0.5';
      if (!bound) r.checked = false;
    });
    waitHint.style.display = 'none';
  }
}

// ç»‘å®šå¸­åˆ«å˜åŒ–äº‹ä»¶
document.getElementById('booking_seat_select').addEventListener('change', updateBookingActionUI);
```

##### 4.1.2.4 è®¢å•åˆ›å»º

**åŠŸèƒ½æè¿°**ï¼šæ ¹æ®ç”¨æˆ·é€‰æ‹©åˆ›å»ºè®¢å•ï¼Œæ”¯æŒå€™è¡¥å’Œæ”¯ä»˜ä¸¤ç§æ¨¡å¼ã€‚

**åç«¯åˆ›å»ºè®¢å•æ¥å£**ï¼š

```javascript
// åˆ›å»ºè®¢å•æ¥å£
app.post('/api/orders', (req, res) => {
  const { 
    userId, start_city, end_city, train_no, price, 
    depart_time, seat_type, status, payment_method,
    passenger_name, passenger_id_card, passenger_phone
  } = req.body;
  
  // æ ¡éªŒå¿…å¡«å­—æ®µ
  if (!start_city || !end_city) {
    return res.json({ code: -1, msg: 'å‡ºå‘åœ°å’Œç›®çš„åœ°ä¸èƒ½ä¸ºç©º' });
  }

  // ç”Ÿæˆ 10 ä½å”¯ä¸€è®¢å•å·
  generateUniqueOrderNo(5, (genErr, orderNo) => {
    if (genErr) {
      return res.json({ code: -1, msg: 'ç”Ÿæˆè®¢å•å·å¤±è´¥ï¼š' + genErr.message });
    }
  
    const insertSql = `
      INSERT INTO orders (
        order_no, user_id, start_city, end_city, train_no, 
        price, depart_time, seat_type, status, payment_method
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `;
  
    db.query(insertSql, [
      orderNo, userId, start_city, end_city, train_no,
      price, depart_time, seat_type, status || 'pending', payment_method
    ], (err, result) => {
      if (err) {
        return res.json({ code: -1, msg: 'åˆ›å»ºè®¢å•å¤±è´¥ï¼š' + err.message });
      }
    
      // è¿”å›æ–°åˆ›å»ºçš„è®¢å•ä¿¡æ¯
      const selectSql = 'SELECT * FROM orders WHERE id = ?';
      db.query(selectSql, [result.insertId], (err2, rows) => {
        if (err2) {
          return res.json({ code: -1, msg: 'æŸ¥è¯¢æ–°è®¢å•å¤±è´¥' });
        }
        res.json({ code: 0, msg: 'è®¢å•åˆ›å»ºæˆåŠŸ', data: rows[0] });
      });
    });
  });
});

// ç”Ÿæˆ 10 ä½å”¯ä¸€è®¢å•å·
function generateUniqueOrderNo(attempts, cb) {
  const candidate = String(Math.floor(Math.random() * 1e10)).padStart(10, '0');
  
  db.query('SELECT 1 FROM orders WHERE order_no = ?', [candidate], (err, rows) => {
    if (err) return cb(err);
  
    if (rows && rows.length > 0) {
      // è®¢å•å·å·²å­˜åœ¨ï¼Œé‡è¯•
      if (attempts <= 0) return cb(new Error('æ— æ³•ç”Ÿæˆå”¯ä¸€è®¢å•å·'));
      return setImmediate(() => generateUniqueOrderNo(attempts - 1, cb));
    }
  
    cb(null, candidate);
  });
}
```

**å‰ç«¯ç¡®è®¤æŒ‰é’®å¤„ç†**ï¼š

```javascript
// ç¡®è®¤é¢„è®¢æŒ‰é’®å¤„ç†
document.getElementById('bookingConfirmBtn').addEventListener('click', async function() {
  const currentBooking = window.currentBooking;
  if (!currentBooking) {
    showBookingModal(false);
    return;
  }
  
  const loginUser = JSON.parse(localStorage.getItem('12306_loginUser'));
  if (!loginUser) {
    alert('ç™»å½•ä¿¡æ¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
    window.location.href = './login.html';
    return;
  }

  const seatTypeSelected = document.getElementById('booking_seat_select').value;
  if (!seatTypeSelected) {
    alert('è¯·å…ˆé€‰æ‹©å¸­åˆ«å†ä¸‹å•');
    return;
  }

  // æ ¹æ®å¸­åˆ«ç¡®å®šä»·æ ¼
  let price = currentBooking.secondPrice;
  if (seatTypeSelected.includes('ä¸€ç­‰')) {
    price = currentBooking.firstPrice;
  }

  // è·å–é€‰ä¸­çš„ä¹˜å®¢ä¿¡æ¯
  const passengerSelect = document.getElementById('booking_passenger_select');
  const selectedOpt = passengerSelect.options[passengerSelect.selectedIndex];
  const passenger_name = selectedOpt?.dataset.name || '';
  const passenger_id_card = selectedOpt?.dataset.id || '';
  const passenger_phone = selectedOpt?.dataset.phone || '';

  // åˆ¤æ–­æ˜¯å¦ä¸ºå€™è¡¥è®¢å•
  const selectedSeatOpt = document.getElementById('booking_seat_select')
                                   .options[document.getElementById('booking_seat_select').selectedIndex];
  const isWait = selectedSeatOpt?.dataset.wait === '1';

  if (isWait) {
    // å€™è¡¥è®¢å•ï¼šç›´æ¥åˆ›å»ºï¼ŒçŠ¶æ€ä¸º waitlist
    const payload = {
      userId: loginUser.userId,
      start_city: currentBooking.start,
      end_city: currentBooking.end,
      train_no: currentBooking.trainNo,
      price: price,
      depart_time: document.getElementById('trainDate').value + ' ' + currentBooking.depart,
      seat_type: seatTypeSelected,
      status: 'waitlist',
      passenger_name,
      passenger_id_card,
      passenger_phone
    };

    try {
      const resp = await fetch('http://localhost:3000/api/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await resp.json();
    
      if (result.code === 0) {
        alert('å€™è¡¥å·²æäº¤ï¼š' + result.data.order_no);
        showBookingModal(false);
        if (typeof loadOrders === 'function') loadOrders();
      } else {
        alert('åˆ›å»ºå€™è¡¥å¤±è´¥ï¼š' + result.msg);
      }
    } catch (err) {
      console.error(err);
      alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
    }
    return;
  }

  // éå€™è¡¥ï¼šè¿›å…¥æ”¯ä»˜æµç¨‹
  const selectedPay = document.querySelector('input[name="booking_payment"]:checked')?.value;
  
  // ä¿å­˜å½“å‰é¢„è®¢ä¿¡æ¯ä¾›æ”¯ä»˜å›è°ƒä½¿ç”¨
  window.currentBooking.seatType = seatTypeSelected;
  window.currentBooking.price = price;
  
  // æ ¹æ®æ”¯ä»˜æ–¹å¼æ‰“å¼€å¯¹åº”çš„æ”¯ä»˜æ¨¡æ€
  if (selectedPay === 'wechat' || selectedPay === 'alipay') {
    openQRPaymentModal(selectedPay, price);
  } else if (selectedPay === 'apple_pay') {
    openApplePayModal(price);
  } else if (selectedPay === 'unionpay') {
    openUnionPayModal(price);
  } else {
    alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„æ”¯ä»˜æ–¹å¼');
  }
});
```

##### 4.1.2.5 æ”¯ä»˜æ¨¡æ‹Ÿ

**å¾®ä¿¡/æ”¯ä»˜å®äºŒç»´ç æ”¯ä»˜**ï¼š

```html
<!-- äºŒç»´ç æ”¯ä»˜æ¨¡æ€ -->
<div id="qrPaymentModal">
  <h4 id="qrPaymentTitle">æ‰«ç æ”¯ä»˜</h4>
  <div id="qrBox" style="width:220px; height:220px; border:4px solid #4caf50;">
    <div id="qrPlaceholder">[äºŒç»´ç ]</div>
  </div>
  <div>è¯·ä½¿ç”¨å¯¹åº”åº”ç”¨æ‰«ç æ”¯ä»˜ Â¥<span id="qrPrice">0.00</span></div>
  <div>
    <button id="qrPaidBtn" class="bind-btn">æˆ‘å·²å®Œæˆæ”¯ä»˜</button>
    <button id="qrCancelBtn" class="order-btn">å–æ¶ˆ</button>
  </div>
</div>
```

```javascript
// æ‰“å¼€äºŒç»´ç æ”¯ä»˜æ¨¡æ€
function openQRPaymentModal(method, price) {
  document.getElementById('qrPrice').textContent = price.toFixed(2);
  document.getElementById('qrBox').style.borderColor = method === 'wechat' ? '#4caf50' : '#2196f3';
  document.getElementById('qrPaymentTitle').textContent = method === 'wechat' ? 'å¾®ä¿¡æ‰«ç æ”¯ä»˜' : 'æ”¯ä»˜å®æ‰«ç æ”¯ä»˜';
  
  showBookingModal(false);
  document.getElementById('paymentBackdrop').style.display = 'block';
  document.getElementById('qrPaymentModal').style.display = 'block';
}

// äºŒç»´ç æ”¯ä»˜ç¡®è®¤
document.getElementById('qrPaidBtn').addEventListener('click', async function() {
  this.disabled = true;
  
  // å…³é—­æ”¯ä»˜æ¨¡æ€
  document.getElementById('qrPaymentModal').style.display = 'none';
  document.getElementById('paymentBackdrop').style.display = 'none';
  
  const loginUser = JSON.parse(localStorage.getItem('12306_loginUser'));
  const booking = window.currentBooking;
  
  if (!loginUser || !booking) {
    alert('æ”¯ä»˜ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼Œè¯·é‡è¯•');
    this.disabled = false;
    return;
  }

  // è·å–ä¹˜å®¢ä¿¡æ¯
  const passengerSelect = document.getElementById('booking_passenger_select');
  const opt = passengerSelect.options[passengerSelect.selectedIndex];
  
  // åˆ›å»ºå·²æ”¯ä»˜è®¢å•
  const payload = {
    userId: loginUser.userId,
    start_city: booking.start,
    end_city: booking.end,
    train_no: booking.trainNo,
    price: booking.price,
    depart_time: document.getElementById('trainDate').value + ' ' + booking.depart,
    seat_type: booking.seatType,
    payment_method: document.querySelector('input[name="booking_payment"]:checked')?.value,
    status: 'paid',
    passenger_name: opt?.dataset.name || '',
    passenger_id_card: opt?.dataset.id || '',
    passenger_phone: opt?.dataset.phone || ''
  };

  try {
    const resp = await fetch('http://localhost:3000/api/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await resp.json();
  
    if (result.code === 0) {
      alert('æ”¯ä»˜æˆåŠŸï¼Œè®¢å•å·²åˆ›å»ºï¼š' + result.data.order_no);
      window.currentBooking = null;
      if (typeof loadOrders === 'function') loadOrders();
    } else {
      alert('åˆ›å»ºè®¢å•å¤±è´¥ï¼š' + result.msg);
    }
  } catch (err) {
    console.error(err);
    alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
  }
  
  this.disabled = false;
});
```

**Apple Pay æ¨¡æ‹Ÿ**ï¼š

```javascript
// Apple Pay ç¡®è®¤
document.getElementById('appleConfirmBtn').addEventListener('click', async function() {
  this.disabled = true;
  
  document.getElementById('applePayModal').style.display = 'none';
  document.getElementById('paymentBackdrop').style.display = 'none';
  
  const loginUser = JSON.parse(localStorage.getItem('12306_loginUser'));
  const booking = window.currentBooking;
  
  if (!loginUser || !booking) {
    alert('æ”¯ä»˜ä¸Šä¸‹æ–‡ä¸¢å¤±');
    this.disabled = false;
    return;
  }

  const passengerSelect = document.getElementById('booking_passenger_select');
  const opt = passengerSelect.options[passengerSelect.selectedIndex];
  
  const payload = {
    userId: loginUser.userId,
    start_city: booking.start,
    end_city: booking.end,
    train_no: booking.trainNo,
    price: booking.price,
    depart_time: document.getElementById('trainDate').value + ' ' + booking.depart,
    seat_type: booking.seatType,
    payment_method: 'apple_pay',
    status: 'paid',
    passenger_name: opt?.dataset.name || '',
    passenger_id_card: opt?.dataset.id || '',
    passenger_phone: opt?.dataset.phone || ''
  };

  try {
    const resp = await fetch('http://localhost:3000/api/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await resp.json();
  
    if (result.code === 0) {
      alert('Apple Pay æ”¯ä»˜æˆåŠŸï¼Œè®¢å•ï¼š' + result.data.order_no);
      window.currentBooking = null;
      if (typeof loadOrders === 'function') loadOrders();
    } else {
      alert('åˆ›å»ºè®¢å•å¤±è´¥ï¼š' + result.msg);
    }
  } catch (err) {
    console.error(err);
    alert('è¯·æ±‚å¤±è´¥');
  }
  
  this.disabled = false;
});
```

**é“¶è”æ”¯ä»˜ï¼ˆéœ€è¾“å…¥å¯†ç ï¼‰**ï¼š

```javascript
// é“¶è”æ”¯ä»˜ç¡®è®¤
document.getElementById('unionConfirmBtn').addEventListener('click', async function() {
  const pwd = document.getElementById('unionPayPwd').value;
  
  if (!pwd) {
    alert('è¯·è¾“å…¥é“¶è¡Œå¡å¯†ç ');
    return;
  }
  
  document.getElementById('unionPayModal').style.display = 'none';
  document.getElementById('paymentBackdrop').style.display = 'none';
  
  const loginUser = JSON.parse(localStorage.getItem('12306_loginUser'));
  const booking = window.currentBooking;
  
  if (!loginUser || !booking) {
    alert('æ”¯ä»˜ä¸Šä¸‹æ–‡ä¸¢å¤±');
    return;
  }

  const passengerSelect = document.getElementById('booking_passenger_select');
  const opt = passengerSelect.options[passengerSelect.selectedIndex];
  
  const payload = {
    userId: loginUser.userId,
    start_city: booking.start,
    end_city: booking.end,
    train_no: booking.trainNo,
    price: booking.price,
    depart_time: document.getElementById('trainDate').value + ' ' + booking.depart,
    seat_type: booking.seatType,
    payment_method: 'unionpay',
    status: 'paid',
    passenger_name: opt?.dataset.name || '',
    passenger_id_card: opt?.dataset.id || '',
    passenger_phone: opt?.dataset.phone || ''
  };

  try {
    const resp = await fetch('http://localhost:3000/api/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await resp.json();
  
    if (result.code === 0) {
      alert('é“¶è”æ”¯ä»˜æˆåŠŸï¼Œè®¢å•ï¼š' + result.data.order_no);
      window.currentBooking = null;
      if (typeof loadOrders === 'function') loadOrders();
    } else {
      alert('åˆ›å»ºè®¢å•å¤±è´¥ï¼š' + result.msg);
    }
  } catch (err) {
    console.error(err);
    alert('è¯·æ±‚å¤±è´¥');
  }
});
```

---


#### 4.1.3 è®¢å•ç®¡ç†æ¨¡å—

##### 4.1.3.1 è®¢å•åˆ—è¡¨å±•ç¤º

**åŠŸèƒ½æè¿°**ï¼šç”¨æˆ·åœ¨"è®¢å•ç®¡ç†"é¡µé¢å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å†å²è®¢å•ï¼ŒåŒ…æ‹¬å·²æ”¯ä»˜ã€å€™è¡¥ä¸­ã€å·²å–æ¶ˆã€å·²æ”¹ç­¾ç­‰çŠ¶æ€çš„è®¢å•ã€‚

**åç«¯æŸ¥è¯¢æ¥å£**ï¼š

```javascript
// è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨
app.get('/api/orders', (req, res) => {
  const { userId } = req.query;
  
  if (!userId) {
    return res.json({ code: -1, msg: 'ç¼ºå°‘ userId å‚æ•°' });
  }
  
  const sql = `
    SELECT * FROM orders 
    WHERE user_id = ? 
    ORDER BY created_at DESC
  `;
  
  db.query(sql, [userId], (err, rows) => {
    if (err) {
      return res.json({ code: -1, msg: 'æŸ¥è¯¢è®¢å•å¤±è´¥ï¼š' + err.message });
    }
    res.json({ code: 0, data: rows });
  });
});
```

**å‰ç«¯åŠ è½½è®¢å•å‡½æ•°**ï¼š

```javascript
// åŠ è½½è®¢å•åˆ—è¡¨
async function loadOrders() {
  const loginUser = JSON.parse(localStorage.getItem('12306_loginUser'));
  const orderList = document.getElementById('orderList');
  
  if (!loginUser) {
    if (orderList) {
      orderList.innerHTML = '<div class="empty-state">è¯·å…ˆç™»å½•åæŸ¥çœ‹è®¢å•</div>';
    }
    return;
  }

  try {
    const resp = await fetch(`http://localhost:3000/api/orders?userId=${loginUser.userId}`);
    const result = await resp.json();
  
    if (result.code !== 0) {
      orderList.innerHTML = '<div class="empty-state">è·å–è®¢å•å¤±è´¥ï¼š' + result.msg + '</div>';
      return;
    }

    const orders = result.data;
  
    // å¦‚æœæ— è®¢å•
    if (!orders || orders.length === 0) {
      orderList.innerHTML = '<div class="empty-state">æš‚æ— è®¢å•</div>';
      return;
    }

    // æ¸²æŸ“è®¢å•åˆ—è¡¨
    orderList.innerHTML = orders.map(order => {
      const statusLabel = getStatusLabel(order.status);
      const statusClass = getStatusClass(order.status);
    
      return `
        <div class="order-item" data-order-no="${order.order_no}">
          <div class="order-header">
            <span class="order-no">è®¢å•å·ï¼š${order.order_no}</span>
            <span class="order-status ${statusClass}">${statusLabel}</span>
          </div>
          <div class="order-body">
            <div class="order-route">
              <span class="from">${order.start_city}</span>
              <span class="arrow">â†’</span>
              <span class="to">${order.end_city}</span>
            </div>
            <div class="order-detail">
              <span>è½¦æ¬¡ï¼š${order.train_no}</span>
              <span>å¸­åˆ«ï¼š${order.seat_type || 'äºŒç­‰åº§'}</span>
              <span>å‡ºå‘ï¼š${formatDateTime(order.depart_time)}</span>
            </div>
            <div class="order-price">Â¥${order.price}</div>
          </div>
          <div class="order-actions">
            ${renderOrderActions(order)}
          </div>
        </div>
      `;
    }).join('');

    // ç»‘å®šæ“ä½œæŒ‰é’®äº‹ä»¶
    bindOrderActions();
  
  } catch (err) {
    console.error('åŠ è½½è®¢å•å¤±è´¥', err);
    orderList.innerHTML = '<div class="empty-state">ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è®¢å•</div>';
  }
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(dt) {
  if (!dt) return 'æœªçŸ¥';
  try {
    const d = new Date(dt);
    const dateStr = d.toLocaleDateString('zh-CN');
    const timeStr = d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    return `${dateStr} ${timeStr}`;
  } catch (e) {
    return dt;
  }
}
```

**è®¢å•çŠ¶æ€æ˜ å°„**ï¼š

```javascript
// è·å–çŠ¶æ€ä¸­æ–‡æ ‡ç­¾
function getStatusLabel(status) {
  const statusMap = {
    'paid': 'å·²æ”¯ä»˜',
    'waitlist': 'å€™è¡¥ä¸­',
    'cancelled': 'å·²å–æ¶ˆ',
    'refunded': 'å·²é€€ç¥¨',
    'rescheduled': 'å·²æ”¹ç­¾',
    'pending': 'å¾…æ”¯ä»˜'
  };
  return statusMap[status] || 'æœªçŸ¥çŠ¶æ€';
}

// è·å–çŠ¶æ€æ ·å¼ç±»å
function getStatusClass(status) {
  const classMap = {
    'paid': 'status-success',
    'waitlist': 'status-warning',
    'cancelled': 'status-danger',
    'refunded': 'status-danger',
    'rescheduled': 'status-info',
    'pending': 'status-warning'
  };
  return classMap[status] || '';
}

// æ ¹æ®è®¢å•çŠ¶æ€æ¸²æŸ“æ“ä½œæŒ‰é’®
function renderOrderActions(order) {
  let actions = [];
  
  switch (order.status) {
    case 'paid':
      // å·²æ”¯ä»˜ï¼šå¯é€€ç¥¨ã€å¯æ”¹ç­¾
      actions.push(`<button class="refund-btn" data-order-no="${order.order_no}">é€€ç¥¨</button>`);
      actions.push(`<button class="reschedule-btn" data-order-no="${order.order_no}">æ”¹ç­¾</button>`);
      break;
    case 'waitlist':
      // å€™è¡¥ä¸­ï¼šå¯å–æ¶ˆ
      actions.push(`<button class="cancel-wait-btn" data-order-no="${order.order_no}">å–æ¶ˆå€™è¡¥</button>`);
      break;
    case 'pending':
      // å¾…æ”¯ä»˜ï¼šå¯ç»§ç»­æ”¯ä»˜ã€å¯å–æ¶ˆ
      actions.push(`<button class="pay-btn" data-order-no="${order.order_no}">ç»§ç»­æ”¯ä»˜</button>`);
      actions.push(`<button class="cancel-btn" data-order-no="${order.order_no}">å–æ¶ˆè®¢å•</button>`);
      break;
    // å…¶ä»–çŠ¶æ€ï¼ˆå·²å–æ¶ˆã€å·²é€€ç¥¨ã€å·²æ”¹ç­¾ï¼‰æ— æ“ä½œ
  }
  
  return actions.join('');
}
```

**è®¢å•åˆ—è¡¨æ ·å¼**ï¼š

```css
/* è®¢å•åˆ—è¡¨ */
#orderList {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-top: 20px;
}

/* è®¢å•å¡ç‰‡ */
.order-item {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 18px 22px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  transition: box-shadow 0.2s;
}

.order-item:hover {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
}

/* è®¢å•å¤´éƒ¨ */
.order-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #f0f0f0;
  padding-bottom: 12px;
  margin-bottom: 12px;
}

.order-no {
  font-size: 13px;
  color: #888;
}

/* è®¢å•çŠ¶æ€ */
.order-status {
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 500;
}

.status-success {
  background: #e8f5e9;
  color: #2e7d32;
}

.status-warning {
  background: #fff3e0;
  color: #e65100;
}

.status-danger {
  background: #ffebee;
  color: #c62828;
}

.status-info {
  background: #e3f2fd;
  color: #1565c0;
}

/* è®¢å•ä¸»ä½“ */
.order-body {
  display: flex;
  align-items: center;
  gap: 20px;
}

.order-route {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 600;
  color: #333;
}

.order-route .arrow {
  color: #d92121;
}

.order-detail {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 13px;
  color: #666;
  flex: 1;
}

.order-price {
  font-size: 20px;
  font-weight: bold;
  color: #d92121;
}

/* æ“ä½œæŒ‰é’®åŒºåŸŸ */
.order-actions {
  margin-top: 15px;
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.order-actions button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  transition: opacity 0.2s;
}

.order-actions button:hover {
  opacity: 0.85;
}

.refund-btn {
  background: #ffebee;
  color: #c62828;
}

.reschedule-btn {
  background: #e3f2fd;
  color: #1565c0;
}

.cancel-wait-btn, .cancel-btn {
  background: #f5f5f5;
  color: #666;
}

.pay-btn {
  background: linear-gradient(180deg, #ff4b4b, #d92121);
  color: #fff;
}
```

##### 4.1.3.2 é€€ç¥¨åŠŸèƒ½

**åŠŸèƒ½æè¿°**ï¼šå·²æ”¯ä»˜è®¢å•å¯ä»¥ç”³è¯·é€€ç¥¨ï¼Œç³»ç»Ÿä¼šæ¨¡æ‹Ÿé€€æ¬¾æµç¨‹ã€‚

**åç«¯é€€ç¥¨æ¥å£**ï¼š

```javascript
// å–æ¶ˆ/é€€ç¥¨è®¢å•
app.patch('/api/orders/:orderNo/cancel', (req, res) => {
  const { orderNo } = req.params;
  
  const sql = `
    UPDATE orders 
    SET status = 'refunded', updated_at = NOW() 
    WHERE order_no = ?
  `;
  
  db.query(sql, [orderNo], (err, result) => {
    if (err) {
      return res.json({ code: -1, msg: 'é€€ç¥¨å¤±è´¥ï¼š' + err.message });
    }
    if (result.affectedRows === 0) {
      return res.json({ code: -1, msg: 'è®¢å•ä¸å­˜åœ¨' });
    }
    res.json({ code: 0, msg: 'é€€ç¥¨æˆåŠŸ' });
  });
});
```

**å‰ç«¯é€€ç¥¨å¤„ç†**ï¼š

```javascript
// ç»‘å®šè®¢å•æ“ä½œæŒ‰é’®äº‹ä»¶
function bindOrderActions() {
  // é€€ç¥¨æŒ‰é’®
  document.querySelectorAll('.refund-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const orderNo = this.dataset.orderNo;
    
      // ç¡®è®¤å¼¹çª—
      const confirmRefund = confirm(`ç¡®è®¤é€€ç¥¨è®¢å• ${orderNo}ï¼Ÿ\né€€ç¥¨åå°†æ‰£é™¤ä¸€å®šæ‰‹ç»­è´¹ã€‚`);
      if (!confirmRefund) return;
    
      try {
        const resp = await fetch(`http://localhost:3000/api/orders/${orderNo}/cancel`, {
          method: 'PATCH'
        });
        const result = await resp.json();
      
        if (result.code === 0) {
          alert('é€€ç¥¨æˆåŠŸï¼Œç¥¨æ¬¾å°†åœ¨3-5ä¸ªå·¥ä½œæ—¥å†…é€€å›åŸæ”¯ä»˜è´¦æˆ·');
          loadOrders(); // åˆ·æ–°è®¢å•åˆ—è¡¨
        } else {
          alert('é€€ç¥¨å¤±è´¥ï¼š' + result.msg);
        }
      } catch (err) {
        console.error(err);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
      }
    });
  });

  // å–æ¶ˆå€™è¡¥æŒ‰é’®
  document.querySelectorAll('.cancel-wait-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const orderNo = this.dataset.orderNo;
      const confirmCancel = confirm(`ç¡®è®¤å–æ¶ˆå€™è¡¥è®¢å• ${orderNo}ï¼Ÿ`);
      if (!confirmCancel) return;
    
      try {
        const resp = await fetch(`http://localhost:3000/api/orders/${orderNo}/cancel`, {
          method: 'PATCH'
        });
        const result = await resp.json();
      
        if (result.code === 0) {
          alert('å·²å–æ¶ˆå€™è¡¥');
          loadOrders();
        } else {
          alert('å–æ¶ˆå¤±è´¥ï¼š' + result.msg);
        }
      } catch (err) {
        console.error(err);
        alert('ç½‘ç»œé”™è¯¯');
      }
    });
  });
}
```

##### 4.1.3.3 æ”¹ç­¾åŠŸèƒ½

**åŠŸèƒ½æè¿°**ï¼šå·²æ”¯ä»˜è®¢å•å¯ç”³è¯·æ”¹ç­¾åˆ°å…¶ä»–æ—¥æœŸæˆ–è½¦æ¬¡ï¼Œéœ€è¡¥/é€€å·®ä»·ã€‚

**æ”¹ç­¾å¼¹çª—ç•Œé¢**ï¼š

```html
<!-- æ”¹ç­¾æ¨¡æ€ -->
<div id="rescheduleModal" style="display:none;">
  <h4>è®¢å•æ”¹ç­¾</h4>
  <div id="rescheduleCurrentInfo">
    <!-- å½“å‰è®¢å•ä¿¡æ¯ -->
  </div>
  <hr>
  <div>
    <label>æ”¹ç­¾åˆ°æ–°æ—¥æœŸ</label>
    <input type="date" id="reschedule_date">
  
    <label>æ–°è½¦æ¬¡å·</label>
    <input type="text" id="reschedule_train_no" placeholder="å¦‚ G1234">
  
    <label>æ–°å¸­åˆ«</label>
    <select id="reschedule_seat_type">
      <option value="äºŒç­‰åº§">äºŒç­‰åº§</option>
      <option value="ä¸€ç­‰åº§">ä¸€ç­‰åº§</option>
      <option value="æ— åº§">æ— åº§</option>
    </select>
  </div>
  <div style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
    <button id="rescheduleCancel" class="order-btn">å–æ¶ˆ</button>
    <button id="rescheduleConfirm" class="search-btn">ç¡®è®¤æ”¹ç­¾</button>
  </div>
</div>
```

**åç«¯æ”¹ç­¾æ¥å£**ï¼š

```javascript
// æ”¹ç­¾è®¢å•
app.patch('/api/orders/reschedule', (req, res) => {
  const { 
    orderNo,           // åŸè®¢å•å·
    newDepartTime,     // æ–°å‡ºå‘æ—¶é—´
    newTrainNo,        // æ–°è½¦æ¬¡
    newSeatType,       // æ–°å¸­åˆ«
    priceDiff          // å·®ä»·ï¼ˆæ­£æ•°è¡¥æ¬¾ï¼Œè´Ÿæ•°é€€æ¬¾ï¼‰
  } = req.body;
  
  if (!orderNo) {
    return res.json({ code: -1, msg: 'ç¼ºå°‘è®¢å•å·' });
  }

  // æŸ¥è¯¢åŸè®¢å•
  const selectSql = 'SELECT * FROM orders WHERE order_no = ?';
  
  db.query(selectSql, [orderNo], (err, rows) => {
    if (err) {
      return res.json({ code: -1, msg: 'æŸ¥è¯¢è®¢å•å¤±è´¥' });
    }
  
    if (!rows || rows.length === 0) {
      return res.json({ code: -1, msg: 'è®¢å•ä¸å­˜åœ¨' });
    }
  
    const oldOrder = rows[0];
  
    // æ£€æŸ¥è®¢å•çŠ¶æ€
    if (oldOrder.status !== 'paid') {
      return res.json({ code: -1, msg: 'åªæœ‰å·²æ”¯ä»˜çš„è®¢å•æ‰èƒ½æ”¹ç­¾' });
    }
  
    // æ›´æ–°åŸè®¢å•ä¸º"å·²æ”¹ç­¾"çŠ¶æ€
    const updateOldSql = `
      UPDATE orders 
      SET status = 'rescheduled', updated_at = NOW() 
      WHERE order_no = ?
    `;
  
    db.query(updateOldSql, [orderNo], (updateErr) => {
      if (updateErr) {
        return res.json({ code: -1, msg: 'æ›´æ–°åŸè®¢å•å¤±è´¥' });
      }
    
      // ç”Ÿæˆæ–°è®¢å•å·
      generateUniqueOrderNo(5, (genErr, newOrderNo) => {
        if (genErr) {
          return res.json({ code: -1, msg: 'ç”Ÿæˆæ–°è®¢å•å·å¤±è´¥' });
        }
      
        // è®¡ç®—æ–°è®¢å•ä»·æ ¼
        const newPrice = parseFloat(oldOrder.price) + (priceDiff || 0);
      
        // åˆ›å»ºæ–°è®¢å•
        const insertSql = `
          INSERT INTO orders (
            order_no, user_id, start_city, end_city, train_no,
            price, depart_time, seat_type, status, payment_method,
            rescheduled_from
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'paid', ?, ?)
        `;
      
        db.query(insertSql, [
          newOrderNo,
          oldOrder.user_id,
          oldOrder.start_city,
          oldOrder.end_city,
          newTrainNo || oldOrder.train_no,
          newPrice,
          newDepartTime || oldOrder.depart_time,
          newSeatType || oldOrder.seat_type,
          oldOrder.payment_method,
          orderNo // è®°å½•åŸè®¢å•å·
        ], (insertErr, insertResult) => {
          if (insertErr) {
            return res.json({ code: -1, msg: 'åˆ›å»ºæ–°è®¢å•å¤±è´¥ï¼š' + insertErr.message });
          }
        
          // è¿”å›æ–°è®¢å•ä¿¡æ¯
          const getNewSql = 'SELECT * FROM orders WHERE id = ?';
          db.query(getNewSql, [insertResult.insertId], (_, newRows) => {
            res.json({
              code: 0,
              msg: 'æ”¹ç­¾æˆåŠŸ',
              data: {
                oldOrderNo: orderNo,
                newOrder: newRows[0],
                priceDiff: priceDiff || 0
              }
            });
          });
        });
      });
    });
  });
});
```

**å‰ç«¯æ”¹ç­¾å¤„ç†**ï¼š

```javascript
// æ”¹ç­¾æŒ‰é’®å¤„ç†
document.querySelectorAll('.reschedule-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const orderNo = this.dataset.orderNo;
    const orderItem = this.closest('.order-item');
  
    // è·å–å½“å‰è®¢å•ä¿¡æ¯
    const currentInfo = orderItem.querySelector('.order-body').innerHTML;
    document.getElementById('rescheduleCurrentInfo').innerHTML = `
      <h5>å½“å‰è®¢å•</h5>
      <p>è®¢å•å·ï¼š${orderNo}</p>
      ${currentInfo}
    `;
  
    // ä¿å­˜å½“å‰æ”¹ç­¾è®¢å•å·
    window.currentRescheduleOrderNo = orderNo;
  
    // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæ˜å¤©
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('reschedule_date').value = tomorrow.toISOString().slice(0, 10);
  
    // æ˜¾ç¤ºæ”¹ç­¾å¼¹çª—
    document.getElementById('paymentBackdrop').style.display = 'block';
    document.getElementById('rescheduleModal').style.display = 'block';
  });
});

// ç¡®è®¤æ”¹ç­¾
document.getElementById('rescheduleConfirm').addEventListener('click', async function() {
  const orderNo = window.currentRescheduleOrderNo;
  if (!orderNo) {
    alert('æ”¹ç­¾ä¿¡æ¯ä¸¢å¤±ï¼Œè¯·é‡è¯•');
    return;
  }
  
  const newDate = document.getElementById('reschedule_date').value;
  const newTrainNo = document.getElementById('reschedule_train_no').value;
  const newSeatType = document.getElementById('reschedule_seat_type').value;
  
  if (!newDate) {
    alert('è¯·é€‰æ‹©æ–°çš„å‡ºå‘æ—¥æœŸ');
    return;
  }
  
  // æ¨¡æ‹Ÿå·®ä»·è®¡ç®—ï¼ˆå®é™…åº”è¯¥æ ¹æ®è½¦æ¬¡æŸ¥è¯¢ä»·æ ¼ï¼‰
  const priceDiff = Math.round((Math.random() - 0.5) * 100); // éšæœºå·®ä»· -50 åˆ° +50
  
  const confirmMsg = priceDiff > 0 
    ? `ç¡®è®¤æ”¹ç­¾ï¼Ÿéœ€è¡¥å·®ä»· Â¥${priceDiff}` 
    : `ç¡®è®¤æ”¹ç­¾ï¼Ÿå°†é€€å›å·®ä»· Â¥${Math.abs(priceDiff)}`;
  
  if (!confirm(confirmMsg)) return;
  
  try {
    const resp = await fetch('http://localhost:3000/api/orders/reschedule', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderNo,
        newDepartTime: newDate + ' 08:00',
        newTrainNo: newTrainNo || undefined,
        newSeatType,
        priceDiff
      })
    });
  
    const result = await resp.json();
  
    if (result.code === 0) {
      // å…³é—­å¼¹çª—
      document.getElementById('rescheduleModal').style.display = 'none';
      document.getElementById('paymentBackdrop').style.display = 'none';
    
      alert(`æ”¹ç­¾æˆåŠŸï¼\næ–°è®¢å•å·ï¼š${result.data.newOrder.order_no}`);
      loadOrders(); // åˆ·æ–°åˆ—è¡¨
    } else {
      alert('æ”¹ç­¾å¤±è´¥ï¼š' + result.msg);
    }
  } catch (err) {
    console.error(err);
    alert('ç½‘ç»œé”™è¯¯');
  }
});

// å–æ¶ˆæ”¹ç­¾
document.getElementById('rescheduleCancel').addEventListener('click', function() {
  document.getElementById('rescheduleModal').style.display = 'none';
  document.getElementById('paymentBackdrop').style.display = 'none';
  window.currentRescheduleOrderNo = null;
});
```

##### 4.1.3.4 æ•°æ®åº“è¡¨ç»“æ„

**è®¢å•è¡¨ï¼ˆordersï¼‰**ï¼š

```sql
CREATE TABLE `orders` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(32) NOT NULL COMMENT 'è®¢å•å·',
  `user_id` int(11) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `start_city` varchar(50) NOT NULL COMMENT 'å‡ºå‘åŸå¸‚',
  `end_city` varchar(50) NOT NULL COMMENT 'åˆ°è¾¾åŸå¸‚',
  `train_no` varchar(20) DEFAULT NULL COMMENT 'è½¦æ¬¡å·',
  `price` decimal(10,2) NOT NULL COMMENT 'ç¥¨ä»·',
  `depart_time` datetime DEFAULT NULL COMMENT 'å‡ºå‘æ—¶é—´',
  `seat_type` varchar(20) DEFAULT 'äºŒç­‰åº§' COMMENT 'å¸­åˆ«',
  `status` enum('pending','paid','waitlist','cancelled','refunded','rescheduled') DEFAULT 'pending' COMMENT 'è®¢å•çŠ¶æ€',
  `payment_method` varchar(20) DEFAULT NULL COMMENT 'æ”¯ä»˜æ–¹å¼',
  `passenger_name` varchar(50) DEFAULT NULL COMMENT 'ä¹˜å®¢å§“å',
  `passenger_id_card` varchar(20) DEFAULT NULL COMMENT 'ä¹˜å®¢èº«ä»½è¯',
  `passenger_phone` varchar(20) DEFAULT NULL COMMENT 'ä¹˜å®¢ç”µè¯',
  `rescheduled_from` varchar(32) DEFAULT NULL COMMENT 'æ”¹ç­¾æ¥æºè®¢å•å·',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•è¡¨';
```

---


#### 4.1.4 ä¸ªäººä¸­å¿ƒæ¨¡å—

##### 4.1.4.1 ä¸ªäººä¿¡æ¯å±•ç¤º

**åŠŸèƒ½æè¿°**ï¼šå±•ç¤ºå½“å‰ç™»å½•ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤´åƒã€å§“åã€å®åè®¤è¯çŠ¶æ€ç­‰ã€‚

**ç•Œé¢ç»“æ„**ï¼š

```html
<!-- ä¸ªäººä¸­å¿ƒé¡µé¢ -->
<div class="page" id="page-user">
  <div class="personal-center" id="personalCenter">
    <!-- å¤´åƒåŒºåŸŸ -->
    <div class="avatar-section">
      <img id="avatarImg" src="" alt="å¤´åƒ" class="avatar-img" onerror="this.src='data:image/svg+xml,...'">
      <div class="avatar-actions">
        <label for="avatarUpload" class="avatar-upload-btn">æ›´æ¢å¤´åƒ</label>
        <input type="file" id="avatarUpload" accept="image/*" style="display:none;">
      </div>
    </div>
  
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="user-info-card">
      <h3 id="userName">ç”¨æˆ·å</h3>
      <div class="info-row">
        <span class="label">æ‰‹æœºå·ï¼š</span>
        <span id="userPhone">-</span>
      </div>
      <div class="info-row">
        <span class="label">èº«ä»½è¯ï¼š</span>
        <span id="userIdCard">-</span>
      </div>
      <div class="info-row">
        <span class="label">å®åçŠ¶æ€ï¼š</span>
        <span id="verifyStatus" class="status-badge">æœªè®¤è¯</span>
      </div>
    </div>
  
    <!-- åŠŸèƒ½å…¥å£ -->
    <div class="function-list">
      <div class="function-item" onclick="showPage('page-passengers')">
        <span class="icon">ğŸ‘¥</span>
        <span>å¸¸ç”¨ä¹˜è½¦äºº</span>
        <span class="arrow">â€º</span>
      </div>
      <div class="function-item" onclick="showPage('page-bindpay')">
        <span class="icon">ğŸ’³</span>
        <span>æ”¯ä»˜è®¾ç½®</span>
        <span class="arrow">â€º</span>
      </div>
      <div class="function-item" onclick="showPage('page-orders')">
        <span class="icon">ğŸ“‹</span>
        <span>æˆ‘çš„è®¢å•</span>
        <span class="arrow">â€º</span>
      </div>
    </div>
  
    <!-- é€€å‡ºç™»å½• -->
    <button id="logoutBtn" class="logout-btn">é€€å‡ºç™»å½•</button>
  </div>
</div>
```

**åŠ è½½ç”¨æˆ·ä¿¡æ¯**ï¼š

```javascript
// æ›´æ–°ç”¨æˆ·ä¸­å¿ƒæ˜¾ç¤º
function updateUserCenterDisplay() {
  const loginUser = JSON.parse(localStorage.getItem('12306_loginUser'));
  
  if (!loginUser) {
    document.getElementById('userName').textContent = 'æœªç™»å½•';
    document.getElementById('userPhone').textContent = '-';
    document.getElementById('userIdCard').textContent = '-';
    document.getElementById('verifyStatus').textContent = 'æœªè®¤è¯';
    document.getElementById('verifyStatus').className = 'status-badge status-unverified';
    return;
  }
  
  // æ˜¾ç¤ºç”¨æˆ·å
  document.getElementById('userName').textContent = 
    loginUser.name || loginUser.username || 'ç”¨æˆ·';
  
  // æ˜¾ç¤ºæ‰‹æœºå·ï¼ˆéƒ¨åˆ†éšè—ï¼‰
  const phone = loginUser.phone || '';
  document.getElementById('userPhone').textContent = 
    phone ? phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2') : 'æœªç»‘å®š';
  
  // æ˜¾ç¤ºèº«ä»½è¯ï¼ˆéƒ¨åˆ†éšè—ï¼‰
  const idCard = loginUser.id_card || '';
  document.getElementById('userIdCard').textContent = 
    idCard ? idCard.replace(/(\d{6})\d{8}(\d{4})/, '$1********$2') : 'æœªå¡«å†™';
  
  // å®åè®¤è¯çŠ¶æ€
  const isVerified = loginUser.is_verified === 1 || loginUser.is_verified === '1';
  const statusEl = document.getElementById('verifyStatus');
  
  if (isVerified) {
    statusEl.textContent = 'å·²è®¤è¯';
    statusEl.className = 'status-badge status-verified';
  } else {
    statusEl.textContent = 'æœªè®¤è¯';
    statusEl.className = 'status-badge status-unverified';
  }
  
  // åŠ è½½å¤´åƒ
  if (loginUser.avatar) {
    document.getElementById('avatarImg').src = loginUser.avatar;
  }
}

// é¡µé¢åˆ‡æ¢æ—¶æ›´æ–°
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', function() {
    const target = this.dataset.page;
    if (target === 'page-user') {
      updateUserCenterDisplay();
    }
  });
});
```

**æ ·å¼å®šä¹‰**ï¼š

```css
/* ä¸ªäººä¸­å¿ƒ */
.personal-center {
  padding: 20px;
  max-width: 600px;
  margin: 0 auto;
}

/* å¤´åƒåŒºåŸŸ */
.avatar-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 24px;
}

.avatar-img {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid #fff;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.avatar-upload-btn {
  margin-top: 12px;
  padding: 8px 16px;
  background: #f0f0f0;
  border-radius: 20px;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.2s;
}

.avatar-upload-btn:hover {
  background: #e0e0e0;
}

/* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
.user-info-card {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.user-info-card h3 {
  margin: 0 0 16px;
  font-size: 20px;
  color: #333;
}

.info-row {
  display: flex;
  padding: 8px 0;
  border-bottom: 1px solid #f5f5f5;
}

.info-row:last-child {
  border-bottom: none;
}

.info-row .label {
  color: #888;
  width: 80px;
}

/* çŠ¶æ€å¾½ç«  */
.status-badge {
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
}

.status-verified {
  background: #e8f5e9;
  color: #2e7d32;
}

.status-unverified {
  background: #fff3e0;
  color: #e65100;
}

/* åŠŸèƒ½åˆ—è¡¨ */
.function-list {
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.function-item {
  display: flex;
  align-items: center;
  padding: 16px 20px;
  cursor: pointer;
  border-bottom: 1px solid #f5f5f5;
  transition: background 0.2s;
}

.function-item:last-child {
  border-bottom: none;
}

.function-item:hover {
  background: #fafafa;
}

.function-item .icon {
  margin-right: 12px;
  font-size: 20px;
}

.function-item .arrow {
  margin-left: auto;
  color: #ccc;
  font-size: 20px;
}

/* é€€å‡ºç™»å½•æŒ‰é’® */
.logout-btn {
  width: 100%;
  padding: 14px;
  background: #f5f5f5;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  color: #d92121;
  cursor: pointer;
  transition: background 0.2s;
}

.logout-btn:hover {
  background: #ffebee;
}
```

##### 4.1.4.2 å¤´åƒä¸Šä¼ 

**åŠŸèƒ½æè¿°**ï¼šç”¨æˆ·å¯ä»¥ä¸Šä¼ æœ¬åœ°å›¾ç‰‡ä½œä¸ºå¤´åƒï¼Œç³»ç»Ÿä¼šå°†å›¾ç‰‡è½¬ä¸º Base64 å­˜å‚¨ã€‚

**å®ç°ä»£ç **ï¼š

```javascript
// å¤´åƒä¸Šä¼ å¤„ç†
document.getElementById('avatarUpload').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  // æ ¡éªŒæ–‡ä»¶ç±»å‹
  if (!file.type.startsWith('image/')) {
    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
    return;
  }
  
  // æ ¡éªŒæ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 2MBï¼‰
  if (file.size > 2 * 1024 * 1024) {
    alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB');
    return;
  }
  
  // è¯»å–æ–‡ä»¶å¹¶è½¬ä¸º Base64
  const reader = new FileReader();
  
  reader.onload = function(event) {
    const base64Data = event.target.result;
  
    // æ›´æ–°é¡µé¢æ˜¾ç¤º
    document.getElementById('avatarImg').src = base64Data;
  
    // ä¿å­˜åˆ° localStorage
    const loginUser = JSON.parse(localStorage.getItem('12306_loginUser')) || {};
    loginUser.avatar = base64Data;
    localStorage.setItem('12306_loginUser', JSON.stringify(loginUser));
  
    // åŒæ­¥åˆ°å¯¼èˆªæ å°å¤´åƒï¼ˆå¦‚æœæœ‰ï¼‰
    const navAvatar = document.getElementById('navAvatar');
    if (navAvatar) {
      navAvatar.src = base64Data;
    }
  
    alert('å¤´åƒæ›´æ–°æˆåŠŸ');
  };
  
  reader.onerror = function() {
    alert('è¯»å–å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
  };
  
  reader.readAsDataURL(file);
});
```

##### 4.1.4.3 å¸¸ç”¨ä¹˜è½¦äººç®¡ç†

**åŠŸèƒ½æè¿°**ï¼šç”¨æˆ·å¯ä»¥æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤å¸¸ç”¨ä¹˜è½¦äººï¼Œæ–¹ä¾¿è´­ç¥¨æ—¶å¿«é€Ÿé€‰æ‹©ã€‚

**ç•Œé¢ç»“æ„**ï¼š

```html
<!-- å¸¸ç”¨ä¹˜è½¦äººé¡µé¢ -->
<div class="page" id="page-passengers">
  <h2>å¸¸ç”¨ä¹˜è½¦äºº</h2>
  
  <!-- æ·»åŠ æŒ‰é’® -->
  <button id="addPassengerBtn" class="add-btn">+ æ·»åŠ ä¹˜è½¦äºº</button>
  
  <!-- ä¹˜è½¦äººåˆ—è¡¨ -->
  <div id="passengerList" class="passenger-list">
    <!-- åŠ¨æ€æ¸²æŸ“ -->
  </div>
  
  <!-- æ·»åŠ /ç¼–è¾‘å¼¹çª— -->
  <div id="passengerModal" style="display:none;">
    <h4 id="passengerModalTitle">æ·»åŠ ä¹˜è½¦äºº</h4>
    <form id="passengerForm">
      <div class="form-group">
        <label>å§“å</label>
        <input type="text" id="passengerName" placeholder="è¯·è¾“å…¥çœŸå®å§“å" required>
      </div>
      <div class="form-group">
        <label>èº«ä»½è¯å·</label>
        <input type="text" id="passengerIdCard" placeholder="è¯·è¾“å…¥18ä½èº«ä»½è¯å·" maxlength="18" required>
      </div>
      <div class="form-group">
        <label>æ‰‹æœºå·</label>
        <input type="tel" id="passengerPhone" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·" maxlength="11" required>
      </div>
      <div class="form-actions">
        <button type="button" id="passengerCancelBtn" class="order-btn">å–æ¶ˆ</button>
        <button type="submit" id="passengerSaveBtn" class="search-btn">ä¿å­˜</button>
      </div>
    </form>
  </div>
</div>
```

**åç«¯æ¥å£**ï¼š

```javascript
// è·å–å¸¸ç”¨ä¹˜è½¦äººåˆ—è¡¨
app.get('/api/frequent_passengers', (req, res) => {
  const { userId } = req.query;
  
  if (!userId) {
    return res.json({ code: -1, msg: 'ç¼ºå°‘ç”¨æˆ·ID' });
  }
  
  const sql = 'SELECT * FROM frequent_passengers WHERE user_id = ? ORDER BY created_at DESC';
  
  db.query(sql, [userId], (err, rows) => {
    if (err) {
      return res.json({ code: -1, msg: 'æŸ¥è¯¢å¤±è´¥ï¼š' + err.message });
    }
    res.json({ code: 0, data: rows });
  });
});

// æ·»åŠ å¸¸ç”¨ä¹˜è½¦äºº
app.post('/api/frequent_passengers', (req, res) => {
  const { userId, passenger_name, passenger_id_card, passenger_phone } = req.body;
  
  // æ ¡éªŒå¿…å¡«å­—æ®µ
  if (!userId || !passenger_name || !passenger_id_card || !passenger_phone) {
    return res.json({ code: -1, msg: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯' });
  }
  
  // æ ¡éªŒèº«ä»½è¯æ ¼å¼
  if (!/^\d{17}[\dXx]$/.test(passenger_id_card)) {
    return res.json({ code: -1, msg: 'èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®' });
  }
  
  // æ ¡éªŒæ‰‹æœºå·æ ¼å¼
  if (!/^1\d{10}$/.test(passenger_phone)) {
    return res.json({ code: -1, msg: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®' });
  }
  
  const sql = `
    INSERT INTO frequent_passengers (user_id, passenger_name, passenger_id_card, passenger_phone)
    VALUES (?, ?, ?, ?)
  `;
  
  db.query(sql, [userId, passenger_name, passenger_id_card, passenger_phone], (err, result) => {
    if (err) {
      if (err.code === 'ER_DUP_ENTRY') {
        return res.json({ code: -1, msg: 'è¯¥ä¹˜è½¦äººå·²å­˜åœ¨' });
      }
      return res.json({ code: -1, msg: 'æ·»åŠ å¤±è´¥ï¼š' + err.message });
    }
    res.json({ code: 0, msg: 'æ·»åŠ æˆåŠŸ', data: { id: result.insertId } });
  });
});

// åˆ é™¤å¸¸ç”¨ä¹˜è½¦äºº
app.delete('/api/frequent_passengers/:id', (req, res) => {
  const { id } = req.params;
  
  const sql = 'DELETE FROM frequent_passengers WHERE id = ?';
  
  db.query(sql, [id], (err, result) => {
    if (err) {
      return res.json({ code: -1, msg: 'åˆ é™¤å¤±è´¥ï¼š' + err.message });
    }
    if (result.affectedRows === 0) {
      return res.json({ code: -1, msg: 'ä¹˜è½¦äººä¸å­˜åœ¨' });
    }
    res.json({ code: 0, msg: 'åˆ é™¤æˆåŠŸ' });
  });
});
```

**å‰ç«¯ä¹˜è½¦äººç®¡ç†é€»è¾‘**ï¼š

```javascript
// åŠ è½½å¸¸ç”¨ä¹˜è½¦äººåˆ—è¡¨
async function loadPassengers() {
  const loginUser = JSON.parse(localStorage.getItem('12306_loginUser'));
  const passengerList = document.getElementById('passengerList');
  
  if (!loginUser) {
    passengerList.innerHTML = '<div class="empty-state">è¯·å…ˆç™»å½•</div>';
    return;
  }
  
  try {
    const resp = await fetch(`http://localhost:3000/api/frequent_passengers?userId=${loginUser.userId}`);
    const result = await resp.json();
  
    if (result.code !== 0) {
      passengerList.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
      return;
    }
  
    const passengers = result.data;
  
    if (!passengers || passengers.length === 0) {
      passengerList.innerHTML = '<div class="empty-state">æš‚æ— å¸¸ç”¨ä¹˜è½¦äººï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>';
      return;
    }
  
    // æ¸²æŸ“åˆ—è¡¨
    passengerList.innerHTML = passengers.map(p => `
      <div class="passenger-item" data-id="${p.id}">
        <div class="passenger-info">
          <div class="passenger-name">${p.passenger_name}</div>
          <div class="passenger-detail">
            <span>èº«ä»½è¯ï¼š${maskIdCard(p.passenger_id_card)}</span>
            <span>æ‰‹æœºï¼š${maskPhone(p.passenger_phone)}</span>
          </div>
        </div>
        <div class="passenger-actions">
          <button class="edit-passenger-btn" data-id="${p.id}">ç¼–è¾‘</button>
          <button class="delete-passenger-btn" data-id="${p.id}">åˆ é™¤</button>
        </div>
      </div>
    `).join('');
  
    // ç»‘å®šäº‹ä»¶
    bindPassengerActions();
  
  } catch (err) {
    console.error(err);
    passengerList.innerHTML = '<div class="empty-state">ç½‘ç»œé”™è¯¯</div>';
  }
}

// èº«ä»½è¯å·è„±æ•
function maskIdCard(idCard) {
  if (!idCard) return '-';
  return idCard.replace(/(\d{6})\d{8}(\d{4})/, '$1********$2');
}

// æ‰‹æœºå·è„±æ•
function maskPhone(phone) {
  if (!phone) return '-';
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
}

// æ·»åŠ ä¹˜è½¦äººæŒ‰é’®
document.getElementById('addPassengerBtn').addEventListener('click', function() {
  // æ¸…ç©ºè¡¨å•
  document.getElementById('passengerForm').reset();
  document.getElementById('passengerModalTitle').textContent = 'æ·»åŠ ä¹˜è½¦äºº';
  window.editingPassengerId = null;
  
  // æ˜¾ç¤ºå¼¹çª—
  document.getElementById('paymentBackdrop').style.display = 'block';
  document.getElementById('passengerModal').style.display = 'block';
});

// ä¿å­˜ä¹˜è½¦äºº
document.getElementById('passengerForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const loginUser = JSON.parse(localStorage.getItem('12306_loginUser'));
  if (!loginUser) {
    alert('è¯·å…ˆç™»å½•');
    return;
  }
  
  const name = document.getElementById('passengerName').value.trim();
  const idCard = document.getElementById('passengerIdCard').value.trim();
  const phone = document.getElementById('passengerPhone').value.trim();
  
  // å‰ç«¯æ ¡éªŒ
  if (!name || !idCard || !phone) {
    alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
    return;
  }
  
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    alert('èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®');
    return;
  }
  
  if (!/^1\d{10}$/.test(phone)) {
    alert('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
    return;
  }
  
  try {
    const resp = await fetch('http://localhost:3000/api/frequent_passengers', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: loginUser.userId,
        passenger_name: name,
        passenger_id_card: idCard,
        passenger_phone: phone
      })
    });
  
    const result = await resp.json();
  
    if (result.code === 0) {
      alert('æ·»åŠ æˆåŠŸ');
      // å…³é—­å¼¹çª—
      document.getElementById('passengerModal').style.display = 'none';
      document.getElementById('paymentBackdrop').style.display = 'none';
      // åˆ·æ–°åˆ—è¡¨
      loadPassengers();
    } else {
      alert('æ·»åŠ å¤±è´¥ï¼š' + result.msg);
    }
  } catch (err) {
    console.error(err);
    alert('ç½‘ç»œé”™è¯¯');
  }
});

// åˆ é™¤ä¹˜è½¦äºº
function bindPassengerActions() {
  document.querySelectorAll('.delete-passenger-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const id = this.dataset.id;
    
      if (!confirm('ç¡®è®¤åˆ é™¤è¯¥ä¹˜è½¦äººï¼Ÿ')) return;
    
      try {
        const resp = await fetch(`http://localhost:3000/api/frequent_passengers/${id}`, {
          method: 'DELETE'
        });
      
        const result = await resp.json();
      
        if (result.code === 0) {
          alert('åˆ é™¤æˆåŠŸ');
          loadPassengers();
        } else {
          alert('åˆ é™¤å¤±è´¥ï¼š' + result.msg);
        }
      } catch (err) {
        console.error(err);
        alert('ç½‘ç»œé”™è¯¯');
      }
    });
  });
}
```

**å¸¸ç”¨ä¹˜è½¦äººè¡¨ç»“æ„**ï¼š

```sql
CREATE TABLE `frequent_passengers` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `passenger_name` varchar(50) NOT NULL COMMENT 'ä¹˜å®¢å§“å',
  `passenger_id_card` varchar(18) NOT NULL COMMENT 'èº«ä»½è¯å·',
  `passenger_phone` varchar(11) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_passenger` (`user_id`, `passenger_id_card`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å¸¸ç”¨ä¹˜è½¦äººè¡¨';
```

##### 4.1.4.4 æ”¯ä»˜ç»‘å®šç®¡ç†

**åŠŸèƒ½æè¿°**ï¼šç”¨æˆ·å¯ä»¥ç»‘å®š/è§£ç»‘å¤šç§æ”¯ä»˜æ–¹å¼ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ã€Apple Payã€é“¶è”ç­‰ï¼‰ã€‚

**ç•Œé¢ç»“æ„**ï¼š

```html
<!-- æ”¯ä»˜ç»‘å®šé¡µé¢ -->
<div class="page" id="page-bindpay">
  <h2>æ”¯ä»˜è®¾ç½®</h2>
  
  <div class="payment-bind-list" id="paymentBindList">
    <!-- å¾®ä¿¡æ”¯ä»˜ -->
    <div class="payment-bind-item" data-method="wechat">
      <div class="payment-icon">ğŸŸ¢</div>
      <div class="payment-info">
        <div class="payment-name">å¾®ä¿¡æ”¯ä»˜</div>
        <div class="payment-account" id="wechat_account">æœªç»‘å®š</div>
      </div>
      <div class="payment-action">
        <button class="bind-btn" data-method="wechat">ç»‘å®š</button>
        <button class="unbind-btn" data-method="wechat" style="display:none;">è§£ç»‘</button>
      </div>
    </div>
  
    <!-- æ”¯ä»˜å® -->
    <div class="payment-bind-item" data-method="alipay">
      <div class="payment-icon">ğŸ”µ</div>
      <div class="payment-info">
        <div class="payment-name">æ”¯ä»˜å®</div>
        <div class="payment-account" id="alipay_account">æœªç»‘å®š</div>
      </div>
      <div class="payment-action">
        <button class="bind-btn" data-method="alipay">ç»‘å®š</button>
        <button class="unbind-btn" data-method="alipay" style="display:none;">è§£ç»‘</button>
      </div>
    </div>
  
    <!-- Apple Pay -->
    <div class="payment-bind-item" data-method="apple_pay">
      <div class="payment-icon"></div>
      <div class="payment-info">
        <div class="payment-name">Apple Pay</div>
        <div class="payment-account" id="apple_pay_account">æœªç»‘å®š</div>
      </div>
      <div class="payment-action">
        <button class="bind-btn" data-method="apple_pay">ç»‘å®š</button>
        <button class="unbind-btn" data-method="apple_pay" style="display:none;">è§£ç»‘</button>
      </div>
    </div>
  
    <!-- é“¶è” -->
    <div class="payment-bind-item" data-method="unionpay">
      <div class="payment-icon">ğŸ”´</div>
      <div class="payment-info">
        <div class="payment-name">é“¶è”</div>
        <div class="payment-account" id="unionpay_account">æœªç»‘å®š</div>
      </div>
      <div class="payment-action">
        <button class="bind-btn" data-method="unionpay">ç»‘å®š</button>
        <button class="unbind-btn" data-method="unionpay" style="display:none;">è§£ç»‘</button>
      </div>
    </div>
  </div>
</div>

<!-- ç»‘å®šè¾“å…¥å¼¹çª— -->
<div id="bindInputModal" style="display:none;">
  <h4 id="bindInputTitle">ç»‘å®šæ”¯ä»˜æ–¹å¼</h4>
  <div class="form-group">
    <label id="bindInputLabel">è´¦å·</label>
    <input type="text" id="bindAccountInput" placeholder="è¯·è¾“å…¥è´¦å·">
  </div>
  <div class="form-actions">
    <button id="bindInputCancel" class="order-btn">å–æ¶ˆ</button>
    <button id="bindInputConfirm" class="search-btn">ç¡®è®¤ç»‘å®š</button>
  </div>
</div>
```

**ç»‘å®šé€»è¾‘å®ç°**ï¼š

```javascript
// æ”¯ä»˜æ–¹å¼åç§°æ˜ å°„
const PAYMENT_NAMES = {
  'wechat': 'å¾®ä¿¡',
  'alipay': 'æ”¯ä»˜å®',
  'apple_pay': 'Apple Pay',
  'unionpay': 'é“¶è”',
  'other': 'å…¶ä»–'
};

// åŠ è½½æ”¯ä»˜ç»‘å®šçŠ¶æ€
function loadPaymentBindings() {
  const bindings = JSON.parse(localStorage.getItem('paymentBindings') || '{}');
  
  Object.keys(PAYMENT_NAMES).forEach(method => {
    const accountEl = document.getElementById(`${method}_account`);
    const bindBtn = document.querySelector(`.bind-btn[data-method="${method}"]`);
    const unbindBtn = document.querySelector(`.unbind-btn[data-method="${method}"]`);
  
    if (!accountEl) return;
  
    const binding = bindings[method];
  
    if (binding && binding.account) {
      // å·²ç»‘å®š
      accountEl.textContent = maskAccount(binding.account);
      accountEl.classList.add('bound');
      if (bindBtn) bindBtn.style.display = 'none';
      if (unbindBtn) unbindBtn.style.display = 'inline-block';
    } else {
      // æœªç»‘å®š
      accountEl.textContent = 'æœªç»‘å®š';
      accountEl.classList.remove('bound');
      if (bindBtn) bindBtn.style.display = 'inline-block';
      if (unbindBtn) unbindBtn.style.display = 'none';
    }
  });
}

// è´¦å·è„±æ•æ˜¾ç¤º
function maskAccount(account) {
  if (!account) return 'æœªç»‘å®š';
  if (account.length <= 4) return account;
  return account.slice(0, 2) + '****' + account.slice(-2);
}

// ç»‘å®šæŒ‰é’®ç‚¹å‡»
document.querySelectorAll('.bind-btn[data-method]').forEach(btn => {
  btn.addEventListener('click', function() {
    const method = this.dataset.method;
    if (!method) return;
  
    const paymentName = PAYMENT_NAMES[method] || method;
  
    // è®¾ç½®å¼¹çª—æ ‡é¢˜å’Œæç¤º
    document.getElementById('bindInputTitle').textContent = `ç»‘å®š${paymentName}`;
    document.getElementById('bindInputLabel').textContent = `è¯·è¾“å…¥${paymentName}è´¦å·`;
    document.getElementById('bindAccountInput').value = '';
    document.getElementById('bindAccountInput').placeholder = `è¯·è¾“å…¥è¦ç»‘å®šçš„${paymentName}è´¦å·`;
  
    // ä¿å­˜å½“å‰ç»‘å®šçš„æ”¯ä»˜æ–¹å¼
    window.currentBindMethod = method;
  
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('paymentBackdrop').style.display = 'block';
    document.getElementById('bindInputModal').style.display = 'block';
  });
});

// ç¡®è®¤ç»‘å®š
document.getElementById('bindInputConfirm').addEventListener('click', function() {
  const method = window.currentBindMethod;
  const account = document.getElementById('bindAccountInput').value.trim();
  
  if (!account) {
    alert('è¯·è¾“å…¥è´¦å·');
    return;
  }
  
  // ä¿å­˜åˆ° localStorage
  const bindings = JSON.parse(localStorage.getItem('paymentBindings') || '{}');
  bindings[method] = {
    account: account,
    bindTime: new Date().toISOString()
  };
  localStorage.setItem('paymentBindings', JSON.stringify(bindings));
  
  // å…³é—­å¼¹çª—
  document.getElementById('bindInputModal').style.display = 'none';
  document.getElementById('paymentBackdrop').style.display = 'none';
  
  // åˆ·æ–°æ˜¾ç¤º
  loadPaymentBindings();
  
  alert('ç»‘å®šæˆåŠŸ');
});

// å–æ¶ˆç»‘å®šå¼¹çª—
document.getElementById('bindInputCancel').addEventListener('click', function() {
  document.getElementById('bindInputModal').style.display = 'none';
  document.getElementById('paymentBackdrop').style.display = 'none';
});

// è§£ç»‘æŒ‰é’®ç‚¹å‡»
document.querySelectorAll('.unbind-btn[data-method]').forEach(btn => {
  btn.addEventListener('click', function() {
    const method = this.dataset.method;
    if (!method) return;
  
    const paymentName = PAYMENT_NAMES[method] || method;
  
    if (!confirm(`ç¡®è®¤è§£ç»‘${paymentName}ï¼Ÿ`)) return;
  
    // ä» localStorage ç§»é™¤
    const bindings = JSON.parse(localStorage.getItem('paymentBindings') || '{}');
    delete bindings[method];
    localStorage.setItem('paymentBindings', JSON.stringify(bindings));
  
    // åˆ·æ–°æ˜¾ç¤º
    loadPaymentBindings();
  
    alert('è§£ç»‘æˆåŠŸ');
  });
});
```

**æ”¯ä»˜ç»‘å®šæ ·å¼**ï¼š

```css
/* æ”¯ä»˜ç»‘å®šåˆ—è¡¨ */
.payment-bind-list {
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.payment-bind-item {
  display: flex;
  align-items: center;
  padding: 18px 20px;
  border-bottom: 1px solid #f5f5f5;
}

.payment-bind-item:last-child {
  border-bottom: none;
}

.payment-icon {
  font-size: 28px;
  margin-right: 15px;
}

.payment-info {
  flex: 1;
}

.payment-name {
  font-size: 15px;
  font-weight: 500;
  color: #333;
}

.payment-account {
  font-size: 13px;
  color: #999;
  margin-top: 4px;
}

.payment-account.bound {
  color: #4caf50;
}

.payment-action button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
}

.bind-btn {
  background: #e3f2fd;
  color: #1565c0;
}

.unbind-btn {
  background: #ffebee;
  color: #c62828;
}
```

##### 4.1.4.5 é€€å‡ºç™»å½•

**åŠŸèƒ½æè¿°**ï¼šæ¸…é™¤æœ¬åœ°ç™»å½•çŠ¶æ€ï¼Œè¿”å›ç™»å½•é¡µé¢ã€‚

```javascript
// é€€å‡ºç™»å½•
document.getElementById('logoutBtn').addEventListener('click', function() {
  if (!confirm('ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ')) return;
  
  // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç™»å½•ä¿¡æ¯
  localStorage.removeItem('12306_loginUser');
  
  // å¯é€‰ï¼šä¿ç•™æ”¯ä»˜ç»‘å®šä¿¡æ¯
  // localStorage.removeItem('paymentBindings');
  
  // è·³è½¬åˆ°ç™»å½•é¡µ
  window.location.href = './login.html';
});
```

---


## 5. ç³»ç»Ÿè®¾è®¡

### 5.1 ç³»ç»Ÿæ¶æ„è®¾è®¡

#### 5.1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    å‰ç«¯åº”ç”¨ (12306.html)                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ è½¦ç¥¨æŸ¥è¯¢ â”‚ è®¢å•ç®¡ç† â”‚ ä¸ªäººä¸­å¿ƒ â”‚ æ”¯ä»˜ç»‘å®š â”‚ ä½¿ç”¨æŒ‡å—  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                         â†“ HTTP/AJAX                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    RESTful API (JSON)
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åç«¯æœåŠ¡å™¨ (Node.js + Express)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                       app.js (ç«¯å£ 3000)                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ ç”¨æˆ·API â”‚ è®¢å•API â”‚ ä¹˜å®¢API â”‚ æ”¯ä»˜API â”‚ é™æ€æ–‡ä»¶æœåŠ¡  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                         â†“ mysql2                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    MySQL Connection
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®åº“ (MySQL 8.0)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   user   â”‚  orders  â”‚ frequent_pass.  â”‚ payment_bindings  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.1.2 æŠ€æœ¯é€‰å‹

| å±‚æ¬¡       | æŠ€æœ¯                  | ç‰ˆæœ¬ | è¯´æ˜                         |
| ---------- | --------------------- | ---- | ---------------------------- |
| å‰ç«¯       | HTML5/CSS3/JavaScript | ES6+ | åŸç”Ÿå¼€å‘ï¼Œæ— æ¡†æ¶ä¾èµ–         |
| åç«¯       | Node.js               | 18.x | JavaScript è¿è¡Œæ—¶            |
| åç«¯æ¡†æ¶   | Express.js            | 4.x  | è½»é‡çº§ Web æ¡†æ¶              |
| æ•°æ®åº“     | MySQL                 | 8.0  | å…³ç³»å‹æ•°æ®åº“                 |
| æ•°æ®åº“é©±åŠ¨ | mysql2                | 3.x  | æ”¯æŒ Promise çš„ MySQL å®¢æˆ·ç«¯ |
| ä¸­é—´ä»¶     | cors                  | 2.x  | è·¨åŸŸèµ„æºå…±äº«                 |
| ä¸­é—´ä»¶     | body-parser           | 1.x  | è¯·æ±‚ä½“è§£æ                   |

#### 5.1.3 ç›®å½•ç»“æ„

```
mysql-demo/
â”œâ”€â”€ package.json              # æ ¹ç›®å½•é…ç½®æ–‡ä»¶
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ package.json          # åç«¯ä¾èµ–é…ç½®
â”‚   â””â”€â”€ app.js                # åç«¯ä¸»ç¨‹åº (606 è¡Œ)
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ 12306.html            # ä¸»åº”ç”¨é¡µé¢ (2778 è¡Œ)
â”‚   â”œâ”€â”€ login.html            # ç™»å½•/æ³¨å†Œé¡µé¢
â”‚   â””â”€â”€ train-data.js         # é™æ€è½¦æ¬¡æ•°æ®
â””â”€â”€ docs/
    â””â”€â”€ *.md                  # é¡¹ç›®æ–‡æ¡£
```

### 5.2 æ•°æ®åº“è®¾è®¡

#### 5.2.1 E-R å›¾ï¼ˆå®ä½“å…³ç³»å›¾ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         1:N         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    user     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    orders    â”‚
â”‚  (ç”¨æˆ·è¡¨)   â”‚                     â”‚   (è®¢å•è¡¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ 1:N
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ frequent_passengers â”‚
â”‚   (å¸¸ç”¨ä¹˜è½¦äººè¡¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  payment_bindings   â”‚
â”‚   (æ”¯ä»˜ç»‘å®šè¡¨)      â”‚ â† å½“å‰ä½¿ç”¨ localStorage å­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.2.2 æ•°æ®è¡¨è¯¦ç»†è®¾è®¡

##### 5.2.2.1 ç”¨æˆ·è¡¨ï¼ˆuserï¼‰

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
  `username` varchar(50) NOT NULL COMMENT 'ç”¨æˆ·å',
  `password` varchar(255) NOT NULL COMMENT 'å¯†ç ï¼ˆæ˜æ–‡å­˜å‚¨ï¼Œç”Ÿäº§ç¯å¢ƒåº”åŠ å¯†ï¼‰',
  `name` varchar(50) DEFAULT NULL COMMENT 'çœŸå®å§“å',
  `phone` varchar(20) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `id_card` varchar(18) DEFAULT NULL COMMENT 'èº«ä»½è¯å·',
  `is_verified` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦å®åè®¤è¯ 0-å¦ 1-æ˜¯',
  `avatar` text DEFAULT NULL COMMENT 'å¤´åƒï¼ˆBase64ï¼‰',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';

-- å­—æ®µè¯´æ˜ï¼š
-- id: ä¸»é”®ï¼Œè‡ªå¢
-- username: ç™»å½•ç”¨æˆ·åï¼Œå”¯ä¸€
-- password: ç™»å½•å¯†ç 
-- name: å®åè®¤è¯åçš„çœŸå®å§“å
-- phone: æ‰‹æœºå·ç 
-- id_card: 18ä½èº«ä»½è¯å·
-- is_verified: å®åè®¤è¯çŠ¶æ€
-- avatar: Base64ç¼–ç çš„å¤´åƒå›¾ç‰‡
```

##### 5.2.2.2 è®¢å•è¡¨ï¼ˆordersï¼‰

```sql
-- è®¢å•è¡¨
CREATE TABLE `orders` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'è®°å½•ID',
  `order_no` varchar(32) NOT NULL COMMENT 'è®¢å•å·ï¼ˆ10ä½å”¯ä¸€ï¼‰',
  `user_id` int(11) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `start_city` varchar(50) NOT NULL COMMENT 'å‡ºå‘åŸå¸‚',
  `end_city` varchar(50) NOT NULL COMMENT 'åˆ°è¾¾åŸå¸‚',
  `train_no` varchar(20) DEFAULT NULL COMMENT 'è½¦æ¬¡å·',
  `price` decimal(10,2) NOT NULL COMMENT 'ç¥¨ä»·',
  `depart_time` datetime DEFAULT NULL COMMENT 'å‡ºå‘æ—¶é—´',
  `seat_type` varchar(20) DEFAULT 'äºŒç­‰åº§' COMMENT 'å¸­åˆ«',
  `status` enum('pending','paid','waitlist','cancelled','refunded','rescheduled') 
    DEFAULT 'pending' COMMENT 'è®¢å•çŠ¶æ€',
  `payment_method` varchar(20) DEFAULT NULL COMMENT 'æ”¯ä»˜æ–¹å¼',
  `passenger_name` varchar(50) DEFAULT NULL COMMENT 'ä¹˜å®¢å§“å',
  `passenger_id_card` varchar(20) DEFAULT NULL COMMENT 'ä¹˜å®¢èº«ä»½è¯',
  `passenger_phone` varchar(20) DEFAULT NULL COMMENT 'ä¹˜å®¢ç”µè¯',
  `rescheduled_from` varchar(32) DEFAULT NULL COMMENT 'æ”¹ç­¾æ¥æºè®¢å•å·',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•è¡¨';

-- è®¢å•çŠ¶æ€è¯´æ˜ï¼š
-- pending: å¾…æ”¯ä»˜ï¼ˆç”¨æˆ·ä¸‹å•ä½†æœªå®Œæˆæ”¯ä»˜ï¼‰
-- paid: å·²æ”¯ä»˜ï¼ˆæ”¯ä»˜æˆåŠŸçš„æœ‰æ•ˆè®¢å•ï¼‰
-- waitlist: å€™è¡¥ä¸­ï¼ˆæ— ç¥¨æ—¶çš„å€™è¡¥è®¢å•ï¼‰
-- cancelled: å·²å–æ¶ˆï¼ˆç”¨æˆ·ä¸»åŠ¨å–æ¶ˆï¼‰
-- refunded: å·²é€€ç¥¨ï¼ˆæ”¯ä»˜åç”³è¯·é€€ç¥¨ï¼‰
-- rescheduled: å·²æ”¹ç­¾ï¼ˆåŸè®¢å•è¢«æ”¹ç­¾åˆ°æ–°è®¢å•ï¼‰
```

##### 5.2.2.3 å¸¸ç”¨ä¹˜è½¦äººè¡¨ï¼ˆfrequent_passengersï¼‰

```sql
-- å¸¸ç”¨ä¹˜è½¦äººè¡¨
CREATE TABLE `frequent_passengers` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'è®°å½•ID',
  `user_id` int(11) NOT NULL COMMENT 'æ‰€å±ç”¨æˆ·ID',
  `passenger_name` varchar(50) NOT NULL COMMENT 'ä¹˜å®¢å§“å',
  `passenger_id_card` varchar(18) NOT NULL COMMENT 'èº«ä»½è¯å·',
  `passenger_phone` varchar(11) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_passenger` (`user_id`, `passenger_id_card`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å¸¸ç”¨ä¹˜è½¦äººè¡¨';

-- çº¦æŸè¯´æ˜ï¼š
-- åŒä¸€ç”¨æˆ·ä¸‹ï¼ŒåŒä¸€èº«ä»½è¯å·åªèƒ½æ·»åŠ ä¸€æ¬¡ï¼ˆå”¯ä¸€çº¦æŸï¼‰
```

#### 5.2.3 æ•°æ®å­—å…¸

##### è®¢å•çŠ¶æ€æšä¸¾

| çŠ¶æ€å€¼      | ä¸­æ–‡å | è¯´æ˜                     | å¯æ‰§è¡Œæ“ä½œ     |
| ----------- | ------ | ------------------------ | -------------- |
| pending     | å¾…æ”¯ä»˜ | è®¢å•å·²åˆ›å»ºï¼Œç­‰å¾…ç”¨æˆ·æ”¯ä»˜ | ç»§ç»­æ”¯ä»˜ã€å–æ¶ˆ |
| paid        | å·²æ”¯ä»˜ | æ”¯ä»˜æˆåŠŸï¼Œè½¦ç¥¨æœ‰æ•ˆ       | é€€ç¥¨ã€æ”¹ç­¾     |
| waitlist    | å€™è¡¥ä¸­ | æ— ç¥¨æ—¶çš„å€™è¡¥è®¢å•         | å–æ¶ˆå€™è¡¥       |
| cancelled   | å·²å–æ¶ˆ | ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆçš„è®¢å•       | æ—              |
| refunded    | å·²é€€ç¥¨ | å·²æ”¯ä»˜è®¢å•ç”³è¯·é€€ç¥¨æˆåŠŸ   | æ—              |
| rescheduled | å·²æ”¹ç­¾ | åŸè®¢å•å·²æ”¹ç­¾åˆ°æ–°è®¢å•     | æ—              |

##### æ”¯ä»˜æ–¹å¼æšä¸¾

| å€¼        | åç§°      | å›¾æ ‡ | è¯´æ˜              |
| --------- | --------- | ---- | ----------------- |
| wechat    | å¾®ä¿¡æ”¯ä»˜  | ğŸŸ¢   | æ‰«ç æ”¯ä»˜æ¨¡æ‹Ÿ      |
| alipay    | æ”¯ä»˜å®    | ğŸ”µ   | æ‰«ç æ”¯ä»˜æ¨¡æ‹Ÿ      |
| apple_pay | Apple Pay |      | æŒ‡çº¹/é¢å®¹éªŒè¯æ¨¡æ‹Ÿ |
| unionpay  | é“¶è”      | ğŸ”´   | å¯†ç éªŒè¯æ¨¡æ‹Ÿ      |
| other     | å…¶ä»–      | âšª   | å…¶ä»–æ”¯ä»˜æ–¹å¼      |

##### å¸­åˆ«æšä¸¾

| å€¼     | åç§°   | ä»·æ ¼ç³»æ•°                   |
| ------ | ------ | -------------------------- |
| äºŒç­‰åº§ | äºŒç­‰åº§ | 1.0ï¼ˆåŸºå‡†ä»·ï¼‰              |
| ä¸€ç­‰åº§ | ä¸€ç­‰åº§ | 1.6ï¼ˆçº¦ä¸ºäºŒç­‰åº§çš„ 1.6 å€ï¼‰ |
| æ— åº§   | æ— åº§   | ä¸äºŒç­‰åº§åŒä»·               |

### 5.3 æ¥å£è®¾è®¡

#### 5.3.1 API æ¥å£åˆ—è¡¨

| æ–¹æ³•   | è·¯å¾„                         | åŠŸèƒ½         | è¯·æ±‚å‚æ•°                     | å“åº”æ•°æ®                   |
| ------ | ---------------------------- | ------------ | ---------------------------- | -------------------------- |
| POST   | /api/register                | ç”¨æˆ·æ³¨å†Œ     | username, password           | {code, msg, data}          |
| POST   | /api/login                   | ç”¨æˆ·ç™»å½•     | username, password           | {code, msg, data: user}    |
| POST   | /api/verify                  | å®åè®¤è¯     | userId, name, id_card, phone | {code, msg}                |
| GET    | /api/orders                  | è·å–è®¢å•åˆ—è¡¨ | userId                       | {code, data: orders[]}     |
| POST   | /api/orders                  | åˆ›å»ºè®¢å•     | orderå¯¹è±¡                    | {code, msg, data: order}   |
| PATCH  | /api/orders/:orderNo/cancel  | å–æ¶ˆ/é€€ç¥¨    | orderNo                      | {code, msg}                |
| PATCH  | /api/orders/reschedule       | æ”¹ç­¾è®¢å•     | orderNo, newInfo             | {code, msg, data}          |
| GET    | /api/frequent_passengers     | è·å–å¸¸ç”¨ä¹˜å®¢ | userId                       | {code, data: passengers[]} |
| POST   | /api/frequent_passengers     | æ·»åŠ ä¹˜å®¢     | passengerå¯¹è±¡                | {code, msg, data}          |
| DELETE | /api/frequent_passengers/:id | åˆ é™¤ä¹˜å®¢     | id                           | {code, msg}                |

#### 5.3.2 æ¥å£è¯¦ç»†å®šä¹‰

##### ç”¨æˆ·æ³¨å†Œæ¥å£

```
POST /api/register
Content-Type: application/json

è¯·æ±‚ä½“ï¼š
{
  "username": "string",  // å¿…å¡«ï¼Œç”¨æˆ·å
  "password": "string"   // å¿…å¡«ï¼Œå¯†ç 
}

æˆåŠŸå“åº”ï¼ˆ200ï¼‰ï¼š
{
  "code": 0,
  "msg": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "userId": 1,
    "username": "testuser"
  }
}

å¤±è´¥å“åº”ï¼ˆ200ï¼‰ï¼š
{
  "code": -1,
  "msg": "ç”¨æˆ·åå·²å­˜åœ¨"
}
```

##### ç”¨æˆ·ç™»å½•æ¥å£

```
POST /api/login
Content-Type: application/json

è¯·æ±‚ä½“ï¼š
{
  "username": "string",
  "password": "string"
}

æˆåŠŸå“åº”ï¼š
{
  "code": 0,
  "msg": "ç™»å½•æˆåŠŸ",
  "data": {
    "userId": 1,
    "username": "testuser",
    "name": "å¼ ä¸‰",
    "phone": "13800138000",
    "id_card": "440300199001011234",
    "is_verified": 1
  }
}
```

##### åˆ›å»ºè®¢å•æ¥å£

```
POST /api/orders
Content-Type: application/json

è¯·æ±‚ä½“ï¼š
{
  "userId": 1,                        // å¿…å¡«ï¼Œç”¨æˆ·ID
  "start_city": "æ·±åœ³",               // å¿…å¡«ï¼Œå‡ºå‘åŸå¸‚
  "end_city": "ä¸Šæµ·",                 // å¿…å¡«ï¼Œåˆ°è¾¾åŸå¸‚
  "train_no": "G1234",                // è½¦æ¬¡å·
  "price": 760.00,                    // ç¥¨ä»·
  "depart_time": "2024-12-01 08:00",  // å‡ºå‘æ—¶é—´
  "seat_type": "äºŒç­‰åº§",              // å¸­åˆ«
  "status": "paid",                   // è®¢å•çŠ¶æ€
  "payment_method": "wechat",         // æ”¯ä»˜æ–¹å¼
  "passenger_name": "å¼ ä¸‰",           // ä¹˜å®¢å§“å
  "passenger_id_card": "440300...",   // ä¹˜å®¢èº«ä»½è¯
  "passenger_phone": "13800138000"    // ä¹˜å®¢ç”µè¯
}

æˆåŠŸå“åº”ï¼š
{
  "code": 0,
  "msg": "è®¢å•åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 1,
    "order_no": "1234567890",
    "user_id": 1,
    "start_city": "æ·±åœ³",
    "end_city": "ä¸Šæµ·",
    // ... å®Œæ•´è®¢å•ä¿¡æ¯
  }
}
```

##### æ”¹ç­¾è®¢å•æ¥å£

```
PATCH /api/orders/reschedule
Content-Type: application/json

è¯·æ±‚ä½“ï¼š
{
  "orderNo": "1234567890",            // å¿…å¡«ï¼ŒåŸè®¢å•å·
  "newDepartTime": "2024-12-02 10:00",// æ–°å‡ºå‘æ—¶é—´
  "newTrainNo": "G5678",              // æ–°è½¦æ¬¡å·
  "newSeatType": "ä¸€ç­‰åº§",            // æ–°å¸­åˆ«
  "priceDiff": 50                     // å·®ä»·ï¼ˆæ­£æ•°è¡¥æ¬¾ï¼Œè´Ÿæ•°é€€æ¬¾ï¼‰
}

æˆåŠŸå“åº”ï¼š
{
  "code": 0,
  "msg": "æ”¹ç­¾æˆåŠŸ",
  "data": {
    "oldOrderNo": "1234567890",
    "newOrder": {
      "order_no": "0987654321",
      // ... æ–°è®¢å•å®Œæ•´ä¿¡æ¯
    },
    "priceDiff": 50
  }
}
```

### 5.4 å‰ç«¯é¡µé¢è®¾è®¡

#### 5.4.1 é¡µé¢å¯¼èˆªç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é¡¶éƒ¨æ ‡é¢˜æ                                â”‚
â”‚    ğŸš„ é“è·¯12306                          [æ¬¢è¿ï¼Œå¼ ä¸‰] [é€€å‡º]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        åº•éƒ¨å¯¼èˆªæ                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ ğŸ«  â”‚  â”‚ ğŸ“‹  â”‚  â”‚ ğŸ‘¤  â”‚  â”‚ ğŸ’³  â”‚  â”‚ â“  â”‚           â”‚
â”‚   â”‚ é¦–é¡µ â”‚  â”‚ è®¢å• â”‚  â”‚ æˆ‘çš„ â”‚  â”‚ æ”¯ä»˜ â”‚  â”‚ æŒ‡å— â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.4.2 é¡µé¢åˆ—è¡¨

| é¡µé¢ID          | åç§°   | åŠŸèƒ½æè¿°       |
| --------------- | ------ | -------------- |
| page-ticket     | é¦–é¡µ   | è½¦ç¥¨æŸ¥è¯¢ä¸é¢„è®¢ |
| page-orders     | è®¢å•   | è®¢å•åˆ—è¡¨ä¸ç®¡ç† |
| page-user       | æˆ‘çš„   | ä¸ªäººä¸­å¿ƒ       |
| page-passengers | ä¹˜è½¦äºº | å¸¸ç”¨ä¹˜è½¦äººç®¡ç† |
| page-bindpay    | æ”¯ä»˜   | æ”¯ä»˜æ–¹å¼ç»‘å®š   |
| page-guide      | æŒ‡å—   | ä½¿ç”¨å¸®åŠ©       |

#### 5.4.3 å¼¹çª—ç»„ä»¶åˆ—è¡¨

| å¼¹çª—ID          | åç§°           | è§¦å‘åœºæ™¯            |
| --------------- | -------------- | ------------------- |
| bookingModal    | é¢„è®¢ç¡®è®¤å¼¹çª—   | ç‚¹å‡»"é¢„è®¢"æŒ‰é’®      |
| qrPaymentModal  | äºŒç»´ç æ”¯ä»˜å¼¹çª— | é€‰æ‹©å¾®ä¿¡/æ”¯ä»˜å®æ”¯ä»˜ |
| applePayModal   | Apple Pay å¼¹çª— | é€‰æ‹© Apple Pay      |
| unionPayModal   | é“¶è”æ”¯ä»˜å¼¹çª—   | é€‰æ‹©é“¶è”æ”¯ä»˜        |
| rescheduleModal | æ”¹ç­¾å¼¹çª—       | ç‚¹å‡»"æ”¹ç­¾"æŒ‰é’®      |
| passengerModal  | ä¹˜å®¢ç¼–è¾‘å¼¹çª—   | æ·»åŠ /ç¼–è¾‘ä¹˜è½¦äºº     |
| bindInputModal  | æ”¯ä»˜ç»‘å®šå¼¹çª—   | ç»‘å®šæ–°æ”¯ä»˜æ–¹å¼      |
| identityModal   | èº«ä»½éªŒè¯å¼¹çª—   | é¦–æ¬¡è´­ç¥¨éªŒè¯        |

### 5.5 å®‰å…¨è®¾è®¡

#### 5.5.1 å½“å‰å®ç°çš„å®‰å…¨æªæ–½

| æªæ–½         | å®ç°æ–¹å¼       | ä½ç½®        |
| ------------ | -------------- | ----------- |
| è¾“å…¥æ ¡éªŒ     | æ­£åˆ™è¡¨è¾¾å¼éªŒè¯ | å‰ç«¯ + åç«¯ |
| SQLæ³¨å…¥é˜²æŠ¤  | å‚æ•°åŒ–æŸ¥è¯¢     | åç«¯        |
| ç™»å½•çŠ¶æ€å­˜å‚¨ | localStorage   | å‰ç«¯        |
| é˜²æŠ–æ§åˆ¶     | 800ms æ—¶é—´é—´éš” | å‰ç«¯æŸ¥è¯¢    |
| æ•æ„Ÿä¿¡æ¯è„±æ• | æ˜¾ç¤ºæ—¶éƒ¨åˆ†éšè— | å‰ç«¯        |

#### 5.5.2 åç«¯å‚æ•°åŒ–æŸ¥è¯¢ç¤ºä¾‹

```javascript
// ä½¿ç”¨å ä½ç¬¦é˜²æ­¢ SQL æ³¨å…¥
app.post('/api/login', (req, res) => {
  const { username, password } = req.body;
  
  // æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
  const sql = 'SELECT * FROM user WHERE username = ? AND password = ?';
  db.query(sql, [username, password], (err, rows) => {
    // ...
  });
  
  // é”™è¯¯ç¤ºä¾‹ï¼ˆä¸è¦è¿™æ ·åšï¼‰ï¼š
  // const sql = `SELECT * FROM user WHERE username = '${username}'`;
});
```

#### 5.5.3 å‰ç«¯è¾“å…¥éªŒè¯ç¤ºä¾‹

```javascript
// èº«ä»½è¯å·éªŒè¯
function validateIdCard(idCard) {
  return /^\d{17}[\dXx]$/.test(idCard);
}

// æ‰‹æœºå·éªŒè¯
function validatePhone(phone) {
  return /^1\d{10}$/.test(phone);
}

// ä½¿ç”¨ç¤ºä¾‹
if (!validateIdCard(idCard)) {
  alert('èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®');
  return;
}
```

---


## 6. ç³»ç»Ÿå®ç°

### 6.1 å¼€å‘ç¯å¢ƒæ­å»º

#### 6.1.1 ç¯å¢ƒè¦æ±‚

| è½¯ä»¶    | ç‰ˆæœ¬è¦æ±‚                     | è¯´æ˜              |
| ------- | ---------------------------- | ----------------- |
| Node.js | >= 18.0                      | JavaScript è¿è¡Œæ—¶ |
| npm     | >= 9.0                       | åŒ…ç®¡ç†å™¨          |
| MySQL   | >= 8.0                       | æ•°æ®åº“æœåŠ¡        |
| æµè§ˆå™¨  | Chrome/Firefox/Safari æœ€æ–°ç‰ˆ | å‰ç«¯è¿è¡Œç¯å¢ƒ      |

#### 6.1.2 é¡¹ç›®åˆå§‹åŒ–

```bash
# 1. åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir mysql-demo
cd mysql-demo

# 2. åˆå§‹åŒ–åç«¯
mkdir backend && cd backend
npm init -y
npm install express mysql2 cors body-parser

# 3. åˆ›å»ºå‰ç«¯ç›®å½•
cd ..
mkdir frontend

# 4. åˆ›å»ºå¿…è¦æ–‡ä»¶
touch backend/app.js
touch frontend/12306.html
touch frontend/login.html
touch frontend/train-data.js
```

#### 6.1.3 æ•°æ®åº“åˆå§‹åŒ–

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS test_db 
  DEFAULT CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;

USE test_db;

-- åˆ›å»ºç”¨æˆ·è¡¨
CREATE TABLE IF NOT EXISTS `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL,
  `password` varchar(255) NOT NULL,
  `name` varchar(50) DEFAULT NULL,
  `phone` varchar(20) DEFAULT NULL,
  `id_card` varchar(18) DEFAULT NULL,
  `is_verified` tinyint(1) DEFAULT 0,
  `avatar` text DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- åˆ›å»ºè®¢å•è¡¨
CREATE TABLE IF NOT EXISTS `orders` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(32) NOT NULL,
  `user_id` int(11) NOT NULL,
  `start_city` varchar(50) NOT NULL,
  `end_city` varchar(50) NOT NULL,
  `train_no` varchar(20) DEFAULT NULL,
  `price` decimal(10,2) NOT NULL,
  `depart_time` datetime DEFAULT NULL,
  `seat_type` varchar(20) DEFAULT 'äºŒç­‰åº§',
  `status` enum('pending','paid','waitlist','cancelled','refunded','rescheduled') DEFAULT 'pending',
  `payment_method` varchar(20) DEFAULT NULL,
  `passenger_name` varchar(50) DEFAULT NULL,
  `passenger_id_card` varchar(20) DEFAULT NULL,
  `passenger_phone` varchar(20) DEFAULT NULL,
  `rescheduled_from` varchar(32) DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- åˆ›å»ºå¸¸ç”¨ä¹˜è½¦äººè¡¨
CREATE TABLE IF NOT EXISTS `frequent_passengers` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `passenger_name` varchar(50) NOT NULL,
  `passenger_id_card` varchar(18) NOT NULL,
  `passenger_phone` varchar(11) DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_passenger` (`user_id`, `passenger_id_card`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 6.2 æ ¸å¿ƒæ¨¡å—å®ç°

#### 6.2.1 åç«¯æœåŠ¡å™¨é…ç½®

```javascript
// backend/app.js

const express = require('express');
const mysql = require('mysql2');
const cors = require('cors');
const bodyParser = require('body-parser');
const path = require('path');

const app = express();

// ä¸­é—´ä»¶é…ç½®
app.use(cors());                              // å…è®¸è·¨åŸŸè¯·æ±‚
app.use(bodyParser.json());                   // è§£æ JSON è¯·æ±‚ä½“
app.use(bodyParser.urlencoded({ extended: true }));

// é™æ€æ–‡ä»¶æœåŠ¡ - æä¾›å‰ç«¯é¡µé¢
app.use(express.static(path.join(__dirname, '../frontend')));

// MySQL æ•°æ®åº“è¿æ¥é…ç½®
const db = mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: 'password',    // æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
  database: 'test_db'
});

// å»ºç«‹æ•°æ®åº“è¿æ¥
db.connect(err => {
  if (err) {
    console.error('æ•°æ®åº“è¿æ¥å¤±è´¥:', err);
    process.exit(1);
  }
  console.log('âœ“ æ•°æ®åº“è¿æ¥æˆåŠŸ');
});

// å¯åŠ¨æœåŠ¡å™¨
const PORT = 3000;
app.listen(PORT, () => {
  console.log(`âœ“ æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:${PORT}`);
  console.log(`  å‰ç«¯é¡µé¢: http://localhost:${PORT}/12306.html`);
  console.log(`  ç™»å½•é¡µé¢: http://localhost:${PORT}/login.html`);
});
```

#### 6.2.2 ç”¨æˆ·è®¤è¯æ¨¡å—å®ç°

```javascript
// ç”¨æˆ·æ³¨å†Œ
app.post('/api/register', (req, res) => {
  const { username, password } = req.body;
  
  if (!username || !password) {
    return res.json({ code: -1, msg: 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º' });
  }

  // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
  const checkSql = 'SELECT id FROM user WHERE username = ?';
  db.query(checkSql, [username], (err, rows) => {
    if (err) {
      return res.json({ code: -1, msg: 'æŸ¥è¯¢å¤±è´¥' });
    }
    if (rows.length > 0) {
      return res.json({ code: -1, msg: 'ç”¨æˆ·åå·²å­˜åœ¨' });
    }

    // æ’å…¥æ–°ç”¨æˆ·
    const insertSql = 'INSERT INTO user (username, password) VALUES (?, ?)';
    db.query(insertSql, [username, password], (err2, result) => {
      if (err2) {
        return res.json({ code: -1, msg: 'æ³¨å†Œå¤±è´¥' });
      }
      res.json({
        code: 0,
        msg: 'æ³¨å†ŒæˆåŠŸ',
        data: { userId: result.insertId, username }
      });
    });
  });
});

// ç”¨æˆ·ç™»å½•
app.post('/api/login', (req, res) => {
  const { username, password } = req.body;
  
  if (!username || !password) {
    return res.json({ code: -1, msg: 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º' });
  }

  const sql = 'SELECT * FROM user WHERE username = ? AND password = ?';
  db.query(sql, [username, password], (err, rows) => {
    if (err) {
      return res.json({ code: -1, msg: 'æŸ¥è¯¢å¤±è´¥' });
    }
    if (rows.length === 0) {
      return res.json({ code: -1, msg: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' });
    }

    const user = rows[0];
    res.json({
      code: 0,
      msg: 'ç™»å½•æˆåŠŸ',
      data: {
        userId: user.id,
        username: user.username,
        name: user.name,
        phone: user.phone,
        id_card: user.id_card,
        is_verified: user.is_verified
      }
    });
  });
});

// å®åè®¤è¯
app.post('/api/verify', (req, res) => {
  const { userId, name, id_card, phone } = req.body;
  
  if (!userId || !name || !id_card || !phone) {
    return res.json({ code: -1, msg: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯' });
  }

  // éªŒè¯èº«ä»½è¯æ ¼å¼
  if (!/^\d{17}[\dXx]$/.test(id_card)) {
    return res.json({ code: -1, msg: 'èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®' });
  }

  // éªŒè¯æ‰‹æœºå·æ ¼å¼
  if (!/^1\d{10}$/.test(phone)) {
    return res.json({ code: -1, msg: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®' });
  }

  const sql = `
    UPDATE user 
    SET name = ?, id_card = ?, phone = ?, is_verified = 1, updated_at = NOW()
    WHERE id = ?
  `;
  
  db.query(sql, [name, id_card, phone, userId], (err, result) => {
    if (err) {
      return res.json({ code: -1, msg: 'è®¤è¯å¤±è´¥' });
    }
    if (result.affectedRows === 0) {
      return res.json({ code: -1, msg: 'ç”¨æˆ·ä¸å­˜åœ¨' });
    }
    res.json({ code: 0, msg: 'å®åè®¤è¯æˆåŠŸ' });
  });
});
```

#### 6.2.3 è®¢å•å·ç”Ÿæˆç®—æ³•

```javascript
/**
 * ç”Ÿæˆå”¯ä¸€çš„ 10 ä½è®¢å•å·
 * ç®—æ³•ï¼šéšæœºç”Ÿæˆ 10 ä½æ•°å­—ï¼ŒæŸ¥è¯¢æ•°æ®åº“ç¡®ä¿å”¯ä¸€æ€§
 * @param {number} attempts - æœ€å¤§é‡è¯•æ¬¡æ•°
 * @param {function} cb - å›è°ƒå‡½æ•° (error, orderNo)
 */
function generateUniqueOrderNo(attempts, cb) {
  // ç”Ÿæˆ 10 ä½éšæœºæ•°å­—
  const candidate = String(Math.floor(Math.random() * 1e10)).padStart(10, '0');
  
  // æŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨
  db.query('SELECT 1 FROM orders WHERE order_no = ?', [candidate], (err, rows) => {
    if (err) return cb(err);
  
    if (rows && rows.length > 0) {
      // è®¢å•å·å·²å­˜åœ¨ï¼Œé€’å½’é‡è¯•
      if (attempts <= 0) {
        return cb(new Error('æ— æ³•ç”Ÿæˆå”¯ä¸€è®¢å•å·ï¼Œè¯·é‡è¯•'));
      }
      return setImmediate(() => generateUniqueOrderNo(attempts - 1, cb));
    }
  
    // è®¢å•å·å¯ç”¨
    cb(null, candidate);
  });
}

// ä½¿ç”¨ç¤ºä¾‹
generateUniqueOrderNo(5, (err, orderNo) => {
  if (err) {
    console.error('ç”Ÿæˆè®¢å•å·å¤±è´¥:', err);
    return;
  }
  console.log('ç”Ÿæˆçš„è®¢å•å·:', orderNo);
});
```

#### 6.2.4 å‰ç«¯é¡µé¢åˆ‡æ¢å®ç°

```javascript
// å•é¡µåº”ç”¨é¡µé¢åˆ‡æ¢é€»è¾‘
function showPage(pageId) {
  // éšè—æ‰€æœ‰é¡µé¢
  document.querySelectorAll('.page').forEach(page => {
    page.classList.remove('active');
    page.style.display = 'none';
  });
  
  // æ˜¾ç¤ºç›®æ ‡é¡µé¢
  const targetPage = document.getElementById(pageId);
  if (targetPage) {
    targetPage.classList.add('active');
    targetPage.style.display = 'block';
  }
  
  // æ›´æ–°å¯¼èˆªæ çŠ¶æ€
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.page === pageId) {
      item.classList.add('active');
    }
  });
  
  // é¡µé¢ç‰¹å®šçš„åˆå§‹åŒ–é€»è¾‘
  switch (pageId) {
    case 'page-orders':
      if (typeof loadOrders === 'function') loadOrders();
      break;
    case 'page-user':
      if (typeof updateUserCenterDisplay === 'function') updateUserCenterDisplay();
      break;
    case 'page-passengers':
      if (typeof loadPassengers === 'function') loadPassengers();
      break;
    case 'page-bindpay':
      if (typeof loadPaymentBindings === 'function') loadPaymentBindings();
      break;
  }
}

// ç»‘å®šå¯¼èˆªç‚¹å‡»äº‹ä»¶
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', function() {
    const pageId = this.dataset.page;
    if (pageId) {
      showPage(pageId);
    }
  });
});
```

#### 6.2.5 è½¦æ¬¡æœç´¢ä¸è¿‡æ»¤

```javascript
// è½¦æ¬¡æœç´¢æ ¸å¿ƒé€»è¾‘
function searchTrains(startCity, endCity, date) {
  const todayStr = new Date().toISOString().slice(0, 10);
  const isSearchingToday = (date === todayStr);
  
  // ä»æœ¬åœ°æ•°æ®ä¸­ç­›é€‰
  const filteredTrains = window.trainData.filter(train => {
    // 1. åŸå¸‚åŒ¹é…ï¼ˆæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰
    const startMatch = train.startStation.includes(startCity);
    const endMatch = train.endStation.includes(endCity);
  
    if (!startMatch || !endMatch) return false;
  
    // 2. å¦‚æœæ˜¯å½“å¤©æŸ¥è¯¢ï¼Œè¿‡æ»¤å·²å‘è½¦çš„è½¦æ¬¡
    if (isSearchingToday) {
      const departTime = parseTime(train.startTime, date);
      if (departTime && departTime.getTime() <= Date.now()) {
        return false; // å·²å‘è½¦ï¼Œä¸æ˜¾ç¤º
      }
    }
  
    return true;
  });
  
  return filteredTrains;
}

// è§£ææ—¶é—´å­—ç¬¦ä¸²
function parseTime(timeStr, dateStr) {
  try {
    let t = String(timeStr || '').trim();
    if (/^\d{1,2}:\d{2}$/.test(t)) t += ':00';
    const dtStr = dateStr + 'T' + t;
    const dt = new Date(dtStr);
    return isNaN(dt.getTime()) ? null : dt;
  } catch (e) {
    return null;
  }
}
```

### 6.3 å…³é”®åŠŸèƒ½å®ç°ç»†èŠ‚

#### 6.3.1 å€™è¡¥è´­ç¥¨é€»è¾‘

```javascript
// åˆ¤æ–­æ˜¯å¦ä¸ºå€™è¡¥è®¢å•
function isWaitlistOrder(seatSelect) {
  const selectedOption = seatSelect.options[seatSelect.selectedIndex];
  return selectedOption && selectedOption.dataset.wait === '1';
}

// å€™è¡¥è®¢å•åˆ›å»º
async function createWaitlistOrder(bookingInfo, loginUser) {
  const payload = {
    userId: loginUser.userId,
    start_city: bookingInfo.start,
    end_city: bookingInfo.end,
    train_no: bookingInfo.trainNo,
    price: bookingInfo.price,
    depart_time: bookingInfo.departTime,
    seat_type: bookingInfo.seatType,
    status: 'waitlist',  // å€™è¡¥çŠ¶æ€
    passenger_name: bookingInfo.passengerName,
    passenger_id_card: bookingInfo.passengerId,
    passenger_phone: bookingInfo.passengerPhone
  };

  const response = await fetch('http://localhost:3000/api/orders', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  return response.json();
}
```

#### 6.3.2 æ”¯ä»˜æ–¹å¼åŠ¨æ€æ§åˆ¶

```javascript
// æ ¹æ®ç»‘å®šçŠ¶æ€æ›´æ–°æ”¯ä»˜é€‰é¡¹
function updatePaymentOptions() {
  const bindings = JSON.parse(localStorage.getItem('paymentBindings') || '{}');
  
  document.querySelectorAll('input[name="booking_payment"]').forEach(radio => {
    const method = radio.value;
    const isBound = bindings[method] && bindings[method].account;
  
    // æœªç»‘å®šçš„æ”¯ä»˜æ–¹å¼ç¦ç”¨
    radio.disabled = !isBound;
    radio.parentElement.style.opacity = isBound ? '' : '0.5';
  
    // å¦‚æœè¢«é€‰ä¸­çš„æ”¯ä»˜æ–¹å¼æœªç»‘å®šï¼Œå–æ¶ˆé€‰ä¸­
    if (!isBound && radio.checked) {
      radio.checked = false;
    }
  });
  
  // è‡ªåŠ¨é€‰ä¸­ç¬¬ä¸€ä¸ªå¯ç”¨çš„æ”¯ä»˜æ–¹å¼
  const firstAvailable = document.querySelector('input[name="booking_payment"]:not(:disabled)');
  if (firstAvailable && !document.querySelector('input[name="booking_payment"]:checked')) {
    firstAvailable.checked = true;
  }
}
```

---

## 7. ç³»ç»Ÿæµ‹è¯•

### 7.1 æµ‹è¯•ç¯å¢ƒ

| é¡¹ç›®     | é…ç½®                                  |
| -------- | ------------------------------------- |
| æ“ä½œç³»ç»Ÿ | macOS / Windows / Linux               |
| æµè§ˆå™¨   | Chrome 120+, Firefox 120+, Safari 17+ |
| Node.js  | v18.x                                 |
| MySQL    | 8.0                                   |
| ç½‘ç»œ     | æœ¬åœ°ç¯å¢ƒ (localhost)                  |

### 7.2 åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹

#### 7.2.1 ç”¨æˆ·è®¤è¯æ¨¡å—æµ‹è¯•

| ç”¨ä¾‹ç¼–å· | æµ‹è¯•é¡¹         | æµ‹è¯•æ­¥éª¤                       | é¢„æœŸç»“æœ               | å®é™…ç»“æœ |
| -------- | -------------- | ------------------------------ | ---------------------- | -------- |
| TC-001   | æ­£å¸¸æ³¨å†Œ       | è¾“å…¥æœ‰æ•ˆç”¨æˆ·åå’Œå¯†ç ï¼Œç‚¹å‡»æ³¨å†Œ | æ³¨å†ŒæˆåŠŸï¼Œè·³è½¬ç™»å½•é¡µ   | âœ… é€šè¿‡  |
| TC-002   | é‡å¤ç”¨æˆ·åæ³¨å†Œ | ä½¿ç”¨å·²å­˜åœ¨çš„ç”¨æˆ·åæ³¨å†Œ         | æç¤º"ç”¨æˆ·åå·²å­˜åœ¨"     | âœ… é€šè¿‡  |
| TC-003   | ç©ºç”¨æˆ·åæ³¨å†Œ   | ç”¨æˆ·åä¸ºç©ºï¼Œç‚¹å‡»æ³¨å†Œ           | æç¤º"ç”¨æˆ·åä¸èƒ½ä¸ºç©º"   | âœ… é€šè¿‡  |
| TC-004   | æ­£å¸¸ç™»å½•       | è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åå¯†ç ç™»å½•       | ç™»å½•æˆåŠŸï¼Œè·³è½¬ä¸»é¡µ     | âœ… é€šè¿‡  |
| TC-005   | é”™è¯¯å¯†ç ç™»å½•   | è¾“å…¥é”™è¯¯å¯†ç                    | æç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯" | âœ… é€šè¿‡  |
| TC-006   | å®åè®¤è¯       | å¡«å†™æ­£ç¡®çš„å§“åã€èº«ä»½è¯ã€æ‰‹æœºå· | è®¤è¯æˆåŠŸ               | âœ… é€šè¿‡  |
| TC-007   | æ— æ•ˆèº«ä»½è¯è®¤è¯ | è¾“å…¥æ ¼å¼é”™è¯¯çš„èº«ä»½è¯å·         | æç¤ºæ ¼å¼ä¸æ­£ç¡®         | âœ… é€šè¿‡  |

#### 7.2.2 è½¦ç¥¨é¢„è®¢æ¨¡å—æµ‹è¯•

| ç”¨ä¾‹ç¼–å· | æµ‹è¯•é¡¹         | æµ‹è¯•æ­¥éª¤                           | é¢„æœŸç»“æœ                     | å®é™…ç»“æœ |
| -------- | -------------- | ---------------------------------- | ---------------------------- | -------- |
| TC-101   | æ­£å¸¸æŸ¥è¯¢       | é€‰æ‹©æ·±åœ³åˆ°ä¸Šæµ·ï¼Œé€‰æ‹©æ—¥æœŸï¼Œç‚¹å‡»æŸ¥è¯¢ | æ˜¾ç¤ºåŒ¹é…çš„è½¦æ¬¡åˆ—è¡¨           | âœ… é€šè¿‡  |
| TC-102   | æ— ç»“æœæŸ¥è¯¢     | æŸ¥è¯¢ä¸å­˜åœ¨çš„çº¿è·¯                   | æ˜¾ç¤º"æœªæŸ¥è¯¢åˆ°ç¬¦åˆæ¡ä»¶çš„è½¦æ¬¡" | âœ… é€šè¿‡  |
| TC-103   | å½“å¤©å·²å‘è½¦è¿‡æ»¤ | æŸ¥è¯¢å½“å¤©è½¦æ¬¡                       | åªæ˜¾ç¤ºå°šæœªå‘è½¦çš„è½¦æ¬¡         | âœ… é€šè¿‡  |
| TC-104   | é¢„è®¢å¼¹çª—       | ç‚¹å‡»"é¢„è®¢"æŒ‰é’®                     | å¼¹å‡ºé¢„è®¢ç¡®è®¤å¼¹çª—             | âœ… é€šè¿‡  |
| TC-105   | é€‰æ‹©å¸­åˆ«       | åœ¨å¼¹çª—ä¸­é€‰æ‹©ä¸€ç­‰åº§/äºŒç­‰åº§          | ä»·æ ¼ç›¸åº”æ›´æ–°                 | âœ… é€šè¿‡  |
| TC-106   | å€™è¡¥é¢„è®¢       | é€‰æ‹©å·²å”®ç½„çš„å¸­åˆ«                   | æŒ‰é’®å˜ä¸º"å€™è¡¥"ï¼Œç¦ç”¨æ”¯ä»˜é€‰é¡¹ | âœ… é€šè¿‡  |
| TC-107   | é€‰æ‹©ä¹˜å®¢       | å±•å¼€ä¹˜å®¢ä¸‹æ‹‰ï¼Œé€‰æ‹©å¸¸ç”¨ä¹˜å®¢         | æ­£ç¡®æ˜¾ç¤ºä¹˜å®¢åˆ—è¡¨             | âœ… é€šè¿‡  |

#### 7.2.3 æ”¯ä»˜æ¨¡å—æµ‹è¯•

| ç”¨ä¾‹ç¼–å· | æµ‹è¯•é¡¹     | æµ‹è¯•æ­¥éª¤                 | é¢„æœŸç»“æœ               | å®é™…ç»“æœ |
| -------- | ---------- | ------------------------ | ---------------------- | -------- |
| TC-201   | å¾®ä¿¡æ”¯ä»˜   | é€‰æ‹©å¾®ä¿¡æ”¯ä»˜ï¼Œç¡®è®¤è®¢å•   | æ˜¾ç¤ºäºŒç»´ç æ”¯ä»˜å¼¹çª—     | âœ… é€šè¿‡  |
| TC-202   | æ”¯ä»˜å®æ”¯ä»˜ | é€‰æ‹©æ”¯ä»˜å®ï¼Œç¡®è®¤è®¢å•     | æ˜¾ç¤ºè“è‰²äºŒç»´ç å¼¹çª—     | âœ… é€šè¿‡  |
| TC-203   | Apple Pay  | é€‰æ‹© Apple Payï¼Œç¡®è®¤è®¢å• | æ˜¾ç¤ºæŒ‡çº¹éªŒè¯å¼¹çª—       | âœ… é€šè¿‡  |
| TC-204   | é“¶è”æ”¯ä»˜   | é€‰æ‹©é“¶è”ï¼Œç¡®è®¤è®¢å•       | æ˜¾ç¤ºå¯†ç è¾“å…¥å¼¹çª—       | âœ… é€šè¿‡  |
| TC-205   | æœªç»‘å®šæ”¯ä»˜ | æœªç»‘å®šæ”¯ä»˜æ–¹å¼æ—¶è´­ç¥¨     | å¯¹åº”æ”¯ä»˜é€‰é¡¹ç¦ç”¨       | âœ… é€šè¿‡  |
| TC-206   | æ”¯ä»˜å®Œæˆ   | å®Œæˆæ”¯ä»˜æµç¨‹             | åˆ›å»ºè®¢å•ï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º | âœ… é€šè¿‡  |

#### 7.2.4 è®¢å•ç®¡ç†æ¨¡å—æµ‹è¯•

| ç”¨ä¾‹ç¼–å· | æµ‹è¯•é¡¹       | æµ‹è¯•æ­¥éª¤                 | é¢„æœŸç»“æœ                       | å®é™…ç»“æœ |
| -------- | ------------ | ------------------------ | ------------------------------ | -------- |
| TC-301   | è®¢å•åˆ—è¡¨     | è¿›å…¥è®¢å•é¡µé¢             | æ˜¾ç¤ºæ‰€æœ‰å†å²è®¢å•               | âœ… é€šè¿‡  |
| TC-302   | è®¢å•çŠ¶æ€æ˜¾ç¤º | æŸ¥çœ‹ä¸åŒçŠ¶æ€è®¢å•         | æ­£ç¡®æ˜¾ç¤ºçŠ¶æ€æ ‡ç­¾å’Œé¢œè‰²         | âœ… é€šè¿‡  |
| TC-303   | é€€ç¥¨æ“ä½œ     | ç‚¹å‡»å·²æ”¯ä»˜è®¢å•çš„"é€€ç¥¨"   | ç¡®è®¤åè®¢å•å˜ä¸º"å·²é€€ç¥¨"         | âœ… é€šè¿‡  |
| TC-304   | æ”¹ç­¾æ“ä½œ     | ç‚¹å‡»"æ”¹ç­¾"ï¼Œé€‰æ‹©æ–°æ—¥æœŸ   | åŸè®¢å•å˜ä¸º"å·²æ”¹ç­¾"ï¼Œåˆ›å»ºæ–°è®¢å• | âœ… é€šè¿‡  |
| TC-305   | å–æ¶ˆå€™è¡¥     | ç‚¹å‡»å€™è¡¥è®¢å•çš„"å–æ¶ˆå€™è¡¥" | è®¢å•å˜ä¸º"å·²å–æ¶ˆ"               | âœ… é€šè¿‡  |

#### 7.2.5 ä¸ªäººä¸­å¿ƒæ¨¡å—æµ‹è¯•

| ç”¨ä¾‹ç¼–å· | æµ‹è¯•é¡¹   | æµ‹è¯•æ­¥éª¤           | é¢„æœŸç»“æœ                 | å®é™…ç»“æœ |
| -------- | -------- | ------------------ | ------------------------ | -------- |
| TC-401   | ä¿¡æ¯å±•ç¤º | è¿›å…¥ä¸ªäººä¸­å¿ƒ       | æ­£ç¡®æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯         | âœ… é€šè¿‡  |
| TC-402   | å¤´åƒä¸Šä¼  | é€‰æ‹©å›¾ç‰‡ä¸Šä¼        | å¤´åƒæ›´æ–°æˆåŠŸ             | âœ… é€šè¿‡  |
| TC-403   | æ·»åŠ ä¹˜å®¢ | å¡«å†™ä¹˜å®¢ä¿¡æ¯ï¼Œä¿å­˜ | ä¹˜å®¢æ·»åŠ æˆåŠŸ             | âœ… é€šè¿‡  |
| TC-404   | åˆ é™¤ä¹˜å®¢ | ç‚¹å‡»åˆ é™¤æŒ‰é’®       | ä¹˜å®¢åˆ é™¤æˆåŠŸ             | âœ… é€šè¿‡  |
| TC-405   | ç»‘å®šæ”¯ä»˜ | è¾“å…¥è´¦å·ç»‘å®š       | ç»‘å®šæˆåŠŸï¼Œæ˜¾ç¤ºå·²ç»‘å®š     | âœ… é€šè¿‡  |
| TC-406   | è§£ç»‘æ”¯ä»˜ | ç‚¹å‡»è§£ç»‘æŒ‰é’®       | è§£ç»‘æˆåŠŸ                 | âœ… é€šè¿‡  |
| TC-407   | é€€å‡ºç™»å½• | ç‚¹å‡»é€€å‡ºç™»å½•       | æ¸…é™¤ç™»å½•çŠ¶æ€ï¼Œè·³è½¬ç™»å½•é¡µ | âœ… é€šè¿‡  |

### 7.3 æ¥å£æµ‹è¯•

#### 7.3.1 ä½¿ç”¨ curl æµ‹è¯•æ¥å£

```bash
# æµ‹è¯•æ³¨å†Œæ¥å£
curl -X POST http://localhost:3000/api/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"123456"}'

# é¢„æœŸå“åº”
# {"code":0,"msg":"æ³¨å†ŒæˆåŠŸ","data":{"userId":1,"username":"testuser"}}

# æµ‹è¯•ç™»å½•æ¥å£
curl -X POST http://localhost:3000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"123456"}'

# é¢„æœŸå“åº”
# {"code":0,"msg":"ç™»å½•æˆåŠŸ","data":{...}}

# æµ‹è¯•è·å–è®¢å•æ¥å£
curl "http://localhost:3000/api/orders?userId=1"

# é¢„æœŸå“åº”
# {"code":0,"data":[...]}

# æµ‹è¯•åˆ›å»ºè®¢å•æ¥å£
curl -X POST http://localhost:3000/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 1,
    "start_city": "æ·±åœ³",
    "end_city": "ä¸Šæµ·",
    "train_no": "G1234",
    "price": 760,
    "seat_type": "äºŒç­‰åº§",
    "status": "paid"
  }'
```

### 7.4 å…¼å®¹æ€§æµ‹è¯•

| æµè§ˆå™¨  | ç‰ˆæœ¬ | ç»“æœ    | å¤‡æ³¨             |
| ------- | ---- | ------- | ---------------- |
| Chrome  | 120+ | âœ… é€šè¿‡ | æ¨èæµè§ˆå™¨       |
| Firefox | 120+ | âœ… é€šè¿‡ | å®Œå…¨å…¼å®¹         |
| Safari  | 17+  | âœ… é€šè¿‡ | macOS é»˜è®¤æµè§ˆå™¨ |
| Edge    | 120+ | âœ… é€šè¿‡ | åŸºäº Chromium    |

### 7.5 æµ‹è¯•æ€»ç»“

| æµ‹è¯•ç±»å‹       | ç”¨ä¾‹æ•°       | é€šè¿‡æ•°       | é€šè¿‡ç‡         |
| -------------- | ------------ | ------------ | -------------- |
| åŠŸèƒ½æµ‹è¯•       | 28           | 28           | 100%           |
| æ¥å£æµ‹è¯•       | 12           | 12           | 100%           |
| å…¼å®¹æ€§æµ‹è¯•     | 4            | 4            | 100%           |
| **æ€»è®¡** | **44** | **44** | **100%** |

æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å‡é€šè¿‡ï¼Œç³»ç»ŸåŠŸèƒ½æ­£å¸¸ã€‚

---


## 8. ç³»ç»Ÿéƒ¨ç½²

### 8.1 éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·æµè§ˆå™¨                               â”‚
â”‚                 http://localhost:3000                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Node.js æœåŠ¡å™¨                            â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Express.js (ç«¯å£ 3000)                              â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ é™æ€æ–‡ä»¶æœåŠ¡ (frontend/)                        â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ 12306.html                                 â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ login.html                                 â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€â”€ train-data.js                              â”‚   â”‚
â”‚  â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â””â”€â”€ RESTful API                                    â”‚   â”‚
â”‚  â”‚      â”œâ”€â”€ /api/register                              â”‚   â”‚
â”‚  â”‚      â”œâ”€â”€ /api/login                                 â”‚   â”‚
â”‚  â”‚      â”œâ”€â”€ /api/verify                                â”‚   â”‚
â”‚  â”‚      â”œâ”€â”€ /api/orders                                â”‚   â”‚
â”‚  â”‚      â””â”€â”€ /api/frequent_passengers                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                 â”‚
â”‚                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MySQL æ•°æ®åº“ (test_db)                              â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ user (ç”¨æˆ·è¡¨)                                   â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ orders (è®¢å•è¡¨)                                â”‚   â”‚
â”‚  â”‚  â””â”€â”€ frequent_passengers (å¸¸ç”¨ä¹˜è½¦äººè¡¨)              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 éƒ¨ç½²æ­¥éª¤

#### 8.2.1 ç¯å¢ƒå‡†å¤‡

```bash
# 1. å®‰è£… Node.js (æ¨èä½¿ç”¨ nvm)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 18
nvm use 18

# 2. å®‰è£… MySQL
# macOS:
brew install mysql
brew services start mysql

# Ubuntu:
sudo apt update
sudo apt install mysql-server
sudo systemctl start mysql

# 3. é…ç½® MySQL
mysql -u root -p
# æ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ– SQLï¼ˆè§ 6.1.3 èŠ‚ï¼‰
```

#### 8.2.2 é¡¹ç›®éƒ¨ç½²

```bash
# 1. å…‹éš†/å¤åˆ¶é¡¹ç›®åˆ°æœåŠ¡å™¨
cd /path/to/deployment
cp -r mysql-demo /var/www/mysql-demo

# 2. å®‰è£…åç«¯ä¾èµ–
cd /var/www/mysql-demo/backend
npm install

# 3. é…ç½®æ•°æ®åº“è¿æ¥ï¼ˆä¿®æ”¹ app.js ä¸­çš„æ•°æ®åº“é…ç½®ï¼‰
vi app.js
# ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š
# host: 'your-mysql-host',
# user: 'your-username',
# password: 'your-password',
# database: 'test_db'

# 4. å¯åŠ¨æœåŠ¡
node app.js

# æˆ–ä½¿ç”¨ PM2 è¿›è¡Œè¿›ç¨‹ç®¡ç†
npm install -g pm2
pm2 start app.js --name "12306-demo"
pm2 save
pm2 startup
```

#### 8.2.3 ä½¿ç”¨ PM2 ç®¡ç†è¿›ç¨‹

```bash
# å®‰è£… PM2
npm install -g pm2

# å¯åŠ¨åº”ç”¨
pm2 start app.js --name "12306-demo"

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs 12306-demo

# é‡å¯åº”ç”¨
pm2 restart 12306-demo

# åœæ­¢åº”ç”¨
pm2 stop 12306-demo

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

### 8.3 é…ç½®è¯´æ˜

#### 8.3.1 æ•°æ®åº“é…ç½®

```javascript
// backend/app.js ä¸­çš„æ•°æ®åº“é…ç½®
const db = mysql.createConnection({
  host: 'localhost',      // æ•°æ®åº“ä¸»æœºåœ°å€
  user: 'root',           // æ•°æ®åº“ç”¨æˆ·å
  password: 'password',   // æ•°æ®åº“å¯†ç 
  database: 'test_db',    // æ•°æ®åº“åç§°
  charset: 'utf8mb4'      // å­—ç¬¦é›†
});
```

#### 8.3.2 æœåŠ¡ç«¯å£é…ç½®

```javascript
// æœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ 3000ï¼‰
const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
  console.log(`æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:${PORT}`);
});
```

---

## 9. é¡¹ç›®æ€»ç»“

### 9.1 å·²å®ç°åŠŸèƒ½

| æ¨¡å—     | åŠŸèƒ½ç‚¹                             | å®ŒæˆçŠ¶æ€  |
| -------- | ---------------------------------- | --------- |
| ç”¨æˆ·è®¤è¯ | æ³¨å†Œã€ç™»å½•ã€å®åè®¤è¯               | âœ… å·²å®Œæˆ |
| è½¦ç¥¨æŸ¥è¯¢ | åŸå¸‚ç­›é€‰ã€æ—¥æœŸç­›é€‰ã€å½“å¤©å·²å‘è½¦è¿‡æ»¤ | âœ… å·²å®Œæˆ |
| è½¦ç¥¨é¢„è®¢ | å¸­åˆ«é€‰æ‹©ã€ä¹˜å®¢é€‰æ‹©ã€å€™è¡¥è´­ç¥¨       | âœ… å·²å®Œæˆ |
| æ”¯ä»˜æ¨¡æ‹Ÿ | å¾®ä¿¡ã€æ”¯ä»˜å®ã€Apple Payã€é“¶è”      | âœ… å·²å®Œæˆ |
| è®¢å•ç®¡ç† | è®¢å•åˆ—è¡¨ã€é€€ç¥¨ã€æ”¹ç­¾               | âœ… å·²å®Œæˆ |
| å¸¸ç”¨ä¹˜å®¢ | æ·»åŠ ã€åˆ é™¤ã€è´­ç¥¨æ—¶é€‰æ‹©             | âœ… å·²å®Œæˆ |
| æ”¯ä»˜ç»‘å®š | ç»‘å®šã€è§£ç»‘å¤šç§æ”¯ä»˜æ–¹å¼             | âœ… å·²å®Œæˆ |
| ä¸ªäººä¸­å¿ƒ | ä¿¡æ¯å±•ç¤ºã€å¤´åƒä¸Šä¼ ã€é€€å‡ºç™»å½•       | âœ… å·²å®Œæˆ |
| ä½¿ç”¨æŒ‡å— | åŠŸèƒ½è¯´æ˜é¡µé¢                       | âœ… å·²å®Œæˆ |

### 9.2 æŠ€æœ¯äº®ç‚¹

1. **å•é¡µåº”ç”¨æ¶æ„**ï¼šä½¿ç”¨åŸç”Ÿ JavaScript å®ç° SPAï¼Œæ— éœ€é¢å¤–æ¡†æ¶
2. **RESTful API è®¾è®¡**ï¼šåç«¯æ¥å£éµå¾ª RESTful è§„èŒƒï¼Œæ¸…æ™°æ˜“ç»´æŠ¤
3. **å‚æ•°åŒ–æŸ¥è¯¢**ï¼šé˜²æ­¢ SQL æ³¨å…¥æ”»å‡»
4. **å“åº”å¼å¸ƒå±€**ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸
5. **æ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹**ï¼šå®Œæ•´çš„å¤šç§æ”¯ä»˜æ–¹å¼æ¨¡æ‹Ÿ
6. **è®¢å•å·å”¯ä¸€æ€§ç®—æ³•**ï¼šé€’å½’é‡è¯•ç¡®ä¿å”¯ä¸€æ€§
7. **å‰ç«¯é˜²æŠ–æ§åˆ¶**ï¼šé˜²æ­¢é‡å¤æŸ¥è¯¢è¯·æ±‚

### 9.3 å¾…ä¼˜åŒ–é¡¹

| ä¼˜åŒ–é¡¹       | è¯´æ˜                         | ä¼˜å…ˆçº§ |
| ------------ | ---------------------------- | ------ |
| å¯†ç åŠ å¯†     | ä½¿ç”¨ bcrypt åŠ å¯†å­˜å‚¨å¯†ç      | é«˜     |
| JWT è®¤è¯     | ä½¿ç”¨ Token æ›¿ä»£ localStorage | é«˜     |
| è¾“å…¥éªŒè¯     | å¢å¼ºåç«¯æ•°æ®éªŒè¯             | ä¸­     |
| é”™è¯¯å¤„ç†     | ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶             | ä¸­     |
| æ—¥å¿—ç³»ç»Ÿ     | æ·»åŠ æ—¥å¿—è®°å½•å’Œç›‘æ§           | ä¸­     |
| å•å…ƒæµ‹è¯•     | æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹           | ä¸­     |
| å‰ç«¯æ¡†æ¶     | è€ƒè™‘ä½¿ç”¨ Vue/React é‡æ„      | ä½     |
| æ•°æ®åº“è¿æ¥æ±  | ä½¿ç”¨è¿æ¥æ± ä¼˜åŒ–æ€§èƒ½           | ä½     |

### 9.4 å­¦ä¹ æ”¶è·

é€šè¿‡æœ¬é¡¹ç›®çš„å¼€å‘ï¼ŒæŒæ¡äº†ä»¥ä¸‹æŠ€æœ¯ï¼š

1. **Node.js + Express åç«¯å¼€å‘**

   - RESTful API è®¾è®¡ä¸å®ç°
   - ä¸­é—´ä»¶çš„ä½¿ç”¨ï¼ˆcorsã€body-parserï¼‰
   - æ•°æ®åº“æ“ä½œï¼ˆmysql2ï¼‰
2. **å‰ç«¯å¼€å‘**

   - åŸç”Ÿ JavaScript DOM æ“ä½œ
   - äº‹ä»¶å§”æ‰˜ä¸äº‹ä»¶å¤„ç†
   - localStorage æœ¬åœ°å­˜å‚¨
   - å¼‚æ­¥è¯·æ±‚ï¼ˆFetch APIï¼‰
3. **æ•°æ®åº“è®¾è®¡**

   - E-R å›¾è®¾è®¡
   - è¡¨ç»“æ„è®¾è®¡ä¸ç´¢å¼•ä¼˜åŒ–
   - SQL è¯­å¥ç¼–å†™
4. **å·¥ç¨‹åŒ–å®è·µ**

   - ç›®å½•ç»“æ„ç»„ç»‡
   - ä»£ç æ¨¡å—åŒ–
   - æ–‡æ¡£ç¼–å†™

---

## é™„å½• Aï¼šå®Œæ•´ä»£ç æ¸…å•

### A.1 åç«¯ä»£ç ï¼ˆbackend/app.jsï¼‰

å®Œæ•´ä»£ç å…± 606 è¡Œï¼Œä¸»è¦åŒ…å«ï¼š

- ç¬¬ 1-20 è¡Œï¼šä¾èµ–å¼•å…¥å’Œé…ç½®
- ç¬¬ 21-45 è¡Œï¼šæ•°æ®åº“è¿æ¥
- ç¬¬ 46-120 è¡Œï¼šç”¨æˆ·è®¤è¯æ¥å£
- ç¬¬ 121-200 è¡Œï¼šå®åè®¤è¯æ¥å£
- ç¬¬ 201-350 è¡Œï¼šè®¢å•ç®¡ç†æ¥å£
- ç¬¬ 351-450 è¡Œï¼šå¸¸ç”¨ä¹˜å®¢æ¥å£
- ç¬¬ 451-550 è¡Œï¼šè®¢å•å·ç”Ÿæˆç®—æ³•
- ç¬¬ 551-606 è¡Œï¼šæ”¹ç­¾åŠŸèƒ½æ¥å£

### A.2 å‰ç«¯ä»£ç ï¼ˆfrontend/12306.htmlï¼‰

å®Œæ•´ä»£ç å…± 2778 è¡Œï¼Œä¸»è¦åŒ…å«ï¼š

- ç¬¬ 1-500 è¡Œï¼šHTML ç»“æ„å’Œ CSS æ ·å¼
- ç¬¬ 501-1000 è¡Œï¼šé¡µé¢å¸ƒå±€å’Œç»„ä»¶
- ç¬¬ 1001-1500 è¡Œï¼šå¼¹çª—å’Œæ¨¡æ€æ¡†
- ç¬¬ 1501-2000 è¡Œï¼šJavaScript æ ¸å¿ƒé€»è¾‘
- ç¬¬ 2001-2778 è¡Œï¼šäº‹ä»¶å¤„ç†å’Œäº¤äº’é€»è¾‘

### A.3 è½¦æ¬¡æ•°æ®ï¼ˆfrontend/train-data.jsï¼‰

å®Œæ•´ä»£ç çº¦ 200 è¡Œï¼ŒåŒ…å«ï¼š

- 150+ æ¡è½¦æ¬¡æ•°æ®
- æ¶µç›–å¤šä¸ªåŸå¸‚å’Œçº¿è·¯
- åŒ…å«ä»·æ ¼å’Œä½™ç¥¨ä¿¡æ¯

---

## é™„å½• Bï¼šAPI æ¥å£æ–‡æ¡£

### B.1 ç”¨æˆ·ç›¸å…³æ¥å£

| æ¥å£     | æ–¹æ³• | è·¯å¾„          | è¯´æ˜             |
| -------- | ---- | ------------- | ---------------- |
| æ³¨å†Œ     | POST | /api/register | ç”¨æˆ·æ³¨å†Œ         |
| ç™»å½•     | POST | /api/login    | ç”¨æˆ·ç™»å½•         |
| å®åè®¤è¯ | POST | /api/verify   | æäº¤å®åè®¤è¯ä¿¡æ¯ |

### B.2 è®¢å•ç›¸å…³æ¥å£

| æ¥å£         | æ–¹æ³•  | è·¯å¾„                        | è¯´æ˜         |
| ------------ | ----- | --------------------------- | ------------ |
| è·å–è®¢å•åˆ—è¡¨ | GET   | /api/orders                 | æŸ¥è¯¢ç”¨æˆ·è®¢å• |
| åˆ›å»ºè®¢å•     | POST  | /api/orders                 | åˆ›å»ºæ–°è®¢å•   |
| å–æ¶ˆ/é€€ç¥¨    | PATCH | /api/orders/:orderNo/cancel | å–æ¶ˆæˆ–é€€ç¥¨   |
| æ”¹ç­¾         | PATCH | /api/orders/reschedule      | è®¢å•æ”¹ç­¾     |

### B.3 ä¹˜å®¢ç›¸å…³æ¥å£

| æ¥å£         | æ–¹æ³•   | è·¯å¾„                         | è¯´æ˜         |
| ------------ | ------ | ---------------------------- | ------------ |
| è·å–ä¹˜å®¢åˆ—è¡¨ | GET    | /api/frequent_passengers     | æŸ¥è¯¢å¸¸ç”¨ä¹˜å®¢ |
| æ·»åŠ ä¹˜å®¢     | POST   | /api/frequent_passengers     | æ·»åŠ å¸¸ç”¨ä¹˜å®¢ |
| åˆ é™¤ä¹˜å®¢     | DELETE | /api/frequent_passengers/:id | åˆ é™¤å¸¸ç”¨ä¹˜å®¢ |

---

## é™„å½• Cï¼šæ•°æ®åº“è„šæœ¬

```sql
-- å®Œæ•´çš„æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS test_db 
  DEFAULT CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;

USE test_db;

-- åˆ é™¤å·²å­˜åœ¨çš„è¡¨ï¼ˆå¦‚éœ€é‡æ–°åˆ›å»ºï¼‰
-- DROP TABLE IF EXISTS frequent_passengers;
-- DROP TABLE IF EXISTS orders;
-- DROP TABLE IF EXISTS user;

-- ç”¨æˆ·è¡¨
CREATE TABLE IF NOT EXISTS `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL,
  `password` varchar(255) NOT NULL,
  `name` varchar(50) DEFAULT NULL,
  `phone` varchar(20) DEFAULT NULL,
  `id_card` varchar(18) DEFAULT NULL,
  `is_verified` tinyint(1) DEFAULT 0,
  `avatar` text DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- è®¢å•è¡¨
CREATE TABLE IF NOT EXISTS `orders` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(32) NOT NULL,
  `user_id` int(11) NOT NULL,
  `start_city` varchar(50) NOT NULL,
  `end_city` varchar(50) NOT NULL,
  `train_no` varchar(20) DEFAULT NULL,
  `price` decimal(10,2) NOT NULL,
  `depart_time` datetime DEFAULT NULL,
  `seat_type` varchar(20) DEFAULT 'äºŒç­‰åº§',
  `status` enum('pending','paid','waitlist','cancelled','refunded','rescheduled') DEFAULT 'pending',
  `payment_method` varchar(20) DEFAULT NULL,
  `passenger_name` varchar(50) DEFAULT NULL,
  `passenger_id_card` varchar(20) DEFAULT NULL,
  `passenger_phone` varchar(20) DEFAULT NULL,
  `rescheduled_from` varchar(32) DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- å¸¸ç”¨ä¹˜è½¦äººè¡¨
CREATE TABLE IF NOT EXISTS `frequent_passengers` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `passenger_name` varchar(50) NOT NULL,
  `passenger_id_card` varchar(18) NOT NULL,
  `passenger_phone` varchar(11) DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_passenger` (`user_id`, `passenger_id_card`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO `user` (`username`, `password`, `name`, `phone`, `id_card`, `is_verified`) 
VALUES ('demo', '123456', 'æ¼”ç¤ºç”¨æˆ·', '13800138000', '440300199001011234', 1);
```

---

## é™„å½• Dï¼šå‚è€ƒèµ„æ–™

1. **Node.js å®˜æ–¹æ–‡æ¡£**ï¼šhttps://nodejs.org/docs/
2. **Express.js å®˜æ–¹æ–‡æ¡£**ï¼šhttps://expressjs.com/
3. **MySQL å®˜æ–¹æ–‡æ¡£**ï¼šhttps://dev.mysql.com/doc/
4. **MDN Web Docs**ï¼šhttps://developer.mozilla.org/
5. **12306 å®˜æ–¹ç½‘ç«™**ï¼šhttps://www.12306.cn/

---

**ç¼–å†™æ—¥æœŸ**ï¼š2025å¹´12æœˆ
**é¡¹ç›®åç§°**ï¼š12306 ç«è½¦ç¥¨é¢„è®¢ç³»ç»Ÿ
